<!DOCTYPE html>
<html class="has-navbar-fixed-top">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>简单梳理Node.js创建子进程的方法（下）—— cluster - Miser 胡言</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">
<meta name="baidu-site-verification" content="CXKjj3fklD">

<meta name="description" content="在默认的RoundRobinHandle模式下，从上可以看出，cluster子进程之所以可以共同监听同个TCP端口，是在net模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在RoundRobinHandle中创建中创建server，一旦有新的TCP连接进入，会转发给free里的worker（cluster.child）处理">
 
<meta name="keywords" content="child_process,cluster,fork,Node.js,共同监听TCP端口">
   

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

      
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129526171-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-129526171-1');
</script>

  

    <style type="text/css">
      body {
        font-family: Consolas, Mononoki, "Roboto Sans", "Liberation Mono",
          monospace;
        color: #586e75;
        line-height: 1.6;
        background-color: #fdf6e3;
      }
      .gallery-item .caption {
        text-align: center;
      }
      ul.adv {
        margin-bottom: 60px;
      }
      ul .img {
        text-align: center;
      }
    </style>
  </head>
  <body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    胡言
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/archives">Archives</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
            <a class="navbar-item" title="Twitter" href="https://twitter.com/ud_miser">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" title="GitHub" href="https://github.com/miser">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>
 <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            简单梳理Node.js创建子进程的方法（下）—— cluster
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-05-03T07:24:53.000Z" itemprop="datePublished">May 3 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>前文简单梳理了Node.js使用<strong>child_process</strong>模块创建子进程的4种方法，<code>exec</code>、<code>execFile</code>、<code>fork</code>和<code>spawn</code>。接下来我们看看<strong>cluster</strong>模块如何创建子进程，后续更多内容会介绍cluster.fork启动Net Server时候为何不会因为共同监听同一个端口而不报错。</p>
<p><strong>cluster</strong></p>
<ul>
<li><a href="http://nodejs.cn/api/cluster.html#cluster_cluster_fork_env" target="_blank" rel="noopener">fork</a>: 衍生出一个新的工作进程，这只能通过主进程调用。</li>
</ul>
<a id="more"></a>
<p><br></p>
<p><strong>翻翻源码看看他们怎么实现的</strong></p>
<figure class="highlight markdown hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// libuv</span><br><span class="line"><span class="hljs-section">#define UV_VERSION_MAJOR 1</span></span><br><span class="line"><span class="hljs-section">#define UV_VERSION_MINOR 33</span></span><br><span class="line"><span class="hljs-section">#define UV_VERSION_PATCH 1</span></span><br><span class="line"></span><br><span class="line">// V8</span><br><span class="line"><span class="hljs-section">#define V8_MAJOR_VERSION 7</span></span><br><span class="line"><span class="hljs-section">#define V8_MINOR_VERSION 8</span></span><br><span class="line"><span class="hljs-section">#define V8_BUILD_NUMBER 279</span></span><br><span class="line"><span class="hljs-section">#define V8_PATCH_LEVEL 17</span></span><br><span class="line"></span><br><span class="line">// Node.js</span><br><span class="line"><span class="hljs-section">#define NODE_MAJOR_VERSION 14</span></span><br><span class="line"><span class="hljs-section">#define NODE_MINOR_VERSION 0</span></span><br><span class="line"><span class="hljs-section">#define NODE_PATCH_VERSION 0</span></span><br></pre></td></tr></table></figure>
<p><strong>cluster</strong>源码位置</p>
<figure class="highlight markdown hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lib</span><br><span class="line">  - internal</span><br><span class="line"><span class="hljs-code">    - cluster</span></span><br><span class="line"><span class="hljs-code">    - child.js</span></span><br><span class="line"><span class="hljs-code">      - master.js</span></span><br><span class="line"><span class="hljs-code">      - round_robin_handle.js</span></span><br><span class="line"><span class="hljs-code">      - shared_handle.js</span></span><br><span class="line"><span class="hljs-code">      - utils.js</span></span><br><span class="line"><span class="hljs-code">      - worker.js</span></span><br><span class="line">  - cluster.js</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>官方示例</strong></p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> numCPUs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).cpus().length;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (cluster.isMaster) &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`主进程 <span class="hljs-subst">$&#123;process.pid&#125;</span> 正在运行`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 衍生工作进程。</span></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">    cluster.fork();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cluster.on(<span class="hljs-string">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`工作进程 <span class="hljs-subst">$&#123;worker.process.pid&#125;</span> 已退出`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// 工作进程可以共享任何 TCP 连接。</span></span><br><span class="line">  <span class="hljs-comment">// 在本例子中，共享的是 HTTP 服务器。</span></span><br><span class="line">  http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.writeHead(<span class="hljs-number">200</span>);</span><br><span class="line">    res.end(<span class="hljs-string">'你好世界\n'</span>);</span><br><span class="line">  &#125;).listen(<span class="hljs-number">8000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`工作进程 <span class="hljs-subst">$&#123;process.pid&#125;</span> 已启动`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Q-cluster-isMaster模块如何区分是主进程还是子进程的？"><a href="#Q-cluster-isMaster模块如何区分是主进程还是子进程的？" class="headerlink" title="Q:cluster.isMaster模块如何区分是主进程还是子进程的？"></a>Q:cluster.isMaster模块如何区分是主进程还是子进程的？</h3><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/cluster.js</span></span><br><span class="line"><span class="hljs-keyword">const</span> childOrMaster = <span class="hljs-string">'NODE_UNIQUE_ID'</span> <span class="hljs-keyword">in</span> process.env ? <span class="hljs-string">'child'</span> : <span class="hljs-string">'master'</span>;</span><br><span class="line"><span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">require</span>(<span class="hljs-string">`internal/cluster/<span class="hljs-subst">$&#123;childOrMaster&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p><code>lib/cluster.js</code>是整个cluster的入口，根据环境变量中是否有<code>NODE_UNIQUE_ID</code>来区分主或子进程。</p>
<p>主进程通过<code>cluster.fork</code>创建子进程的时候，会将<code>NODE_UNIQUE_ID</code>传入子进程的环境变量中，最后通过<strong>child_process.fork</strong>去创建新的子进程。</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/master.js</span></span><br><span class="line"><span class="hljs-comment">// ...</span></span><br><span class="line">cluster.isMaster = <span class="hljs-literal">true</span>;</span><br><span class="line"><span class="hljs-comment">// ...</span></span><br><span class="line"><span class="hljs-comment">// fork的代码下文还会提到</span></span><br><span class="line"><span class="hljs-keyword">const</span> workerEnv = &#123; ...process.env, ...env, <span class="hljs-attr">NODE_UNIQUE_ID</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class="line"><span class="hljs-keyword">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">  env: workerEnv,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// lib/internal/cluster/child.js</span></span><br><span class="line"><span class="hljs-comment">// ...</span></span><br><span class="line">cluster.isMaster = <span class="hljs-literal">false</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Q-cluster-fork创建子进程过程中做了些什么？"><a href="#Q-cluster-fork创建子进程过程中做了些什么？" class="headerlink" title="Q:cluster.fork创建子进程过程中做了些什么？"></a>Q:cluster.fork创建子进程过程中做了些什么？</h3><p><code>cluster.setupMaster</code>是对整个环境参数的配置；</p>
<p>通过<code>createWorkerProcess</code>里的<code>child_process.fork</code>去创建子进程；</p>
<p>之后将其和一个<code>Worker</code>对象做关联，worker、其子进程和当前cluster(master)都会收到几乎相同的<code>message</code>、<code>exit</code>和<code>disconnect</code>事件，<strong>Worker</strong>这边不多扩展，可以查阅<code>lib/internal/cluster/worker.js</code>；</p>
<p>子进程会监听<code>internalMessage</code>事件，什么是internalMessage事件呢？看看下面官方的介绍。</p>
<blockquote>
<p>当发送 <strong>{cmd: ‘NODE_foo’}</strong> 消息时有一种特殊情况。 <strong>cmd</strong> 属性中包含 <strong>NODE_</strong> 前缀的消息是预留给 Node.js 内核内部使用的，将不会触发子进程的 <strong>‘message’</strong>事件。 相反，这种消息可使用 <strong>‘internalMessage’</strong> 事件触发，且会被 Node.js 内部消费。 应用程序应避免使用此类消息或监听<strong>‘internalMessage’</strong> 事件，因为它可能会被更改且不会通知。</p>
</blockquote>
<p>此处<code>internalMessage</code>事件的回调方法是<code>internal(worker, onmessage)</code>，<strong>internal</strong>是<code>lib/internal/cluster/master.js</code>里的方法，主要作用是判断监听的消息里面是否存在需要执行的回调，如果没有就会执行入参回调，这里指的是<strong>onmessage</strong>；</p>
<p><strong>onmessage</strong>里面有很多if-else语句，主要是根据cluster.child传送进来的消息类型(<code>act</code>)做出不同的处理，这里列出了一个<code>queryServer</code>（因为后面会介绍Net Server里多个子进程如何监听同一个端口的）。</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/master.js</span></span><br><span class="line">cluster.fork = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">env</span>) </span>&#123;</span><br><span class="line">  cluster.setupMaster();</span><br><span class="line">  <span class="hljs-keyword">const</span> id = ++ids;</span><br><span class="line">  <span class="hljs-comment">// 创建子进程</span></span><br><span class="line">  <span class="hljs-keyword">const</span> workerProcess = createWorkerProcess(id, env);</span><br><span class="line">  <span class="hljs-comment">//</span></span><br><span class="line">  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(&#123;</span><br><span class="line">    id: id,</span><br><span class="line">    process: workerProcess, <span class="hljs-comment">// 新建的子进程</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  worker.on(<span class="hljs-string">"message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, handle</span>) </span>&#123;</span><br><span class="line">    cluster.emit(<span class="hljs-string">"message"</span>, <span class="hljs-keyword">this</span>, message, handle);</span><br><span class="line">  &#125;);</span><br><span class="line">  worker.process.once(<span class="hljs-string">"exit"</span>, (exitCode, signalCode) =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    worker.state = <span class="hljs-string">"dead"</span>;</span><br><span class="line">    worker.emit(<span class="hljs-string">"exit"</span>, exitCode, signalCode);</span><br><span class="line">    cluster.emit(<span class="hljs-string">"exit"</span>, worker, exitCode, signalCode);</span><br><span class="line">  &#125;);</span><br><span class="line">  worker.process.once(<span class="hljs-string">"disconnect"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    worker.state = <span class="hljs-string">"disconnected"</span>;</span><br><span class="line">    worker.emit(<span class="hljs-string">"disconnect"</span>);</span><br><span class="line">    cluster.emit(<span class="hljs-string">"disconnect"</span>, worker);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  worker.process.on(<span class="hljs-string">"internalMessage"</span>, internal(worker, onmessage));</span><br><span class="line">  <span class="hljs-comment">// 触发 fork 事件</span></span><br><span class="line">  process.nextTick(emitForkNT, worker);</span><br><span class="line">  cluster.workers[worker.id] = worker; </span><br><span class="line">  <span class="hljs-keyword">return</span> worker;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createWorkerProcess</span>(<span class="hljs-params">id, env</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> workerEnv = &#123; ...process.env, ...env, <span class="hljs-attr">NODE_UNIQUE_ID</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>`</span> &#125;;</span><br><span class="line">  <span class="hljs-comment">// ... 对一些参数的组合和设定</span></span><br><span class="line">  <span class="hljs-comment">// 调用child_process的fork方法创建子进程</span></span><br><span class="line">  <span class="hljs-keyword">return</span> fork(cluster.settings.exec, cluster.settings.args, &#123;</span><br><span class="line">    cwd: cluster.settings.cwd,</span><br><span class="line">    env: workerEnv,</span><br><span class="line">    silent: cluster.settings.silent,</span><br><span class="line">    windowsHide: cluster.settings.windowsHide,</span><br><span class="line">    execArgv: execArgv,</span><br><span class="line">    stdio: cluster.settings.stdio,</span><br><span class="line">    gid: cluster.settings.gid,</span><br><span class="line">    uid: cluster.settings.uid,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onmessage</span>(<span class="hljs-params">message, handle</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">this</span>;</span><br><span class="line">  <span class="hljs-comment">// ... if message.act 类型很多 这里主要讲 queryServer</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (message.act === <span class="hljs-string">"queryServer"</span>) queryServer(worker, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/utils.js</span></span><br><span class="line"><span class="hljs-comment">// 在cluster的chilid和master里的send都会调用sendHelper</span></span><br><span class="line"><span class="hljs-keyword">let</span> seq = <span class="hljs-number">0</span>;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendHelper</span>(<span class="hljs-params">proc, message, handle, cb</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!proc.connected) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">  <span class="hljs-comment">// NODE_* 开头的命令触发 internalMessage </span></span><br><span class="line">  message = &#123; <span class="hljs-attr">cmd</span>: <span class="hljs-string">"NODE_CLUSTER"</span>, ...message, seq &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">"function"</span>) callbacks.set(seq, cb); <span class="hljs-comment">// 缓存回调</span></span><br><span class="line"></span><br><span class="line">  seq += <span class="hljs-number">1</span>;</span><br><span class="line">  <span class="hljs-comment">// cluster/child.js handle =&gt; null</span></span><br><span class="line">  <span class="hljs-comment">// cluster/master.js handle =&gt; null</span></span><br><span class="line">  <span class="hljs-keyword">return</span> proc.send(message, handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是cluster.fork的大致过程，引入一个Worker和internalMessage概念，之后会用得到。cluster的child和master之间传输信息，都是通过<code>sendHelper</code>方法。</p>
<h3 id="Q-cluster-fork创建的子进程如何共同监听TCP端口？"><a href="#Q-cluster-fork创建的子进程如何共同监听TCP端口？" class="headerlink" title="Q:cluster.fork创建的子进程如何共同监听TCP端口？"></a>Q:cluster.fork创建的子进程如何共同监听TCP端口？</h3><p>解答这个问题，主要是看<code>net</code>模块如何创建Server的，还有就是cluster中<code>child</code>和<code>master</code>如何通信的。</p>
<p>官方示例虽然用的是<code>http</code>创建的服务，但它底层是继承的<code>net</code>模块，为了方便梳理，我们从<code>net.createServer</code>入手一步步查看源码，主要的逻辑从<code>listen</code>开始。</p>
<h4 id="Child部分"><a href="#Child部分" class="headerlink" title="Child部分:"></a>Child部分:</h4><p>cluster.child里创建一个TCP服务，参数<code>port</code>是8000，<code>host</code>没有传参；</p>
<p>调用<code>listenInCluster</code>方法，一看这名字就知道和<strong>cluster</strong>有关；</p>
<p><code>listen</code>是在子进程里触发的，它会通过<code>cluster._getServer</code>拼出一个<code>act</code>为serverQuery的消息发送给cluster.master；</p>
<h4 id="Master部分"><a href="#Master部分" class="headerlink" title="Master部分:"></a>Master部分:</h4><p>前文提到，<code>master.onmessage</code>方法会根据消息的act不同而做出不同的处理，此处正是<code>serverQuery</code>；</p>
<p>进入<code>queryServer</code>方法，默认使用<code>RoundRobinHandle</code>循环分配任务；</p>
<p>在<code>RoundRobinHandle</code>构造函数中，会调用<code>net.createServer</code>创建一个Server，由于是在cluster.master里调用的，所以会在<code>listenInCluster</code>里调用<code>server._listen2</code>，会new 出 <code>TCP</code>（src/tcp_wrap.cc）作为句柄，并将其赋给<code>server._handle</code>，至此cluster.master已经拥有了处理TCP请求的能力，不过master有该能力是不行的，还需要让child拥有才行；</p>
<p><code>RoundRobinHandle</code>中一旦server触发了<code>listening</code>事件后，它会接管<code>server._handle</code>，用<code>distribute</code>重置其<code>onconnection</code>方法；</p>
<p><code>distribute</code>的作用就是转发新的请求TCP给cluster.child，从<code>free</code>列队中取出一个之前<code>add</code>进来的worker（这个worker和cluster.child有关联关系），发送一个<code>act</code>为<strong>newconn</strong>的消息让其处理这个TCP；</p>
<h4 id="回到Child部分"><a href="#回到Child部分" class="headerlink" title="回到Child部分:"></a>回到Child部分:</h4><p>cluster.child的<code>onconnection</code>收到<code>act</code>为<strong>newconn</strong>的请求后，会找到之前的创建的server，然后调用其<code>onconnection</code>（child里的该方法没有被重置）方法，然后封装出一个<code>Socket</code>对象，触发<code>onnection</code>事件；</p>
<p>到此，后面的就是普通业务逻辑代码了。</p>
<p><em>下面贴上了部分相关代码，还是比较多的，细节部分我也加上了注释。</em></p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/net.js</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params">options, connectionListener</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Server(options, connectionListener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Server</span>(<span class="hljs-params">options, connectionListener</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// ... 大量内置属性和参数的初始化</span></span><br><span class="line">&#125;</span><br><span class="line">Server.prototype.listen = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">  <span class="hljs-comment">// 传了port参数（8000），没有host</span></span><br><span class="line">  <span class="hljs-keyword">var</span> backlog;</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options.port === <span class="hljs-string">"number"</span> || <span class="hljs-keyword">typeof</span> options.port === <span class="hljs-string">"string"</span>) &#123;</span><br><span class="line">    backlog = options.backlog || backlogFromArgs;</span><br><span class="line">    <span class="hljs-keyword">if</span> (options.host) &#123;</span><br><span class="line">      <span class="hljs-comment">// ...</span></span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// </span></span><br><span class="line">      listenInCluster(</span><br><span class="line">        <span class="hljs-keyword">this</span>,</span><br><span class="line">        <span class="hljs-literal">null</span>,</span><br><span class="line">        options.port | <span class="hljs-number">0</span>,</span><br><span class="line">        <span class="hljs-number">4</span>,</span><br><span class="line">        backlog,</span><br><span class="line">        <span class="hljs-literal">undefined</span>,</span><br><span class="line">        options.exclusive</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="hljs-comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listenInCluster</span>(<span class="hljs-params"></span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  server,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  address,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  port,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  addressType,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  backlog,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  fd,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  exclusive,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  flags</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  exclusive = !!exclusive;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (cluster === <span class="hljs-literal">undefined</span>) cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cluster"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (cluster.isMaster || exclusive) &#123;</span><br><span class="line">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> serverQuery = &#123;</span><br><span class="line">    address: address,</span><br><span class="line">    port: port, </span><br><span class="line">    addressType: addressType,</span><br><span class="line">    fd: fd,</span><br><span class="line">    flags,</span><br><span class="line">  &#125;;</span><br><span class="line">  cluster._getServer(server, serverQuery, listenOnMasterHandle);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listenOnMasterHandle</span>(<span class="hljs-params">err, handle</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    server._handle = handle;</span><br><span class="line">    server._listen2(address, port, addressType, backlog, fd, flags);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/child.js</span></span><br><span class="line">cluster._getServer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, options, cb</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> address = options.address;</span><br><span class="line">	<span class="hljs-comment">// ...</span></span><br><span class="line">  <span class="hljs-comment">// 当前创建的server信息是否之前已经在cluster.child里查询过</span></span><br><span class="line">  <span class="hljs-comment">// 有的话就累加计数index值</span></span><br><span class="line">  <span class="hljs-keyword">const</span> indexesKey = [</span><br><span class="line">    address, </span><br><span class="line">    options.port,</span><br><span class="line">    options.addressType,</span><br><span class="line">    options.fd,</span><br><span class="line">  ].join(<span class="hljs-string">":"</span>); </span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> index = indexes.get(indexesKey);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (index === <span class="hljs-literal">undefined</span>) index = <span class="hljs-number">0</span>;</span><br><span class="line">  <span class="hljs-keyword">else</span> index++;</span><br><span class="line"></span><br><span class="line">  indexes.set(indexesKey, index);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> message = &#123;</span><br><span class="line">    act: <span class="hljs-string">"queryServer"</span>,</span><br><span class="line">    index,</span><br><span class="line">    data: <span class="hljs-literal">null</span>,</span><br><span class="line">    ...options,</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  send(message, (reply, handle) =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (handle) shared(reply, handle, indexesKey, cb);</span><br><span class="line">    <span class="hljs-comment">// Shared listen socket.</span></span><br><span class="line">    <span class="hljs-keyword">else</span> rr(reply, indexesKey, cb); <span class="hljs-comment">// Round-robin 返回的 handle 是null</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rr</span>(<span class="hljs-params">message, indexesKey, cb</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (message.errno) <span class="hljs-keyword">return</span> cb(message.errno, <span class="hljs-literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> key = message.key;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listen</span>(<span class="hljs-params">backlog</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;</span><br><span class="line">    send(&#123; <span class="hljs-attr">act</span>: <span class="hljs-string">"close"</span>, key &#125;);</span><br><span class="line">    handles.delete(key);</span><br><span class="line">    indexes.delete(indexesKey);</span><br><span class="line">    key = <span class="hljs-literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getsockname</span>(<span class="hljs-params">out</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (key) <span class="hljs-built_in">Object</span>.assign(out, message.sockname);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> handle = &#123; close, listen, <span class="hljs-attr">ref</span>: noop, <span class="hljs-attr">unref</span>: noop &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (message.sockname) &#123;</span><br><span class="line">    handle.getsockname = getsockname; <span class="hljs-comment">// TCP handles only.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert(handles.has(key) === <span class="hljs-literal">false</span>);</span><br><span class="line">  handles.set(key, handle);</span><br><span class="line">  cb(<span class="hljs-number">0</span>, handle); <span class="hljs-comment">// 将封装好的handle，作为listenInCluster的回调handle，赋给server._handle</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// Round-robin connection.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onconnection</span>(<span class="hljs-params">message, handle</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> key = message.key; <span class="hljs-comment">// maseter里的key</span></span><br><span class="line">  <span class="hljs-keyword">const</span> server = handles.get(key); <span class="hljs-comment">// 是client创建的server？</span></span><br><span class="line">  <span class="hljs-keyword">const</span> accepted = server !== <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  send(&#123; <span class="hljs-attr">ack</span>: message.seq, accepted &#125;); <span class="hljs-comment">// 答复 master</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 虽然cluster.child rr里没有为server绑定，onconnection</span></span><br><span class="line">  <span class="hljs-comment">// 但是在cb回到net.js里，后面的逻辑绑定了onconnection方法</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (accepted) server.onconnection(<span class="hljs-number">0</span>, handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/master.js</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryServer</span>(<span class="hljs-params">worker, message</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// worker是cluster.child worker</span></span><br><span class="line">  <span class="hljs-keyword">const</span> key =</span><br><span class="line">    <span class="hljs-string">`<span class="hljs-subst">$&#123;message.address&#125;</span>:<span class="hljs-subst">$&#123;message.port&#125;</span>:<span class="hljs-subst">$&#123;message.addressType&#125;</span>:`</span> +</span><br><span class="line">    <span class="hljs-string">`<span class="hljs-subst">$&#123;message.fd&#125;</span>:<span class="hljs-subst">$&#123;message.index&#125;</span>`</span>;</span><br><span class="line">  <span class="hljs-keyword">var</span> handle = handles.get(key);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (handle === <span class="hljs-literal">undefined</span>) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="hljs-comment">// 默认是RoundRobin，Shared模式暂不讨论有兴趣可以看源码</span></span><br><span class="line">    <span class="hljs-keyword">var</span> <span class="hljs-keyword">constructor</span> = RoundRobinHandle;</span><br><span class="line">    // ...</span><br><span class="line">    handle = new <span class="hljs-keyword">constructor</span>(</span><br><span class="line">      key,</span><br><span class="line">      address,</span><br><span class="line">      message.port,</span><br><span class="line">      message.addressType,</span><br><span class="line">      message.fd,</span><br><span class="line">      message.flags</span><br><span class="line">    );</span><br><span class="line">    handles.set(key, handle);</span><br><span class="line">  &#125;</span><br><span class="line">  // ...</span><br><span class="line">  // 将cluster.child的worker添加到handle中</span><br><span class="line">  handle.add(worker, (errno, reply, handle) =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> &#123; data &#125; = handles.get(key);</span><br><span class="line">    send(</span><br><span class="line">      worker,</span><br><span class="line">      &#123;</span><br><span class="line">        errno,</span><br><span class="line">        key,</span><br><span class="line">        ack: message.seq,</span><br><span class="line">        data,</span><br><span class="line">        ...reply,</span><br><span class="line">      &#125;,</span><br><span class="line">      handle <span class="hljs-comment">// round_robin_handle 里返回的是一个null</span></span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/internal/cluster/round_robin_handle.js</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RoundRobinHandle</span>(<span class="hljs-params">key, address, port, addressType, fd, flags</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">this</span>.key = key;</span><br><span class="line">  <span class="hljs-keyword">this</span>.all = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();</span><br><span class="line">  <span class="hljs-keyword">this</span>.free = [];</span><br><span class="line">  <span class="hljs-keyword">this</span>.handles = [];</span><br><span class="line">  <span class="hljs-keyword">this</span>.handle = <span class="hljs-literal">null</span>;</span><br><span class="line">  <span class="hljs-keyword">this</span>.server = net.createServer(assert.fail);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.server.listen(&#123; fd &#125;);</span><br><span class="line">  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (port &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.server.listen(&#123;</span><br><span class="line">      port,</span><br><span class="line">      host: address,</span><br><span class="line">      <span class="hljs-comment">// Currently, net module only supports `ipv6Only` option in `flags`.</span></span><br><span class="line">      ipv6Only: <span class="hljs-built_in">Boolean</span>(flags &amp; constants.UV_TCP_IPV6ONLY),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.server.listen(address); <span class="hljs-comment">// UNIX socket path.</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>.server.once(<span class="hljs-string">"listening"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.handle = <span class="hljs-keyword">this</span>.server._handle;</span><br><span class="line">    <span class="hljs-comment">// 重置onconnection方法</span></span><br><span class="line">    <span class="hljs-comment">// distribute 做任务派发</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.handle.onconnection = <span class="hljs-function">(<span class="hljs-params">err, handle</span>) =&gt;</span> <span class="hljs-keyword">this</span>.distribute(err, handle);</span><br><span class="line">    <span class="hljs-keyword">this</span>.server._handle = <span class="hljs-literal">null</span>;</span><br><span class="line">    <span class="hljs-keyword">this</span>.server = <span class="hljs-literal">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RoundRobinHandle.prototype.add = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker, send</span>) </span>&#123;</span><br><span class="line">  assert(<span class="hljs-keyword">this</span>.all.has(worker.id) === <span class="hljs-literal">false</span>);</span><br><span class="line">  <span class="hljs-keyword">this</span>.all.set(worker.id, worker);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> done = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handle.getsockname) &#123;</span><br><span class="line">      <span class="hljs-comment">// tcp\udp 会有getsockname</span></span><br><span class="line">      <span class="hljs-keyword">const</span> out = &#123;&#125;;</span><br><span class="line">      <span class="hljs-keyword">this</span>.handle.getsockname(out);</span><br><span class="line">      <span class="hljs-comment">// TODO(bnoordhuis) Check err.</span></span><br><span class="line">      send(<span class="hljs-literal">null</span>, &#123; <span class="hljs-attr">sockname</span>: out &#125;, <span class="hljs-literal">null</span>);</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      send(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>); <span class="hljs-comment">// UNIX socket.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">this</span>.handoff(worker); <span class="hljs-comment">// In case there are connections pending.</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.server === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> done();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// Still busy binding.</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.server.once(<span class="hljs-string">"listening"</span>, done);</span><br><span class="line">  <span class="hljs-keyword">this</span>.server.once(<span class="hljs-string">"error"</span>, (err) =&gt; &#123;</span><br><span class="line">    send(err.errno, <span class="hljs-literal">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">RoundRobinHandle.prototype.distribute = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, handle</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">this</span>.handles.push(handle);</span><br><span class="line">  <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">this</span>.free.shift();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (worker) <span class="hljs-keyword">this</span>.handoff(worker);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">RoundRobinHandle.prototype.handoff = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">worker</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// worker如果不存在那就跳出</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.all.has(worker.id) === <span class="hljs-literal">false</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Worker is closing (or has closed) the server.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> handle = <span class="hljs-keyword">this</span>.handles.shift(); <span class="hljs-comment">// 取出第一个待处理任务</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (handle === <span class="hljs-literal">undefined</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.free.push(worker);  <span class="hljs-comment">// 没有的话就会将worker归还到free里</span></span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> message = &#123; <span class="hljs-attr">act</span>: <span class="hljs-string">"newconn"</span>, <span class="hljs-attr">key</span>: <span class="hljs-keyword">this</span>.key &#125;;</span><br><span class="line"></span><br><span class="line">  sendHelper(worker.process, message, handle, (reply) =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (reply.accepted) handle.close();</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.distribute(<span class="hljs-number">0</span>, handle); <span class="hljs-comment">// Worker is shutting down. Send to another.</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">this</span>.handoff(worker);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p><code>cluster</code>利用child_process的fork方法创建子进程，并传入新的环境变量<code>NODE_UNIQUE_ID</code>用于区分主子进程从而在require(‘cluster’)时候可以加载到对应的<code>master.js</code>和<code>child.js</code>文件。另外在默认的<code>RoundRobinHandle</code>模式下，<code>cluster</code>子进程之所以可以共同监听同个TCP端口，是在<code>net</code>模块里面做了master和child区分，child并没有真正的监听端口，而是child会去master查询该Server是否已经存在，如果没有会在<code>RoundRobinHandle</code>中创建中创建server，一旦有新的TCP连接进入，会转发给<code>free</code>里的worker（cluster.child）处理。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Node-js/">#Node.js</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/JavaScript/">#JavaScript</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/06/28/nodejs-istio-k8s-docker/">Istio简单概念</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/04/06/child_process-exec-fork-spawn/">简单梳理Node.js创建子进程的方法（上）</a>
            
        </span>
    </div>
    
</article>



<div class="comments">
    <ul class="adv">
  <li class="img"><img src="/images/give-a-reward.png" alt="reward"></li>
  <li>
    欢迎加入<a href="https://oriente.com/" target="_blank">Oriente</a>前端组，<a href="https://www.lagou.com/jobs/4927018.html?source=pl&i=pl-3" target="_blank">岗位信息</a>
  </li>
  <li>
    同时也欢迎光顾我的小店<a href="http://aimianwu.com" target="_blank">爱眠物</a>
  </li>
</ul>

    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://mlib.wang/2020/05/03/node-js-net-cluster-fork/';
        this.page.identifier = '2020/05/03/node-js-net-cluster-fork/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'mblof' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section> <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2020 Miser&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer> <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    

    


<script src="/js/script.js"></script> 
  </body>
  <script data-ad-client="ca-pub-6006630417531788" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</html>
