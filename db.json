{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/egg-cluster/1.jpg","path":"images/egg-cluster/1.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/3.jpg","path":"images/egg-cluster/3.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/3.jpg","path":"images/js-capture-error/3.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/6.jpg","path":"images/js-capture-error/6.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/7.jpg","path":"images/js-capture-error/7.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/8.jpg","path":"images/js-capture-error/8.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/1.jpg","path":"images/vue-component-extends/1.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/3.jpg","path":"images/vue-component-extends/3.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/2.jpg","path":"images/vue-component-extends/2.jpg","modified":0,"renderable":0},{"_id":"source/images/vue-component-extends/4.jpg","path":"images/vue-component-extends/4.jpg","modified":0,"renderable":0},{"_id":"themes/minos/source/css/insight.scss","path":"css/insight.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/css/style.scss","path":"css/style.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/check.svg","path":"images/check.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/exclamation.svg","path":"images/exclamation.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/info.svg","path":"images/info.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/minos/source/images/quote-left.svg","path":"images/quote-left.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/question.svg","path":"images/question.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/minos/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"source/images/egg-cluster/2.jpg","path":"images/egg-cluster/2.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-cluster/4.jpg","path":"images/egg-cluster/4.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/9.jpg","path":"images/js-capture-error/9.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/4.jpg","path":"images/js-capture-error/4.jpg","modified":0,"renderable":0},{"_id":"source/images/js-css-image-loading/1.png","path":"images/js-css-image-loading/1.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/10.jpg","path":"images/js-capture-error/10.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/5.jpg","path":"images/js-capture-error/5.jpg","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/1.png","path":"images/js-capture-error/1.png","modified":0,"renderable":0},{"_id":"source/images/js-capture-error/2.jpg","path":"images/js-capture-error/2.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/27.jpg","path":"images/traveling-to-the-philippines/27.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/26.jpg","path":"images/traveling-to-the-philippines/26.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/13.jpg","path":"images/traveling-to-the-philippines/13.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/2.jpg","path":"images/traveling-to-the-philippines/2.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/25.jpg","path":"images/traveling-to-the-philippines/25.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/6.jpg","path":"images/traveling-to-the-philippines/6.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/11.jpg","path":"images/traveling-to-the-philippines/11.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/9.jpg","path":"images/traveling-to-the-philippines/9.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/12.jpg","path":"images/traveling-to-the-philippines/12.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/34.jpg","path":"images/traveling-to-the-philippines/34.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/3.jpg","path":"images/traveling-to-the-philippines/3.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/23.jpg","path":"images/traveling-to-the-philippines/23.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/4.jpg","path":"images/traveling-to-the-philippines/4.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/17.jpg","path":"images/traveling-to-the-philippines/17.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/20.jpg","path":"images/traveling-to-the-philippines/20.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/14.jpg","path":"images/traveling-to-the-philippines/14.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/31.jpg","path":"images/traveling-to-the-philippines/31.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/30.jpg","path":"images/traveling-to-the-philippines/30.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/32.jpg","path":"images/traveling-to-the-philippines/32.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/1.jpg","path":"images/traveling-to-the-philippines/1.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/10.jpg","path":"images/traveling-to-the-philippines/10.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/29.jpg","path":"images/traveling-to-the-philippines/29.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/8.jpg","path":"images/traveling-to-the-philippines/8.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/28.jpg","path":"images/traveling-to-the-philippines/28.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/24.jpg","path":"images/traveling-to-the-philippines/24.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/16.jpg","path":"images/traveling-to-the-philippines/16.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/7.jpg","path":"images/traveling-to-the-philippines/7.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/15.jpg","path":"images/traveling-to-the-philippines/15.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","path":"images/traveling-to-the-philippines/33.jpeg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/22.jpg","path":"images/traveling-to-the-philippines/22.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/21.jpg","path":"images/traveling-to-the-philippines/21.jpg","modified":0,"renderable":0},{"_id":"source/images/traveling-to-the-philippines/19.jpg","path":"images/traveling-to-the-philippines/19.jpg","modified":0,"renderable":0},{"_id":"source/images/egg-boot/egg-boot.jpg","path":"images/egg-boot/egg-boot.jpg","modified":1,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"d3f852adb2f87723d652929e9943b2a2ec397053","modified":1559146928571},{"_id":"themes/minos/.gitignore","hash":"8b02e7219e2dd9b50d198819fd7d8f74ebc9db2a","modified":1539929989625},{"_id":"themes/minos/LICENSE","hash":"ca01a2d52b59346e82f079c593df6cb26dd9a7a5","modified":1539929989626},{"_id":"themes/minos/README.md","hash":"ba6b4e134d718704cfd030e106bf24d6ef8b496d","modified":1539929989626},{"_id":"themes/minos/_config.yml.example","hash":"28c6c5604380fb6cc5a99639fa445c40205764ba","modified":1539929989626},{"_id":"themes/minos/package-lock.json","hash":"e1fbecec56fb65379bf651f21fb485376e692b38","modified":1539929989634},{"_id":"themes/minos/package.json","hash":"f9d450db80149dea6c372990cdf51dfde901e5cc","modified":1539929989634},{"_id":"source/_posts/egg-cluster.md","hash":"6b11478e14d65b21e426c4a5c7c3eabc47dcd37b","modified":1547839811959},{"_id":"source/_posts/egg.md","hash":"4af5e93750a823b0a4ff4d68d783c4945da2399b","modified":1557460323154},{"_id":"source/_posts/js-capture-error.md","hash":"055666f71355a4a000876bcec186e2b21baf6dd0","modified":1547819371622},{"_id":"source/_posts/js-css-image-loading.md","hash":"5c4cbbf077e0cd03c92e1e5f118d7fa5b8d138b5","modified":1547819302030},{"_id":"source/_posts/the-quality-of-a-company-first-look-at-HR-department.md","hash":"33cc9143dfde3b8efd8027bafa43a2fe9777fd23","modified":1539930247636},{"_id":"source/_posts/traveling-to-the-philippines.md","hash":"cb8ccfba6a1477d7042e0d3ae892ffeb8f8d88b0","modified":1540098421239},{"_id":"source/_posts/vue-component-extends.md","hash":"5daacd88658195304ab14ebac5e83a1d64383900","modified":1542705866765},{"_id":"source/images/.DS_Store","hash":"38f9a790f56e04c15dc6fa1f86d46fe2ea63d25f","modified":1559146928570},{"_id":"themes/minos/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1539929989616},{"_id":"themes/minos/.git/config","hash":"86ce9cdb1395b8347f38abd45a74bbfee3334069","modified":1539929989618},{"_id":"themes/minos/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1539929886986},{"_id":"themes/minos/.git/index","hash":"834201d69d82795a4c8e733cc314348abd59409f","modified":1547839090050},{"_id":"themes/minos/.git/packed-refs","hash":"fcd170bd0dccf1d9e3d6783a56401032d34c6279","modified":1539929989612},{"_id":"themes/minos/languages/en.yml","hash":"ef98c8674fed78f2350598ee8b15fcd53fbd2ae5","modified":1539929989626},{"_id":"themes/minos/languages/es.yml","hash":"5c35950221411e34e7a9821d0b0671da9a458d8c","modified":1539929989626},{"_id":"themes/minos/languages/ko.yml","hash":"1acf3f959f1d2b4f7a77e7e82851821aa8635362","modified":1539929989626},{"_id":"themes/minos/languages/ru.yml","hash":"8e5a58176bf943432ba6e4f1981d9b98fdea36a4","modified":1539929989627},{"_id":"themes/minos/languages/zh-cn.yml","hash":"9c5a489b11a056d1ea7b9d4a0e127aef9e192ee4","modified":1539929989627},{"_id":"themes/minos/layout/archive.ejs","hash":"e3eefe819d61b4d0ee069bb705a9f5707a8bf3da","modified":1539929989627},{"_id":"themes/minos/layout/categories.ejs","hash":"fff6f911d0f548ee749292bc1942f8fbbb1fbfe7","modified":1539929989627},{"_id":"themes/minos/layout/category.ejs","hash":"403c646878834964883ac41e63952f7b1595c0ba","modified":1539929989627},{"_id":"themes/minos/layout/index.ejs","hash":"dff9e199d394f82c5416b814f9e644edbe4090f0","modified":1539929989631},{"_id":"themes/minos/layout/layout.ejs","hash":"0d0dc44ac98ad02f877a7fdc47108379bda36518","modified":1542705011131},{"_id":"themes/minos/layout/post.ejs","hash":"68b84a717efc5ca59ee9eb6202ccf05c5a8abda5","modified":1542704537007},{"_id":"themes/minos/layout/tag.ejs","hash":"5593c7cf9618ef5650c779ed9d75424f057aa210","modified":1539929989634},{"_id":"themes/minos/layout/tags.ejs","hash":"e4a9909119294f131a45f10b2cb1058af5fb9be1","modified":1539929989634},{"_id":"themes/minos/scripts/01_check.js","hash":"b26b19011a6eb61e61419331a7f9c5fdf553d830","modified":1539929989635},{"_id":"themes/minos/scripts/10_i18n.js","hash":"346a09259e15913871e12c7418a639b8d65df570","modified":1539929989635},{"_id":"themes/minos/scripts/99_config.js","hash":"d41a5df0a442728fbc66514476fe043e416d7438","modified":1539929989636},{"_id":"themes/minos/scripts/99_content.js","hash":"5d19de210e9172a9acb61667a26810899fce917d","modified":1539929989636},{"_id":"themes/minos/scripts/99_tags.js","hash":"91369a4d8376bc981a9bad9c5dde4b3e775e5cb5","modified":1539929989636},{"_id":"themes/minos/scripts/rfc5646.js","hash":"8ecf38d0ec7145720ea8e888da314131712770e8","modified":1539929989637},{"_id":"source/images/egg-cluster/1.jpg","hash":"862150374047d825dc6cf409a86c4ca75e132c86","modified":1547825914938},{"_id":"source/images/egg-cluster/3.jpg","hash":"2e999d8632a8a784f778c48b4c26238ce61dfad5","modified":1547835689228},{"_id":"source/images/js-capture-error/3.jpg","hash":"8ab14ad4b43d54cd690218c0a9205ae8d5f102de","modified":1540291527155},{"_id":"source/images/js-capture-error/6.jpg","hash":"4df941e78df71a066d31a4e4d9f7a2acf6663c8a","modified":1540293956385},{"_id":"source/images/js-capture-error/7.jpg","hash":"2048e9e10834e569f9ac9d13befbbeab25e0db98","modified":1540974769131},{"_id":"source/images/js-capture-error/8.jpg","hash":"d16542cad83c53000902969dca6604833675dd5b","modified":1540976969164},{"_id":"source/images/js-css-image-loading/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1538981158873},{"_id":"source/images/traveling-to-the-philippines/.DS_Store","hash":"09847c782bbd99879ee77fd46a2f4dec199098e7","modified":1537774825570},{"_id":"source/images/vue-component-extends/.DS_Store","hash":"00a462683ca4b1bac0c231a447a8b4898cb88c06","modified":1542703462901},{"_id":"source/images/vue-component-extends/1.jpg","hash":"f8ed085d61eac35e39a75469cec2fb53184c8f99","modified":1542703395363},{"_id":"source/images/vue-component-extends/3.jpg","hash":"34366ce9fa8f6d101918ee510b87d50a980f1898","modified":1542703607861},{"_id":"source/images/vue-component-extends/2.jpg","hash":"849929e4e6cb963667a09efe4ffb6b1dc1c30052","modified":1542703507708},{"_id":"themes/minos/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1539929886988},{"_id":"themes/minos/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1539929886987},{"_id":"source/images/vue-component-extends/4.jpg","hash":"9b02fc2442e9c12e70a3f2099e080a8abbfce0f8","modified":1542703962815},{"_id":"themes/minos/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1539929886988},{"_id":"themes/minos/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1539929886989},{"_id":"themes/minos/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1539929886989},{"_id":"themes/minos/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1539929886987},{"_id":"themes/minos/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1539929886987},{"_id":"themes/minos/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1539929886989},{"_id":"themes/minos/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1539929886988},{"_id":"themes/minos/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1539929886989},{"_id":"themes/minos/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1539929886989},{"_id":"themes/minos/.git/info/exclude","hash":"bb5a85730dcf100facee799c05cc4f6affec0745","modified":1539929886986},{"_id":"themes/minos/.git/logs/HEAD","hash":"bfa70c9f0f2aec69b826093c6cb8e8160bce954a","modified":1539929989617},{"_id":"themes/minos/layout/comment/changyan.ejs","hash":"9ccc7ec354b968e60bdcfcd1dba451d38de61f12","modified":1539929989628},{"_id":"themes/minos/layout/comment/disqus.ejs","hash":"a2becdc02214a673c804af93488489807fa2c99c","modified":1539929989628},{"_id":"themes/minos/layout/comment/facebook.ejs","hash":"e73b6f93d98b27ba9068c1685874ecccfbac737b","modified":1539929989628},{"_id":"themes/minos/layout/comment/gitment.ejs","hash":"430416210933b7edcbfcc67ede4aa55539da2750","modified":1539929989629},{"_id":"themes/minos/layout/comment/isso.ejs","hash":"cc6a43bd24be764086f88ad7c5c97ff04df87e0b","modified":1539929989629},{"_id":"themes/minos/layout/comment/valine.ejs","hash":"350f28986dd610ebdfdeb16dc618d1d034312af1","modified":1539929989629},{"_id":"themes/minos/layout/comment/livere.ejs","hash":"12ff9a345f6bba2f732f592e39508c2afde89b00","modified":1539929989629},{"_id":"themes/minos/layout/comment/youyan.ejs","hash":"3d6cf9c523a7a5510ec2864bb29f861f9bb78af3","modified":1539929989629},{"_id":"themes/minos/layout/common/adv.ejs","hash":"01516deef98a21f349812351476d44d2e4c245c4","modified":1542704868289},{"_id":"themes/minos/layout/common/footer.ejs","hash":"367c5f2e69c66d4d6fbd8beeade0b60024ce9e6e","modified":1539929989630},{"_id":"themes/minos/layout/common/head.ejs","hash":"1447e514eae24bfa4a80d598fea8b28674c4e873","modified":1539929989630},{"_id":"themes/minos/layout/common/languages.ejs","hash":"89665c656a1ffebc9c97f03e7f9c12dd1d90702a","modified":1539929989630},{"_id":"themes/minos/layout/common/article.ejs","hash":"5b45c9ee074d0d92cf9f227971968fadafef5d2e","modified":1542704624144},{"_id":"themes/minos/layout/common/navbar.ejs","hash":"88e14ed41b4ed23bb4516c4db882a52b3cad5586","modified":1540098845399},{"_id":"themes/minos/layout/common/paginator.ejs","hash":"8f5060e4c8a86a3f4e58455c41c98e831e23e4a4","modified":1539929989631},{"_id":"themes/minos/layout/common/scripts.ejs","hash":"7a5a5271930423b95046836597e30e31fa708f66","modified":1539929989631},{"_id":"themes/minos/layout/plugins/gallery.ejs","hash":"7c2becafdf6b60e677cdd5756b9d55eba2af4944","modified":1539929989631},{"_id":"themes/minos/layout/plugins/google-analytics.ejs","hash":"2a9d944a60aff7df27def5215bdc071e605c3c42","modified":1539929989632},{"_id":"themes/minos/layout/plugins/mathjax.ejs","hash":"b460310078d3506dce8dccc67310e3b9b3c124a9","modified":1539929989632},{"_id":"themes/minos/layout/search/google-cse.ejs","hash":"a6bf5c30339735126efa7efa684f9eb14dd6136a","modified":1539929989632},{"_id":"themes/minos/layout/search/insight.ejs","hash":"6fb7d27ef40145d8587b46b44a43516135b5a81a","modified":1539929989633},{"_id":"themes/minos/layout/share/addthis.ejs","hash":"f1c5f337333009d5f00dfbac4864a16ef8f9cb8d","modified":1539929989633},{"_id":"themes/minos/layout/share/sharethis.ejs","hash":"4f2c40f790f3be0a4e79db04f02ea41ba2f4d4c0","modified":1539929989634},{"_id":"themes/minos/source/css/insight.scss","hash":"f785fc6574d2853c660be39b2e3149d4846b577f","modified":1539929989637},{"_id":"themes/minos/source/css/style.scss","hash":"48d8b2bc475a26b4354c1717cdd131952aef5718","modified":1557416267782},{"_id":"themes/minos/source/images/check.svg","hash":"029b8b3523b7daa4005983b4463cd93408308aab","modified":1539929989637},{"_id":"themes/minos/source/images/exclamation.svg","hash":"b2db56f2cc13fce73dbea46c7b446d9bcb3bf0fd","modified":1539929989638},{"_id":"themes/minos/source/images/info.svg","hash":"c8aa387e935ba9a7fa72c5dd000b7d46f2e030c4","modified":1539929989638},{"_id":"themes/minos/source/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1539929989638},{"_id":"themes/minos/source/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1539929989638},{"_id":"themes/minos/source/images/question.svg","hash":"7153fa2a0c21e32da6a1f96a333d8b66a178569d","modified":1539929989638},{"_id":"themes/minos/source/js/insight.js","hash":"eb23c31141784eef7300f1d1c548950e77883f56","modified":1539929989638},{"_id":"themes/minos/source/js/script.js","hash":"6b670ec4f90fb43b21a0bbd750a217af5d8aab6b","modified":1539929989639},{"_id":"source/images/egg-cluster/2.jpg","hash":"3f3006fab2f9e349a3cd43708c8f5fce54c1083e","modified":1547831632956},{"_id":"source/images/egg-cluster/4.jpg","hash":"31f6945a8694b2cbbb7bc8906ca166b96cc0803e","modified":1547836957770},{"_id":"source/images/js-capture-error/9.jpg","hash":"0d70c8c909842dc05faf690ee1496d98093e8e87","modified":1540977289307},{"_id":"source/images/js-capture-error/4.jpg","hash":"c2a26768421ef97bbfd6cf6e13484c93f622202b","modified":1540292413830},{"_id":"source/images/js-css-image-loading/1.png","hash":"199fffb885dde4ce13b60b4f1394be4206fc562e","modified":1538981136490},{"_id":"themes/minos/.git/refs/heads/master","hash":"ea2a316ccb5ffdc55fde669f5b68945ab21b6229","modified":1539929989616},{"_id":"themes/minos/.git/objects/pack/pack-790f7fc552d52f86fda88f83cda917eb5f383982.idx","hash":"a7e66398fad7cb3a3cf6304e85b6773df12987af","modified":1539929989593},{"_id":"source/images/js-capture-error/10.jpg","hash":"990afee0f1c758900bbe01a93cb2713ce18f825b","modified":1540977492805},{"_id":"source/images/js-capture-error/5.jpg","hash":"0582a343ea918d89bf3927a061e6f9fd34008755","modified":1540292440054},{"_id":"themes/minos/.git/logs/refs/heads/master","hash":"bfa70c9f0f2aec69b826093c6cb8e8160bce954a","modified":1539929989617},{"_id":"themes/minos/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1539929989615},{"_id":"source/images/js-capture-error/1.png","hash":"dacb219805eddb286537551536ee485f06f2ee89","modified":1540288575865},{"_id":"themes/minos/.git/logs/refs/remotes/origin/HEAD","hash":"bfa70c9f0f2aec69b826093c6cb8e8160bce954a","modified":1539929989615},{"_id":"source/images/js-capture-error/2.jpg","hash":"75a01876e36c3470e2589b8f3c30bb55b20e1a9e","modified":1540288731846},{"_id":"source/images/traveling-to-the-philippines/27.jpg","hash":"4e15125876b160a47f66fe0835fb26efcc37e456","modified":1537374346942},{"_id":"source/images/traveling-to-the-philippines/26.jpg","hash":"17d6879785c31dc08c8625d2b54672c277e880ae","modified":1537374347110},{"_id":"source/images/traveling-to-the-philippines/13.jpg","hash":"86666ad42e2c18f8df3b3bb438e383e7aab19b26","modified":1537373145988},{"_id":"source/images/traveling-to-the-philippines/2.jpg","hash":"3d1b5fe7a18c3b157d7a76931a24134516f1df2b","modified":1537372709171},{"_id":"source/images/traveling-to-the-philippines/25.jpg","hash":"fb8326a57bddda0a8ff03966041b78d335019441","modified":1537374286456},{"_id":"source/images/traveling-to-the-philippines/6.jpg","hash":"afb158c4f30418d27c35298e833bc4c5aecbbe14","modified":1537373215175},{"_id":"source/images/traveling-to-the-philippines/11.jpg","hash":"f2f6843fb714053053631e0d60f4a84e93b130f1","modified":1537372952414},{"_id":"source/images/traveling-to-the-philippines/9.jpg","hash":"c1425a41b66d74ab1608a45f63f486640a4c2072","modified":1537373177974},{"_id":"source/images/traveling-to-the-philippines/12.jpg","hash":"dcb70fbb7bf5e0b9419d74e3cdfdc45052eb19a1","modified":1537373092718},{"_id":"source/images/traveling-to-the-philippines/34.jpg","hash":"5dc39ae840f701145ec5f0fbbcb56615781f5233","modified":1537373573195},{"_id":"source/images/traveling-to-the-philippines/3.jpg","hash":"a505e8b86786f108e626d482c08774e46920139d","modified":1537372879713},{"_id":"source/images/traveling-to-the-philippines/23.jpg","hash":"eb7a3d220d5870d49a34d54a8dd53f2774eeffc2","modified":1537774786955},{"_id":"source/images/traveling-to-the-philippines/4.jpg","hash":"e0631786797fea0feb1e84ff174270f792eb4255","modified":1537372878136},{"_id":"source/images/traveling-to-the-philippines/17.jpg","hash":"3eefa5a106856f685427d3a7322841b7ebcd36cb","modified":1537373535440},{"_id":"source/images/traveling-to-the-philippines/20.jpg","hash":"68f8036efb53cae3adf8bc445a6f30897b5ed234","modified":1537373912002},{"_id":"source/images/traveling-to-the-philippines/14.jpg","hash":"d4fb952d4f8ce6df905c4e3304308807722ded7d","modified":1537373112490},{"_id":"source/images/traveling-to-the-philippines/31.jpg","hash":"69d4edc45e6f4e40d31b51351555b91013a44510","modified":1537373035199},{"_id":"source/images/traveling-to-the-philippines/30.jpg","hash":"83c2db4773744d39f66c1d52e51f53971c5afcaf","modified":1537373703039},{"_id":"source/images/traveling-to-the-philippines/32.jpg","hash":"42a513f3038d178f52ec6601da1ce74d93cee165","modified":1537373622020},{"_id":"source/images/traveling-to-the-philippines/1.jpg","hash":"b1fa05a24083c98a28b934344f1bdf5a67df06f0","modified":1537372732670},{"_id":"source/images/traveling-to-the-philippines/10.jpg","hash":"0b2f9ef30a378d3af94492a9f5472bb365a4f61a","modified":1537372797891},{"_id":"source/images/traveling-to-the-philippines/29.jpg","hash":"416513cc33a1ee5c5290fca1dcc6bf1dde2f837b","modified":1537373661170},{"_id":"source/images/traveling-to-the-philippines/8.jpg","hash":"472272b727cb7da43edde1d504f983e6fc34ad8c","modified":1537373307761},{"_id":"source/images/traveling-to-the-philippines/28.jpg","hash":"0c26af42740f5c1579efb1afecfff73cf0a6fee6","modified":1537374447693},{"_id":"source/images/traveling-to-the-philippines/24.jpg","hash":"e487c3820c05646939bf32c0ee75c8d297230442","modified":1537374216746},{"_id":"source/images/traveling-to-the-philippines/16.jpg","hash":"d8049cceba3e0e37b60227071c6e832d330c6ce8","modified":1537373389273},{"_id":"source/images/traveling-to-the-philippines/7.jpg","hash":"1a58dcad2808f5d5973c6b9095bc7e70b10a77eb","modified":1537373285221},{"_id":"source/images/traveling-to-the-philippines/15.jpg","hash":"1236ad3788f5f58a9a2bf0e739e72aeecf78a7a4","modified":1537373414698},{"_id":"source/images/traveling-to-the-philippines/33.jpeg","hash":"0c442a5b7cd93eec6e56c59e814d97361121c238","modified":1537776358067},{"_id":"source/images/traveling-to-the-philippines/22.jpg","hash":"2e0e76e19e6b3224f5aef6666853fc76bec5e040","modified":1537374048726},{"_id":"source/images/traveling-to-the-philippines/21.jpg","hash":"4c6034c62b008a531593252d4a0dacfd6afe7a5b","modified":1537374040192},{"_id":"source/images/traveling-to-the-philippines/19.jpg","hash":"1d7e6d3b9652d43eb331c2a65201339c0d6c6544","modified":1537373825159},{"_id":"themes/minos/.git/objects/pack/pack-790f7fc552d52f86fda88f83cda917eb5f383982.pack","hash":"a8315bb56622a834302e523718c32bf0e7693f41","modified":1539929989592},{"_id":"source/_posts/egg-boot.md","hash":"82a76c80946438a8ec8b58fd484a5ae19e361374","modified":1559396658456},{"_id":"source/images/egg-boot/egg-boot.jpg","hash":"797e47cc7d8670cf81001fbcda726652ccc626d8","modified":1559146884398},{"_id":"source/images/egg-boot/.DS_Store","hash":"bbd420da502fa0990e15e702c4b5bf0a962d03b4","modified":1559146935945}],"Category":[{"name":"javascript","_id":"cjvgs676o0002el8qnwa6dl3l"},{"name":"工作","_id":"cjvgs677n0006el8q87pkahqp"}],"Data":[],"Page":[],"Post":[{"title":"Egg Cluster 简单介绍","_content":"\n如果不清楚什么是Egg.js，希望能移步到它的[官网](https://eggjs.org)简单看下。另外说它是__约定大于配置__的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：\n\n> 1.提供基于 Egg [定制上层框架](https://eggjs.org/zh-cn/advanced/framework.html) 的能力\n> 2.高度可扩展的[插件机制](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.内置[多进程管理](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4.基于 [Koa](http://koajs.com/) 开发，性能优异\n> 5.框架稳定，测试覆盖率高\n> 6.[渐进式开发](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？\n\n在我看来最吸引我的是第3条，__内置多进程管理__，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。\n\n<!-- more -->\n\n\n\n### __#从源码慢慢了解__\n\n- __egg-core__: 定义了一个__EggCore__类，它继承KoaApplication，也就是特性中提到的第4条 *基于Koa开发，性能优异*\n- __egg__: 定义了一个继承于EggCore的__EggApplication__类，并且Application和Agent分别继承于EggApplication\n- __egg-cluster__: 这个类库主要就是做__多进程管理__的工作\n\n*egg-cluster让Egg.js变得与众不同*，看看它做了什么。\n\n### egg-cluster\n\n```js\n// egg-cluster index.js 唯一对外暴露的接口 startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：\n![Master-Agent-Works 模型](/images/egg-cluster/1.jpg)\n\n### Agent-Works怎么启动的？\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // 试着找个可以用的port\n            this.options.clusterPort = port;\n            // 启动 agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        // 将需要数量的 worker 一个个创建出来\n        // cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口\n        // 创建 http或https服务\n    }\n}\n```\n\nagent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发\"agent-start\"给父进程，触发Master的订阅创建Workers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works怎么通信呢? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- 在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例\n- EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例\n\n由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n一条信息必定有__from__...__to__...信息\n\n![Master-Agent-Works 通信模型](/images/egg-cluster/2.jpg)\n\n### 官网里提到的“[多进程研发模式增强](https://eggjs.org/zh-cn/advanced/cluster-client.html)”\n\n![一个程序运行n个worker连m个远程服务](/images/egg-cluster/3.jpg)\n\n- n * m 个连接导致大量连接资源“浪费”\n- 减少Master转发带来的额外性能消耗\n- 另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常\n\n所以还有一种socket通信方式（使用了另一个库[cluster-client](https://github.com/node-modules/cluster-client)）：\n\n- 将Agent作为Leader，从服务端获取数据，并做缓存\n- 将Worker作为Follower，订阅Agent获取的数据\n\n典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。\n\n![socket通信](/images/egg-cluster/4.jpg)\n\n### cluster-client 源码一瞥\n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- port数值就是上文开始处通过detectPort获取的clusterPort数值\n- 然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信\n- Leader获取数据触发publish，传给订阅的Follower中\n\ncluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。\n\n\n\n### __#总结__\n\nEgg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。","source":"_posts/egg-cluster.md","raw":"---\ntitle: Egg Cluster 简单介绍\ncategory: javascript\n---\n\n如果不清楚什么是Egg.js，希望能移步到它的[官网](https://eggjs.org)简单看下。另外说它是__约定大于配置__的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：\n\n> 1.提供基于 Egg [定制上层框架](https://eggjs.org/zh-cn/advanced/framework.html) 的能力\n> 2.高度可扩展的[插件机制](https://eggjs.org/zh-cn/basics/plugin.html)\n> 3.内置[多进程管理](https://eggjs.org/zh-cn/advanced/cluster-client.html)\n> 4.基于 [Koa](http://koajs.com/) 开发，性能优异\n> 5.框架稳定，测试覆盖率高\n> 6.[渐进式开发](https://eggjs.org/zh-cn/tutorials/progressive.html)\n\n第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？\n\n在我看来最吸引我的是第3条，__内置多进程管理__，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。\n\n<!-- more -->\n\n\n\n### __#从源码慢慢了解__\n\n- __egg-core__: 定义了一个__EggCore__类，它继承KoaApplication，也就是特性中提到的第4条 *基于Koa开发，性能优异*\n- __egg__: 定义了一个继承于EggCore的__EggApplication__类，并且Application和Agent分别继承于EggApplication\n- __egg-cluster__: 这个类库主要就是做__多进程管理__的工作\n\n*egg-cluster让Egg.js变得与众不同*，看看它做了什么。\n\n### egg-cluster\n\n```js\n// egg-cluster index.js 唯一对外暴露的接口 startCluster\nexports.startCluster = function (options, callback) {\n    new Master(options).ready(callback)\n}\n```\n\negg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：\n![Master-Agent-Works 模型](/images/egg-cluster/1.jpg)\n\n### Agent-Works怎么启动的？\n```js\nclass Master extends EventEmitter {\n    constructor(options) {\n        this.workerManager = new Manager();\n    \tthis.messenger = new Messenger(this);\n        // ...\n\t\tthis.once('agent-start', this.forkAppWorkers.bind(this));\n        // ...\n        detectPort((err, port) => {\n            // 试着找个可以用的port\n            this.options.clusterPort = port;\n            // 启动 agent\n            this.forkAgentWorker();\n        });\n        // ...\n    }\n    forkAgentWorker() {\n        // ... childprocess.fork egg-cluster/lib/agent_worker.js\n        const agentWorker = childprocess.fork(this.getAgentWorkerFile(), args, opt);\n        // ...\n    }\n    forkAppWorkers() {\n        // 将需要数量的 worker 一个个创建出来\n        // cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口\n        // 创建 http或https服务\n    }\n}\n```\n\nagent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发\"agent-start\"给父进程，触发Master的订阅创建Workers\n\n```js\n// egg-cluster/lib/agent_worker.js\n// ...\nprocess.send({ action: 'agent-start', to: 'master' }); \n// ...\n```\n\n### Agent-Works怎么通信呢? ([IPC](https://eggjs.org/zh-cn/core/cluster-and-ipc.html))\n\n- 在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例\n- EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例\n\n由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。\n\n```js\n// egg-cluster master.js\nclass Master extends EventEmitter {\n    forkAppWorkers() {\n        // ...\n        cluster.on('fork', worker => {\n            // ...\n            worker.on('message', msg => {\n            \tif (typeof msg === 'string') msg = { action: msg, data: msg };\n\t            msg.from = 'app';\n    \t        this.messenger.send(msg);\n            });\n            // ...\n        })\n    }\n    forkAgentWorker() {\n        // ...\n        agentWorker.on('message', msg => {\n          if (typeof msg === 'string') msg = { action: msg, data: msg };\n          msg.from = 'agent';\n          this.messenger.send(msg);\n        });\n        // ...\n    }\n}\n```\n\n```js\n// egg messenger.js\nclass Messenger extends EventEmitter {\n    send(action, data, to) {\n        sendmessage(process, {\n          action,\n          data,\n          to,\n        });\n        return this;\n     }\n}\n```\n\n一条信息必定有__from__...__to__...信息\n\n![Master-Agent-Works 通信模型](/images/egg-cluster/2.jpg)\n\n### 官网里提到的“[多进程研发模式增强](https://eggjs.org/zh-cn/advanced/cluster-client.html)”\n\n![一个程序运行n个worker连m个远程服务](/images/egg-cluster/3.jpg)\n\n- n * m 个连接导致大量连接资源“浪费”\n- 减少Master转发带来的额外性能消耗\n- 另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常\n\n所以还有一种socket通信方式（使用了另一个库[cluster-client](https://github.com/node-modules/cluster-client)）：\n\n- 将Agent作为Leader，从服务端获取数据，并做缓存\n- 将Worker作为Follower，订阅Agent获取的数据\n\n典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。\n\n![socket通信](/images/egg-cluster/4.jpg)\n\n### cluster-client 源码一瞥\n\n```js\nclass ClusterClient extends Base {\n    // ...\n    async [init]() {\n        const name = this.options.name;\n        const port = this.options.port;\n        let server;\n        if (this.options.isLeader === true) {\n          server = await ClusterServer.create(name, port);\n          if (!server) {\n            throw new Error(`create \"${name}\" leader failed, the port:${port} is occupied by other`);\n          }\n        } else if (this.options.isLeader === false) {\n          // wait for leader active\n          await ClusterServer.waitFor(port, this.options.maxWaitTime);\n        } else {\n          debug('[ClusterClient:%s] init cluster client, try to seize the leader on port:%d', name, port);\n          server = await ClusterServer.create(name, port);\n        }\n\n        if (server) {\n          this[innerClient] = new Leader(Object.assign({ server }, this.options));\n          debug('[ClusterClient:%s] has seized port %d, and serves as leader client.', name, port);\n        } else {\n          this[innerClient] = new Follower(this.options);\n          debug('[ClusterClient:%s] gives up seizing port %d, and serves as follower client.', name, port);\n        }\n        // ...\n    }\n}\n```\n\n- port数值就是上文开始处通过detectPort获取的clusterPort数值\n- 然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信\n- Leader获取数据触发publish，传给订阅的Follower中\n\ncluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。\n\n\n\n### __#总结__\n\nEgg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。","slug":"egg-cluster","published":1,"date":"2019-01-18T13:48:01.464Z","updated":"2019-01-18T19:30:11.959Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs675h0000el8qk0vovj6x","content":"<p>如果不清楚什么是Egg.js，希望能移步到它的<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\">官网</a>简单看下。另外说它是<strong>约定大于配置</strong>的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：</p>\n<blockquote>\n<p>1.提供基于 Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\">定制上层框架</a> 的能力<br>2.高度可扩展的<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\">插件机制</a><br>3.内置<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程管理</a><br>4.基于 <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> 开发，性能优异<br>5.框架稳定，测试覆盖率高<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\">渐进式开发</a></p>\n</blockquote>\n<p>第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？</p>\n<p>在我看来最吸引我的是第3条，<strong>内置多进程管理</strong>，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。</p>\n<a id=\"more\"></a>\n<h3 id=\"从源码慢慢了解\"><a href=\"#从源码慢慢了解\" class=\"headerlink\" title=\"#从源码慢慢了解\"></a><strong>#从源码慢慢了解</strong></h3><ul>\n<li><strong>egg-core</strong>: 定义了一个<strong>EggCore</strong>类，它继承KoaApplication，也就是特性中提到的第4条 <em>基于Koa开发，性能优异</em></li>\n<li><strong>egg</strong>: 定义了一个继承于EggCore的<strong>EggApplication</strong>类，并且Application和Agent分别继承于EggApplication</li>\n<li><strong>egg-cluster</strong>: 这个类库主要就是做<strong>多进程管理</strong>的工作</li>\n</ul>\n<p><em>egg-cluster让Egg.js变得与众不同</em>，看看它做了什么。</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster index.js 唯一对外暴露的接口 startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works 模型\"></p>\n<h3 id=\"Agent-Works怎么启动的？\"><a href=\"#Agent-Works怎么启动的？\" class=\"headerlink\" title=\"Agent-Works怎么启动的？\"></a>Agent-Works怎么启动的？</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// 试着找个可以用的port</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// 启动 agent</span></span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> agentWorker = childprocess.fork(<span class=\"hljs-keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// 将需要数量的 worker 一个个创建出来</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// 创建 http或https服务</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发”agent-start”给父进程，触发Master的订阅创建Workers</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works怎么通信呢-IPC\"><a href=\"#Agent-Works怎么通信呢-IPC\" class=\"headerlink\" title=\"Agent-Works怎么通信呢? (IPC)\"></a>Agent-Works怎么通信呢? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例</li>\n<li>EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例</li>\n</ul>\n<p>由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Messenger</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一条信息必定有<strong>from</strong>…<strong>to</strong>…信息</p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works 通信模型\"></p>\n<h3 id=\"官网里提到的“多进程研发模式增强”\"><a href=\"#官网里提到的“多进程研发模式增强”\" class=\"headerlink\" title=\"官网里提到的“多进程研发模式增强”\"></a>官网里提到的“<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程研发模式增强</a>”</h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"一个程序运行n个worker连m个远程服务\"></p>\n<ul>\n<li>n * m 个连接导致大量连接资源“浪费”</li>\n<li>减少Master转发带来的额外性能消耗</li>\n<li>另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常</li>\n</ul>\n<p>所以还有一种socket通信方式（使用了另一个库<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a>）：</p>\n<ul>\n<li>将Agent作为Leader，从服务端获取数据，并做缓存</li>\n<li>将Worker作为Follower，订阅Agent获取的数据</li>\n</ul>\n<p>典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket通信\"></p>\n<h3 id=\"cluster-client-源码一瞥\"><a href=\"#cluster-client-源码一瞥\" class=\"headerlink\" title=\"cluster-client 源码一瞥\"></a>cluster-client 源码一瞥</h3><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ClusterClient</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> name = <span class=\"hljs-keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> port = <span class=\"hljs-keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">`create \"<span class=\"hljs-subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"hljs-subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.options.isLeader === <span class=\"hljs-literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"hljs-comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"hljs-keyword\">await</span> ClusterServer.waitFor(port, <span class=\"hljs-keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"hljs-keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Leader(<span class=\"hljs-built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"hljs-keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">this</span>[innerClient] = <span class=\"hljs-keyword\">new</span> Follower(<span class=\"hljs-keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"hljs-string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>port数值就是上文开始处通过detectPort获取的clusterPort数值</li>\n<li>然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信</li>\n<li>Leader获取数据触发publish，传给订阅的Follower中</li>\n</ul>\n<p>cluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"#总结\"></a><strong>#总结</strong></h3><p>Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。</p>\n","site":{"data":{}},"_categories":[{"name":"javascript","path":"categories/javascript/"}],"_tags":[],"excerpt":"<p>如果不清楚什么是Egg.js，希望能移步到它的<a href=\"https://eggjs.org\" target=\"_blank\" rel=\"noopener\">官网</a>简单看下。另外说它是<strong>约定大于配置</strong>的话，我只能说你真的不了解它，或者说不了解框架，哪个框架没有约定？毕竟没有规矩不成方圆，何况是逻辑性的程序呢？官方列出的特性如下：</p>\n<blockquote>\n<p>1.提供基于 Egg <a href=\"https://eggjs.org/zh-cn/advanced/framework.html\" target=\"_blank\" rel=\"noopener\">定制上层框架</a> 的能力<br>2.高度可扩展的<a href=\"https://eggjs.org/zh-cn/basics/plugin.html\" target=\"_blank\" rel=\"noopener\">插件机制</a><br>3.内置<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程管理</a><br>4.基于 <a href=\"http://koajs.com/\" target=\"_blank\" rel=\"noopener\">Koa</a> 开发，性能优异<br>5.框架稳定，测试覆盖率高<br>6.<a href=\"https://eggjs.org/zh-cn/tutorials/progressive.html\" target=\"_blank\" rel=\"noopener\">渐进式开发</a></p>\n</blockquote>\n<p>第1条，它有那么Koa也有啊。第2条，它有，难道Koa、Express等就没有嘛？第4条，更好的补充了Koa不是更好吗？第5条，难道别的框架就不稳定了？第6条，前端鼓吹渐进式、后端也鼓吹，那究竟什么是渐进式呢？</p>\n<p>在我看来最吸引我的是第3条，<strong>内置多进程管理</strong>，这个在其它主流nodejs框架中是稀缺的特性，此文就简单聊聊它。</p>","more":"<h3 id=\"从源码慢慢了解\"><a href=\"#从源码慢慢了解\" class=\"headerlink\" title=\"#从源码慢慢了解\"></a><strong>#从源码慢慢了解</strong></h3><ul>\n<li><strong>egg-core</strong>: 定义了一个<strong>EggCore</strong>类，它继承KoaApplication，也就是特性中提到的第4条 <em>基于Koa开发，性能优异</em></li>\n<li><strong>egg</strong>: 定义了一个继承于EggCore的<strong>EggApplication</strong>类，并且Application和Agent分别继承于EggApplication</li>\n<li><strong>egg-cluster</strong>: 这个类库主要就是做<strong>多进程管理</strong>的工作</li>\n</ul>\n<p><em>egg-cluster让Egg.js变得与众不同</em>，看看它做了什么。</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a>egg-cluster</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster index.js 唯一对外暴露的接口 startCluster</span></span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>egg-cluster就是靠Master在管理egg里面的angent和workers（application）,另外它也是它们之间通信的中转站，看下官网给出的图解：<br><img src=\"/images/egg-cluster/1.jpg\" alt=\"Master-Agent-Works 模型\"></p>\n<h3 id=\"Agent-Works怎么启动的？\"><a href=\"#Agent-Works怎么启动的？\" class=\"headerlink\" title=\"Agent-Works怎么启动的？\"></a>Agent-Works怎么启动的？</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager();</span><br><span class=\"line\">    \t<span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>));</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 试着找个可以用的port</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.options.clusterPort = port;</span><br><span class=\"line\">            <span class=\"comment\">// 启动 agent</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.forkAgentWorker();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ... childprocess.fork egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> agentWorker = childprocess.fork(<span class=\"keyword\">this</span>.getAgentWorkerFile(), args, opt);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将需要数量的 worker 一个个创建出来</span></span><br><span class=\"line\">        <span class=\"comment\">// cluster.fork egg-cluster/lib/agent_worker.js 它们将监听同一个服务端口</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建 http或https服务</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>agent_worker.js主要逻辑就是创建egg类库里的Agent类，完成后发”agent-start”给父进程，触发Master的订阅创建Workers</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster/lib/agent_worker.js</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;); </span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Agent-Works怎么通信呢-IPC\"><a href=\"#Agent-Works怎么通信呢-IPC\" class=\"headerlink\" title=\"Agent-Works怎么通信呢? (IPC)\"></a>Agent-Works怎么通信呢? (<a href=\"https://eggjs.org/zh-cn/core/cluster-and-ipc.html\" target=\"_blank\" rel=\"noopener\">IPC</a>)</h3><ul>\n<li>在Master中维护着一个Messenger（egg-cluster/lib/utils/messenger.js）实例</li>\n<li>EggApplication中维护了另一个Messenger（egg/lib/core/messenger.js）实例</li>\n</ul>\n<p>由于Agent和Worker(Application)都继承EggApplication，它们调用Messenger的时候会send到创建它们的Master里，然后Master再根据传过来的参数send给不同的Agent或Worker，Master里的转发逻辑如下。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-cluster master.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    forkAppWorkers() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">            worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">            \t<span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">\t            msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">    \t        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    forkAgentWorker() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">        agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">          msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg messenger.js</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Messenger</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">    send(action, data, to) &#123;</span><br><span class=\"line\">        sendmessage(process, &#123;</span><br><span class=\"line\">          action,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          to,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一条信息必定有<strong>from</strong>…<strong>to</strong>…信息</p>\n<p><img src=\"/images/egg-cluster/2.jpg\" alt=\"Master-Agent-Works 通信模型\"></p>\n<h3 id=\"官网里提到的“多进程研发模式增强”\"><a href=\"#官网里提到的“多进程研发模式增强”\" class=\"headerlink\" title=\"官网里提到的“多进程研发模式增强”\"></a>官网里提到的“<a href=\"https://eggjs.org/zh-cn/advanced/cluster-client.html\" target=\"_blank\" rel=\"noopener\">多进程研发模式增强</a>”</h3><p><img src=\"/images/egg-cluster/3.jpg\" alt=\"一个程序运行n个worker连m个远程服务\"></p>\n<ul>\n<li>n * m 个连接导致大量连接资源“浪费”</li>\n<li>减少Master转发带来的额外性能消耗</li>\n<li>另外，egg的作者们担心不当的IPC通信把Master搞挂，从而整个服务异常</li>\n</ul>\n<p>所以还有一种socket通信方式（使用了另一个库<a href=\"https://github.com/node-modules/cluster-client\" target=\"_blank\" rel=\"noopener\">cluster-client</a>）：</p>\n<ul>\n<li>将Agent作为Leader，从服务端获取数据，并做缓存</li>\n<li>将Worker作为Follower，订阅Agent获取的数据</li>\n</ul>\n<p>典型的场景有，Leader（Agent）获取disconf里的配置、获取euerka里的服务等，Follower（Worker）使用这些配置和服务。</p>\n<p><img src=\"/images/egg-cluster/4.jpg\" alt=\"socket通信\"></p>\n<h3 id=\"cluster-client-源码一瞥\"><a href=\"#cluster-client-源码一瞥\" class=\"headerlink\" title=\"cluster-client 源码一瞥\"></a>cluster-client 源码一瞥</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ClusterClient</span> <span class=\"keyword\">extends</span> <span class=\"title\">Base</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> [init]() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> name = <span class=\"keyword\">this</span>.options.name;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> port = <span class=\"keyword\">this</span>.options.port;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!server) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">`create \"<span class=\"subst\">$&#123;name&#125;</span>\" leader failed, the port:<span class=\"subst\">$&#123;port&#125;</span> is occupied by other`</span>);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.options.isLeader === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// wait for leader active</span></span><br><span class=\"line\">          <span class=\"keyword\">await</span> ClusterServer.waitFor(port, <span class=\"keyword\">this</span>.options.maxWaitTime);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] init cluster client, try to seize the leader on port:%d'</span>, name, port);</span><br><span class=\"line\">          server = <span class=\"keyword\">await</span> ClusterServer.create(name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (server) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Leader(<span class=\"built_in\">Object</span>.assign(&#123; server &#125;, <span class=\"keyword\">this</span>.options));</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] has seized port %d, and serves as leader client.'</span>, name, port);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>[innerClient] = <span class=\"keyword\">new</span> Follower(<span class=\"keyword\">this</span>.options);</span><br><span class=\"line\">          debug(<span class=\"string\">'[ClusterClient:%s] gives up seizing port %d, and serves as follower client.'</span>, name, port);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>port数值就是上文开始处通过detectPort获取的clusterPort数值</li>\n<li>然后net.create 创建TCP服务，之后所有的Leader和Follower都会走它提供的服务进行socket通信</li>\n<li>Leader获取数据触发publish，传给订阅的Follower中</li>\n</ul>\n<p>cluster-client源码是很复杂的，中间还涉及到专递数据的格式，进行数据包的解析等等，这边就不扩展介绍了，有兴趣可以自己撸源码。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"#总结\"></a><strong>#总结</strong></h3><p>Egg.js的进程管理和通信自然不会像文章里说的那么简单，但大体如此。弄清楚它们的工作原理对开发程序、插件、中间件有很大的帮助，个人认为这个才是这个框架的精髓之处。</p>"},{"title":"出差菲律宾","date":"2018-09-24T06:45:00.000Z","_content":"入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。\n\n![准备起飞](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\n副本Loading三个半小时。\n\n![到达副本](/images/traveling-to-the-philippines/2.jpg)\n\n### 住和工\n\n到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。\n\nBGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。\n\n第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。\n\n![接下来几天躲在这会议室猥琐写代码别浪](/images/traveling-to-the-philippines/3.jpg)\n\n![蛮喜欢这灯](/images/traveling-to-the-philippines/4.jpg)\n\n![一角A](/images/traveling-to-the-philippines/7.jpg)\n\n![一角B](/images/traveling-to-the-philippines/8.jpg)\n\n![健身房](/images/traveling-to-the-philippines/6.jpg)\n\n![可以临时睡觉的地方](/images/traveling-to-the-philippines/9.jpg)\n\n### 吃\n\n菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。\n\n![鼎泰丰，中国风](/images/traveling-to-the-philippines/10.jpg)\n\n![厚实的汉堡A](/images/traveling-to-the-philippines/11.jpg)\n\n![厚实的汉堡B](/images/traveling-to-the-philippines/12.jpg)\n\n![厚实的汉堡C](/images/traveling-to-the-philippines/27.jpg)\n\n![油炸食品](/images/traveling-to-the-philippines/13.jpg)\n\n![网络咖啡店 「%」](/images/traveling-to-the-philippines/14.jpg)\n\n![五颜六色的水果](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 一公斤的三文鱼（人民币100不到）](/images/traveling-to-the-philippines/16.jpg)\n\n![一大袋才花了300不到Php](/images/traveling-to-the-philippines/17.jpg)\n\n因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。\n\n![海鲜市场](/images/traveling-to-the-philippines/19.jpg)\n\n![鱼](/images/traveling-to-the-philippines/21.jpg)\n\n![蟹，不同大小不同的价格](/images/traveling-to-the-philippines/20.jpg)\n\n![三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![成品A 不好吃](/images/traveling-to-the-philippines/23.jpg)\n\n![成品B 不好吃](/images/traveling-to-the-philippines/24.jpg)\n\n![成品C 不好吃](/images/traveling-to-the-philippines/25.jpg)\n\n![星爸爸 摩卡超大杯折合人民币才23不到，好便宜](/images/traveling-to-the-philippines/26.jpg)\n\n### 行\n\n对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。\n\n![不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这](/images/traveling-to-the-philippines/28.jpg)\n\n菲律宾特色*“吉普尼”*，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。\n\n![吉普尼A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![吉普尼B](/images/traveling-to-the-philippines/30.jpg)\n\n### 周边\n\n在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。\n\n谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。\n\n![干净的街道](/images/traveling-to-the-philippines/31.jpg)\n\n![安检](/images/traveling-to-the-philippines/34.jpg)\n\n![很多大楼门口的安保都有枪](/images/traveling-to-the-philippines/33.jpeg)\n\n![不像国内ATM机，这的机器都是全露天的，没有小房间](/images/traveling-to-the-philippines/32.jpg)\n\n\n## 总结\n\n原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！\n\n","source":"_posts/traveling-to-the-philippines.md","raw":"---\ntitle: 出差菲律宾\ncategory: 工作\ndate: 2018-09-24 14:45:00\n---\n入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。\n\n![准备起飞](/images/traveling-to-the-philippines/1.jpg)\n\n<!-- more -->\n\n副本Loading三个半小时。\n\n![到达副本](/images/traveling-to-the-philippines/2.jpg)\n\n### 住和工\n\n到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。\n\nBGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。\n\n第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。\n\n![接下来几天躲在这会议室猥琐写代码别浪](/images/traveling-to-the-philippines/3.jpg)\n\n![蛮喜欢这灯](/images/traveling-to-the-philippines/4.jpg)\n\n![一角A](/images/traveling-to-the-philippines/7.jpg)\n\n![一角B](/images/traveling-to-the-philippines/8.jpg)\n\n![健身房](/images/traveling-to-the-philippines/6.jpg)\n\n![可以临时睡觉的地方](/images/traveling-to-the-philippines/9.jpg)\n\n### 吃\n\n菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。\n\n![鼎泰丰，中国风](/images/traveling-to-the-philippines/10.jpg)\n\n![厚实的汉堡A](/images/traveling-to-the-philippines/11.jpg)\n\n![厚实的汉堡B](/images/traveling-to-the-philippines/12.jpg)\n\n![厚实的汉堡C](/images/traveling-to-the-philippines/27.jpg)\n\n![油炸食品](/images/traveling-to-the-philippines/13.jpg)\n\n![网络咖啡店 「%」](/images/traveling-to-the-philippines/14.jpg)\n\n![五颜六色的水果](/images/traveling-to-the-philippines/15.jpg)\n\n![712Php 一公斤的三文鱼（人民币100不到）](/images/traveling-to-the-philippines/16.jpg)\n\n![一大袋才花了300不到Php](/images/traveling-to-the-philippines/17.jpg)\n\n因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。\n\n![海鲜市场](/images/traveling-to-the-philippines/19.jpg)\n\n![鱼](/images/traveling-to-the-philippines/21.jpg)\n\n![蟹，不同大小不同的价格](/images/traveling-to-the-philippines/20.jpg)\n\n![三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T](/images/traveling-to-the-philippines/22.jpg)\n\n![成品A 不好吃](/images/traveling-to-the-philippines/23.jpg)\n\n![成品B 不好吃](/images/traveling-to-the-philippines/24.jpg)\n\n![成品C 不好吃](/images/traveling-to-the-philippines/25.jpg)\n\n![星爸爸 摩卡超大杯折合人民币才23不到，好便宜](/images/traveling-to-the-philippines/26.jpg)\n\n### 行\n\n对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。\n\n![不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这](/images/traveling-to-the-philippines/28.jpg)\n\n菲律宾特色*“吉普尼”*，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。\n\n![吉普尼A](/images/traveling-to-the-philippines/29.jpg)\n\n\n![吉普尼B](/images/traveling-to-the-philippines/30.jpg)\n\n### 周边\n\n在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。\n\n谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。\n\n![干净的街道](/images/traveling-to-the-philippines/31.jpg)\n\n![安检](/images/traveling-to-the-philippines/34.jpg)\n\n![很多大楼门口的安保都有枪](/images/traveling-to-the-philippines/33.jpeg)\n\n![不像国内ATM机，这的机器都是全露天的，没有小房间](/images/traveling-to-the-philippines/32.jpg)\n\n\n## 总结\n\n原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！\n\n","slug":"traveling-to-the-philippines","published":1,"updated":"2018-10-21T05:07:01.239Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs676r0003el8qvt1rqw4y","content":"<p>入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。</p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"准备起飞\"></p>\n<a id=\"more\"></a>\n<p>副本Loading三个半小时。</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"到达副本\"></p>\n<h3 id=\"住和工\"><a href=\"#住和工\" class=\"headerlink\" title=\"住和工\"></a>住和工</h3><p>到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。</p>\n<p>BGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。</p>\n<p>第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。</p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"接下来几天躲在这会议室猥琐写代码别浪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"蛮喜欢这灯\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"一角A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"一角B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"健身房\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"可以临时睡觉的地方\"></p>\n<h3 id=\"吃\"><a href=\"#吃\" class=\"headerlink\" title=\"吃\"></a>吃</h3><p>菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"鼎泰丰，中国风\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"厚实的汉堡A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"厚实的汉堡B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"厚实的汉堡C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"油炸食品\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\"网络咖啡店 「%」\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"五颜六色的水果\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 一公斤的三文鱼（人民币100不到）\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"一大袋才花了300不到Php\"></p>\n<p>因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"海鲜市场\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"鱼\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"蟹，不同大小不同的价格\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"成品A 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"成品B 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"成品C 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\"星爸爸 摩卡超大杯折合人民币才23不到，好便宜\"></p>\n<h3 id=\"行\"><a href=\"#行\" class=\"headerlink\" title=\"行\"></a>行</h3><p>对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这\"></p>\n<p>菲律宾特色<em>“吉普尼”</em>，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。</p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"吉普尼A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"吉普尼B\"></p>\n<h3 id=\"周边\"><a href=\"#周边\" class=\"headerlink\" title=\"周边\"></a>周边</h3><p>在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。</p>\n<p>谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。</p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"干净的街道\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"安检\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"很多大楼门口的安保都有枪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"不像国内ATM机，这的机器都是全露天的，没有小房间\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！</p>\n","site":{"data":{}},"_categories":[{"name":"工作","path":"categories/工作/"}],"_tags":[],"excerpt":"<p>入职没多久，因为菲律宾项目的版本更新，和一后端、一测试，三人组队前往当地打怪升级。</p>\n<p><img src=\"/images/traveling-to-the-philippines/1.jpg\" alt=\"准备起飞\"></p>","more":"<p>副本Loading三个半小时。</p>\n<p><img src=\"/images/traveling-to-the-philippines/2.jpg\" alt=\"到达副本\"></p>\n<h3 id=\"住和工\"><a href=\"#住和工\" class=\"headerlink\" title=\"住和工\"></a>住和工</h3><p>到达马尼拉的时候已经快晚上9点了，下飞机弄完电话卡连上网络，急忙打车去坐落在BGC的酒店——步行离公司5MIN，一个大套房3人住，好宽敞。</p>\n<p>BGC近年来发展很快，类似上海的陆家嘴，许多大型跨国公司变迁至此（如HSBC,Google等）。</p>\n<p>第二天，准时打开上班，新装修的办公室还是给人眼前一亮，大大小小的会议室、工作间、沙发、游戏室、健身房、食品吧台、甚至还有临时休息的房间。</p>\n<p><img src=\"/images/traveling-to-the-philippines/3.jpg\" alt=\"接下来几天躲在这会议室猥琐写代码别浪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/4.jpg\" alt=\"蛮喜欢这灯\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/7.jpg\" alt=\"一角A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/8.jpg\" alt=\"一角B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/6.jpg\" alt=\"健身房\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/9.jpg\" alt=\"可以临时睡觉的地方\"></p>\n<h3 id=\"吃\"><a href=\"#吃\" class=\"headerlink\" title=\"吃\"></a>吃</h3><p>菲律宾的餐饮感觉还是偏西餐的，油炸类的偏多，行程中吃的比较多；中餐的话基本是港式、台湾的为主，第一天晚上夜宵就是著名的鼎泰丰，味道不错。这边的水，大多是生水，国人也许喝不惯，一般在BGC一顿饭花费在1500Php左右，好一点的日料什么的那就更贵了。</p>\n<p><img src=\"/images/traveling-to-the-philippines/10.jpg\" alt=\"鼎泰丰，中国风\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/11.jpg\" alt=\"厚实的汉堡A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/12.jpg\" alt=\"厚实的汉堡B\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/27.jpg\" alt=\"厚实的汉堡C\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/13.jpg\" alt=\"油炸食品\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/14.jpg\" alt=\"网络咖啡店 「%」\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/15.jpg\" alt=\"五颜六色的水果\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/16.jpg\" alt=\"712Php 一公斤的三文鱼（人民币100不到）\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/17.jpg\" alt=\"一大袋才花了300不到Php\"></p>\n<p>因为回国航线有史诗级台风「山竹」经过，所以在菲律宾多待2天，有机会去海边逛逛随便去吃海鲜，我们去的市场感觉主要做国人生意，到处是中国人，东南亚的海鲜品种差不多，买的时候可以讨价还价。</p>\n<p><img src=\"/images/traveling-to-the-philippines/19.jpg\" alt=\"海鲜市场\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/21.jpg\" alt=\"鱼\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/20.jpg\" alt=\"蟹，不同大小不同的价格\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/22.jpg\" alt=\"三个男的对海鲜欲望不大，最后买了它，7000+ 还价到5500 其实还是贵了 T_T\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/23.jpg\" alt=\"成品A 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/24.jpg\" alt=\"成品B 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/25.jpg\" alt=\"成品C 不好吃\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/26.jpg\" alt=\"星爸爸 摩卡超大杯折合人民币才23不到，好便宜\"></p>\n<h3 id=\"行\"><a href=\"#行\" class=\"headerlink\" title=\"行\"></a>行</h3><p>对于我们这些初来乍到的，还是出租车比较靠谱，机场出来还是黄色（貌似机场特有）的出租车比较靠谱，虽然贵但是没发生坐地起价或者绕路等问题，之前同事来坐白色出租车虽然起步便宜但是最后付钱的时候比我们贵很多。或者用Grab打车（类似滴滴打车），价格合理。</p>\n<p><img src=\"/images/traveling-to-the-philippines/28.jpg\" alt=\"不知道是巧合还是当地出租车运行要求，灭火器放在左A柱这\"></p>\n<p>菲律宾特色<em>“吉普尼”</em>，五颜六色装饰夸张，是与黑色伦敦出租车和黄色纽约出租车齐名的交通工具，可惜没乘坐。</p>\n<p><img src=\"/images/traveling-to-the-philippines/29.jpg\" alt=\"吉普尼A\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/30.jpg\" alt=\"吉普尼B\"></p>\n<h3 id=\"周边\"><a href=\"#周边\" class=\"headerlink\" title=\"周边\"></a>周边</h3><p>在BGC的时候感觉道路很干净，路上没有什么垃圾，甚至找个垃圾桶都很难，常常领着一袋垃圾从A处到B处目的地才有垃圾桶扔，路上没看到有人抽烟等；去之前很担心安全问题，国内常有报道，到那里后感觉很多时候没必要过于担心。</p>\n<p>谈不上安保能力多强，平时的安检还是很多的，进大楼、酒店、商场都有安检，类似上海地铁安检吧，机器扫描或者人工打开包看，人工看的话基本都是带手套或者用一个小木棍，避免直接与物品直接接触，避免不必要的麻烦。几天下来没有谁不做检查的，不像地铁安检经常有人不愿意或者争执，其实无论在菲律宾还是国内，安检只是防君子不防小人的（和门一样），但是它也是一道保护大家的屏障，所以我们应该尊重它，而不是敌对它。</p>\n<p><img src=\"/images/traveling-to-the-philippines/31.jpg\" alt=\"干净的街道\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/34.jpg\" alt=\"安检\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/33.jpeg\" alt=\"很多大楼门口的安保都有枪\"></p>\n<p><img src=\"/images/traveling-to-the-philippines/32.jpg\" alt=\"不像国内ATM机，这的机器都是全露天的，没有小房间\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>原本出差7天，后拜台风“山竹”所赐，多待了2天，得以有机会去海边或者更多地方逛逛。整体给我的感觉很不错，物价和上海总体差不多，若不是语言的不同，很多时候感觉自己是生活在魔都，当然天气也会常常提醒你:)。期待下次再去！</p>"},{"title":"一家公司的好坏，先看HR部门","date":"2018-07-20T09:01:34.000Z","_content":"**面对茫茫的公司，如何去判断一家公司是否靠谱呢？**\n\n除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？\n\n1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。\n\n2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。\n\n3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。\n\nHR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！\n<!-- more -->\n**一些小经历**\n\n- 记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。\n- 前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。\n- 有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。\n- 电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。\n\n**面试别不耐烦，多与不同人聊是好事，也是学习**\n\n聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。\n\n有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。\n\n\n\n**总结**\n\n一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。","source":"_posts/the-quality-of-a-company-first-look-at-HR-department.md","raw":"---\ntitle: 一家公司的好坏，先看HR部门\ncategory: 工作\ndate: 2018-07-20 17:01:34\n---\n**面对茫茫的公司，如何去判断一家公司是否靠谱呢？**\n\n除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？\n\n1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。\n\n2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。\n\n3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。\n\nHR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！\n<!-- more -->\n**一些小经历**\n\n- 记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。\n- 前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。\n- 有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。\n- 电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。\n\n**面试别不耐烦，多与不同人聊是好事，也是学习**\n\n聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。\n\n有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。\n\n\n\n**总结**\n\n一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。","slug":"the-quality-of-a-company-first-look-at-HR-department","published":1,"updated":"2018-10-19T06:24:07.636Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs67770004el8qkuogertn","content":"<p><strong>面对茫茫的公司，如何去判断一家公司是否靠谱呢？</strong></p>\n<p>除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？</p>\n<p>1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。</p>\n<p>2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。</p>\n<p>3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。</p>\n<p>HR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！<br><a id=\"more\"></a><br><strong>一些小经历</strong></p>\n<ul>\n<li>记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。</li>\n<li>前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。</li>\n<li>有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。</li>\n<li>电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。</li>\n</ul>\n<p><strong>面试别不耐烦，多与不同人聊是好事，也是学习</strong></p>\n<p>聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。</p>\n<p>有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。</p>\n<p><strong>总结</strong></p>\n<p>一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。</p>\n","site":{"data":{}},"_categories":[{"name":"工作","path":"categories/工作/"}],"_tags":[],"excerpt":"<p><strong>面对茫茫的公司，如何去判断一家公司是否靠谱呢？</strong></p>\n<p>除非你关注一家公司很久了或有内线，不然光从面试过程中你真的很难说这家公司好与坏。我会比较看重HR部门，为什么？</p>\n<p>1.我老婆就是资深HR，深知这个部门的重要性，和被忽视性。</p>\n<p>2.如果整个面试沟通过程中，HR部门显得很薄弱，说明该公司的组织架构不清晰，处于混沌阶段，有风险。</p>\n<p>3.如果HR部门的素质不够，那么入职了，我也觉得后续会有麻烦，比如交金、请假等等的沟通也比较头疼。</p>\n<p>HR需要情商智商双在线，如果一家公司拥有这样的HR说明它重视这个部门，为看似不赚钱的部门买了不少单，说明公司盈利或者业务稳定。就如，肚子饿了，只要能填饱肚子基本什么都会吃（精力只有在业务赚钱上），而真的去吃山珍海味说明有钱（会有精力把其它相关部门做好）。好的HR是对公司和员工的双保险！<br></p>","more":"<br><strong>一些小经历</strong></p>\n<ul>\n<li>记得很多年前，手上同时拿到了盛大创新院和某社交平台的offer，该平台HR电话问我意向，我说我去创新院，她接着问我地址，我说在浦东软件园（入职的项目组正好从总部搬出来）。这HR就很嘲讽的语气说盛大在张江怎么在什么软件园呢，一顿巴拉巴拉。从此之后该社交平台我就再也不用了，确实这几年这平台不怎么样了。</li>\n<li>前几天去某中型公司（两、三百号人左右），技术上方向不太符合，HR都没把我送出门，我从很内部的会议室自己摸索着出门，从中感受出该公司的冷漠。</li>\n<li>有时候HR太高冷了，毕竟不是聊技术有话题，又是伤感情的薪酬环节，不知道怎么聊了，之前聊得再愉快到了这戛然而止。</li>\n<li>电话通知我拿到offer了，但是电话那头先把我贬下，然后提出薪资结构等等。既然我不好，为什么给我offer呢？此地无银三百两的告诉我你要我去，但要压我价嘛。其实很多时候既然能谈到这部基本双方都有意向了，薪资是一方面，还有其他，避重就轻的说点吸引人的东西，不是更好，增加砝码吗？一个HR在多次和面试者沟通后，还不知道面试者除了薪资还想要什么，那么是失败的。</li>\n</ul>\n<p><strong>面试别不耐烦，多与不同人聊是好事，也是学习</strong></p>\n<p>聊得人越多，你越能知道公司和团队的素质，是否和自己匹配。</p>\n<p>有些面试官做技术做产品太久了，不太和陌生人打交道，说的话、问的问题常常情商不在线，给我的感觉就是要花很长时间和团队磨合，一般自己心里会亮起警报。</p>\n<p><strong>总结</strong></p>\n<p>一场愉快的面试，是双方的尊重。面试者答应了就该准时出席，把自己所知所想告诉对方，自我的梳理和反思；面试官面了就该好好对待，可以从被面试者身上学到新的思维维度，把公司团队的产品介绍下，也算是一种推广。人与人相处，尤其是陌生人相处是需要有礼节的，你永远不知道坐在你对面的人，他背后有什么样的能量。</p>"},{"title":"CSS、JS文件对网页的影响","_content":"\n我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。\n\n<!-- more -->\n\n## 环境\n\n*所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同*\n\n-- css\n  - css1.css 2秒后返回 body { background-color: #444 }\n  - css2.css 立即返回 body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1秒后返回 console.log(\"js1.js loaded\") \n  - js2.js 立即返回 console.log(\"js2.js loaded\")\n  - js3.js 3秒后返回 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3秒后 返回一张黄色js图片\n  - img2.png 立即返回一张 nodejs图片\n\n\n服务器端代码：\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n## 实验一： CSS加载是否影响DOM解析\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\napp元素对象\ntest: 1947.620849609375ms\n-->\n```\n\n从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见__CSS加载并不会阻碍DOM解析__。\n\n## 实验二： CSS加载是否影响JS执行和DOM渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\n当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。\n\n从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见__CSS加载会阻碍JS执行和DOM的渲染__。\n\n## 实验三： JS加载是否影响DOM解析和渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\n我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见__JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了__。\n\n## 实验四： DOM的DOMContentLoaded和onLoad事件\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知__DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）__。\n\n## 实验五： script async 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- app元素对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n之后我们将js1.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- testDOMContentLoaded 1秒左右时间\n- js2.js loaded\n- js3.js loaded\n\n之后我们将js3.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析__\n\n## 实验六： script defer 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3个js文件都加上\"defer\",会发现输出顺序是\n\n- app元素对象\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js1.js上的\"defer\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js3.js上的\"defer\"移除，会发现输出顺序是\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析__\n\n## 实验七： script defer & async 都加上 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasync优先级比defer高\n\n## 实验八： 动态创建script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded 会立即打印出来\n- appEl 对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl 为 null 立即打印出来\n- js3.js loaded \n- testDOMContentLoaded 3秒左右会立即打印出来\n- js2.js loaded\n- js1.js loaded\n\n可见__动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件__\n\n\n## 总结\nCSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer & async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行","source":"_posts/js-css-image-loading.md","raw":"---\ntitle: CSS、JS文件对网页的影响\ncategory: javascript\n---\n\n我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。\n\n<!-- more -->\n\n## 环境\n\n*所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同*\n\n-- css\n  - css1.css 2秒后返回 body { background-color: #444 }\n  - css2.css 立即返回 body { font-size: 50px;font-weight: bold; }\n\n-- js\n  - js1.js 1秒后返回 console.log(\"js1.js loaded\") \n  - js2.js 立即返回 console.log(\"js2.js loaded\")\n  - js3.js 3秒后返回 console.log(\"js2.js loaded\")\n\n-- image\n  - img1.png 3秒后 返回一张黄色js图片\n  - img2.png 立即返回一张 nodejs图片\n\n\n服务器端代码：\n\n```js\nconst Koa = require('koa')\nconst Router = require('koa-router')\nconst views = require('koa-views')\nconst fs = require('fs')\n\nconst app = new Koa()\nconst router = new Router()\n\napp.use(views(__dirname + '/views'))\n\nrouter.get('/', async (ctx, next) => {\n  await ctx.render('index.html')\n})\n\nrouter.get('/css1.css', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'text/css')\n    ctx.body = 'body { background-color: #444 }'\n    resolve()\n  }, 1000 * 2)\n}))\n\nrouter.get('/css2.css', async ctx => {\n  ctx.set('Content-Type', 'text/css')\n  ctx.body = 'body { font-size: 50px;font-weight: bold; }'\n})\n\nrouter.get('/js1.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js1.js loaded\")'\n    resolve()\n  }, 1000)\n}))\n\nrouter.get('/js2.js', async ctx => {\n  ctx.body = 'console.log(\"js2.js loaded\")'\n})\n\nrouter.get('/js3.js', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.body = 'console.log(\"js3.js loaded\")'\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img1.png', async ctx => new Promise(resolve => {\n  setTimeout(function () {\n    ctx.set('Content-Type', 'image/png; charset=UTF-8')\n    ctx.body = fs.createReadStream('1.png')\n    resolve()\n  }, 1000 * 3)\n}))\n\nrouter.get('/img2.png', async ctx => {\n  ctx.set('Content-Type', 'image/png; charset=UTF-8')\n  ctx.body = fs.createReadStream('2.png')\n})\n\napp\n  .use(router.routes())\n  .use(router.allowedMethods())\n\napp.listen(3000)\n```\n\n## 实验一： CSS加载是否影响DOM解析\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\napp元素对象\ntest: 1947.620849609375ms\n-->\n```\n\n从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见__CSS加载并不会阻碍DOM解析__。\n\n## 实验二： CSS加载是否影响JS执行和DOM渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\n(index):17 test: 1921.02099609375ms\n-->\n```\n\n当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。\n\n从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见__CSS加载会阻碍JS执行和DOM的渲染__。\n\n## 实验三： JS加载是否影响DOM解析和渲染\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\nnull\njs3.js loaded\ntest: 2943.9951171875ms\n-->\n```\n\n我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见__JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了__。\n\n## 实验四： DOM的DOMContentLoaded和onLoad事件\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('test')\n    console.time('testDOMContentLoaded')\n    console.time('testonload')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n    window.onload = function () {\n      console.timeEnd('testonload')\n    }\n  </script>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css1.css\" />\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css2.css\" />\n  <script type=\"text/javascript\" src=\"/js1.js\"></script>\n\t<script type=\"text/javascript\" src=\"/js2.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n  <img style=\"width: 100px\" src=\"/img1.png\" />\n  <img style=\"width: 100px\" src=\"/img2.png\" />\n</body>\n<script type=\"text/javascript\">\n  console.timeEnd('test')\n</script>\n</html>\n\n<!-- console 输出\njs1.js loaded\njs2.js loaded\ntest: 1955.489990234375ms\ntestDOMContentLoaded: 1956.044189453125ms\ntestonload: 2964.078857421875ms\n-->\n```\n\n我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知__DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）__。\n\n## 实验五： script async 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script async type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- app元素对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n之后我们将js1.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- testDOMContentLoaded 1秒左右时间\n- js2.js loaded\n- js3.js loaded\n\n之后我们将js3.js上的\"async\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析__\n\n## 实验六： script defer 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n\t<title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script type=\"text/javascript\">\n    setTimeout(function() {\n      const el = document.getElementById('app')\n      console.log(el)\n    }, 0)\n  </script>\n  <script defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n\t<div id=\"app\">hello world</div>\n</body>\n</html>\n\n```\n\n3个js文件都加上\"defer\",会发现输出顺序是\n\n- app元素对象\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js1.js上的\"defer\"移除，会发现输出顺序是\n\n- el 为 null\n- js1.js loaded\n- js2.js loaded\n- js3.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n这和没有加defer和async时一样\n\n之后我们将js3.js上的\"defer\"移除，会发现输出顺序是\n- js1.js loaded\n- js3.js loaded\n- js2.js loaded\n- testDOMContentLoaded 3秒左右时间\n\n可见__defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析__\n\n## 实验七： script defer & async 都加上 属性\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n  </script>\n  <script async defer type=\"text/javascript\" src=\"/js1.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js2.js\"></script>\n  <script async defer type=\"text/javascript\" src=\"/js3.js\"></script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n\n3个js文件都加上\"async\",会发现输出顺序是\n- testDOMContentLoaded 会立即打印出来\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\nasync优先级比defer高\n\n## 实验八： 动态创建script\n\nindex.html\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 3; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- testDOMContentLoaded 会立即打印出来\n- appEl 对象\n- js2.js loaded\n- js1.js loaded\n- js3.js loaded\n\n如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话\n\nindex.html\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title></title>\n  <script type=\"text/javascript\">\n    console.time('testDOMContentLoaded')\n  </script>\n  <script type=\"text/javascript\">\n    document.addEventListener('DOMContentLoaded', function () {\n      console.timeEnd('testDOMContentLoaded')\n    }, false)\n\n    setTimeout(function () {\n       var appEl = document.getElementById('app')\n       console.log(appEl)\n    }, 0)\n  </script>\n  <script type=\"text/javascript\" src=\"js3.js\"></script>\n  <script type=\"text/javascript\">\n    var head = document.getElementsByTagName('head')[0]\n    for (var i = 0; i < 2; i++) {\n      var script = document.createElement('script')\n      script.type = 'text/javascript'\n      script.src = 'js' + (i + 1) + '.js'\n      head.appendChild(script)\n    }\n  </script>\n</head>\n<body>\n  <div id=\"app\">hello world</div>\n</body>\n</html>\n```\n- appEl 为 null 立即打印出来\n- js3.js loaded \n- testDOMContentLoaded 3秒左右会立即打印出来\n- js2.js loaded\n- js1.js loaded\n\n可见__动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件__\n\n\n## 总结\nCSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer & async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行","slug":"js-css-image-loading","published":1,"date":"2018-09-30T10:18:33.475Z","updated":"2019-01-18T13:48:22.030Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs67aq000cel8qw5yh1krc","content":"<p>我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。</p>\n<a id=\"more\"></a>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p><em>所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同</em></p>\n<p>– css</p>\n<ul>\n<li>css1.css 2秒后返回 body { background-color: #444 }</li>\n<li>css2.css 立即返回 body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p>– js</p>\n<ul>\n<li>js1.js 1秒后返回 console.log(“js1.js loaded”) </li>\n<li>js2.js 立即返回 console.log(“js2.js loaded”)</li>\n<li>js3.js 3秒后返回 console.log(“js2.js loaded”)</li>\n</ul>\n<p>– image</p>\n<ul>\n<li>img1.png 3秒后 返回一张黄色js图片</li>\n<li>img2.png 立即返回一张 nodejs图片</li>\n</ul>\n<p>服务器端代码：</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> Koa = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Router = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> views = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> fs = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> router = <span class=\"hljs-keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"hljs-string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/'</span>, <span class=\"hljs-keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">await</span> ctx.render(<span class=\"hljs-string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css1.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/css2.css'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js1.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js2.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"hljs-string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/js3.js'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"hljs-string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img1.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"hljs-string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"hljs-string\">'/img2.png'</span>, <span class=\"hljs-keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"hljs-string\">'Content-Type'</span>, <span class=\"hljs-string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"hljs-string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"hljs-number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"实验一：-CSS加载是否影响DOM解析\"><a href=\"#实验一：-CSS加载是否影响DOM解析\" class=\"headerlink\" title=\"实验一： CSS加载是否影响DOM解析\"></a>实验一： CSS加载是否影响DOM解析</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">app元素对象</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见<strong>CSS加载并不会阻碍DOM解析</strong>。</p>\n<h2 id=\"实验二：-CSS加载是否影响JS执行和DOM渲染\"><a href=\"#实验二：-CSS加载是否影响JS执行和DOM渲染\" class=\"headerlink\" title=\"实验二： CSS加载是否影响JS执行和DOM渲染\"></a>实验二： CSS加载是否影响JS执行和DOM渲染</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。</p>\n<p>从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见<strong>CSS加载会阻碍JS执行和DOM的渲染</strong>。</p>\n<h2 id=\"实验三：-JS加载是否影响DOM解析和渲染\"><a href=\"#实验三：-JS加载是否影响DOM解析和渲染\" class=\"headerlink\" title=\"实验三： JS加载是否影响DOM解析和渲染\"></a>实验三： JS加载是否影响DOM解析和渲染</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">null</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见<strong>JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了</strong>。</p>\n<h2 id=\"实验四：-DOM的DOMContentLoaded和onLoad事件\"><a href=\"#实验四：-DOM的DOMContentLoaded和onLoad事件\" class=\"headerlink\" title=\"实验四： DOM的DOMContentLoaded和onLoad事件\"></a>实验四： DOM的DOMContentLoaded和onLoad事件</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">window</span>.onload = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">\"width: 100px\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"hljs-comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"hljs-comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知<strong>DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）</strong>。</p>\n<h2 id=\"实验五：-script-async-属性\"><a href=\"#实验五：-script-async-属性\" class=\"headerlink\" title=\"实验五： script async 属性\"></a>实验五： script async 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>app元素对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js1.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1秒左右时间</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js3.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验六：-script-defer-属性\"><a href=\"#实验六：-script-defer-属性\" class=\"headerlink\" title=\"实验六： script defer 属性\"></a>实验六： script defer 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">const</span> el = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”defer”,会发现输出顺序是</p>\n<ul>\n<li>app元素对象</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js1.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js3.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验七：-script-defer-amp-async-都加上-属性\"><a href=\"#实验七：-script-defer-amp-async-都加上-属性\" class=\"headerlink\" title=\"实验七： script defer &amp; async 都加上 属性\"></a>实验七： script defer &amp; async 都加上 属性</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js1.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js2.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">async</span> <span class=\"hljs-attr\">defer</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>async优先级比defer高</p>\n<h2 id=\"实验八：-动态创建script\"><a href=\"#实验八：-动态创建script\" class=\"headerlink\" title=\"实验八： 动态创建script\"></a>实验八： 动态创建script</h2><p>index.html</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span> head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span> script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>appEl 对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话</p>\n<p>index.html<br><figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.time(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">'DOMContentLoaded'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.timeEnd(<span class=\"hljs-string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    &#125;, <span class=\"hljs-literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-keyword\">var</span> appEl = <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">       <span class=\"hljs-built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"js3.js\"</span>&gt;</span><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">var</span> head = <span class=\"hljs-built_in\">document</span>.getElementsByTagName(<span class=\"hljs-string\">'head'</span>)[<span class=\"hljs-number\">0</span>]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">var</span> script = <span class=\"hljs-built_in\">document</span>.createElement(<span class=\"hljs-string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.type = <span class=\"hljs-string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      script.src = <span class=\"hljs-string\">'js'</span> + (i + <span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"app\"</span>&gt;</span>hello world<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl 为 null 立即打印出来</li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3秒左右会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>可见<strong>动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>CSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer &amp; async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行</p>\n","site":{"data":{}},"_categories":[{"name":"javascript","path":"categories/javascript/"}],"_tags":[],"excerpt":"<p>我们常说浏览器是单线程的，那么我们在加载资源的时候页面是在等待加载完成呢？还是继续执行后续的操作？加载不同资源对浏览器的操作会有相同响应吗？我们可以通过一个一个简单的实验测试来了解。</p>","more":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p><em>所有资源均在localhost，浏览器chrome 69，不同浏览器或版本会有少许不同</em></p>\n<p>– css</p>\n<ul>\n<li>css1.css 2秒后返回 body { background-color: #444 }</li>\n<li>css2.css 立即返回 body { font-size: 50px;font-weight: bold; }</li>\n</ul>\n<p>– js</p>\n<ul>\n<li>js1.js 1秒后返回 console.log(“js1.js loaded”) </li>\n<li>js2.js 立即返回 console.log(“js2.js loaded”)</li>\n<li>js3.js 3秒后返回 console.log(“js2.js loaded”)</li>\n</ul>\n<p>– image</p>\n<ul>\n<li>img1.png 3秒后 返回一张黄色js图片</li>\n<li>img2.png 立即返回一张 nodejs图片</li>\n</ul>\n<p>服务器端代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Koa = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> views = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-views'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Koa()</span><br><span class=\"line\"><span class=\"keyword\">const</span> router = <span class=\"keyword\">new</span> Router()</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(views(__dirname + <span class=\"string\">'/views'</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/'</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">await</span> ctx.render(<span class=\"string\">'index.html'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css1.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'body &#123; background-color: #444 &#125;'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">2</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/css2.css'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/css'</span>)</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'body &#123; font-size: 50px;font-weight: bold; &#125;'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js1.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js1.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js2.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.body = <span class=\"string\">'console.log(\"js2.js loaded\")'</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/js3.js'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.body = <span class=\"string\">'console.log(\"js3.js loaded\")'</span></span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img1.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">    ctx.body = fs.createReadStream(<span class=\"string\">'1.png'</span>)</span><br><span class=\"line\">    resolve()</span><br><span class=\"line\">  &#125;, <span class=\"number\">1000</span> * <span class=\"number\">3</span>)</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">router.get(<span class=\"string\">'/img2.png'</span>, <span class=\"keyword\">async</span> ctx =&gt; &#123;</span><br><span class=\"line\">  ctx.set(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'image/png; charset=UTF-8'</span>)</span><br><span class=\"line\">  ctx.body = fs.createReadStream(<span class=\"string\">'2.png'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app</span><br><span class=\"line\">  .use(router.routes())</span><br><span class=\"line\">  .use(router.allowedMethods())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">3000</span>)</span><br></pre></td></tr></table></figure>\n<h2 id=\"实验一：-CSS加载是否影响DOM解析\"><a href=\"#实验一：-CSS加载是否影响DOM解析\" class=\"headerlink\" title=\"实验一： CSS加载是否影响DOM解析\"></a>实验一： CSS加载是否影响DOM解析</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">app元素对象</span></span><br><span class=\"line\"><span class=\"comment\">test: 1947.620849609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>从控制台的输出可以看到 app 元素会被正确输出，2秒左右再输出 test 的时间，可见<strong>CSS加载并不会阻碍DOM解析</strong>。</p>\n<h2 id=\"实验二：-CSS加载是否影响JS执行和DOM渲染\"><a href=\"#实验二：-CSS加载是否影响JS执行和DOM渲染\" class=\"headerlink\" title=\"实验二： CSS加载是否影响JS执行和DOM渲染\"></a>实验二： CSS加载是否影响JS执行和DOM渲染</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">(index):17 test: 1921.02099609375ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当打开index.html页面后，会发现所有资源均同时发起了请求，页面会先处于白屏加载状态（DOM无法渲染），当2秒（左右）后页面除img1.png未渲染外，其它样式和图片均渲染。</p>\n<p>从控制台的输出可以看出，虽然js比css快1秒左右加载完毕，但是此刻是处于阻塞状态并没有执行，当css加载完成后，才从上至下的执行（虽然js2.js比js1.js早加载好，但是执行的时候还是从上至下的），当css1.css加载完成后，页面立即渲染，图片img1.png晚1秒左右显示。可见<strong>CSS加载会阻碍JS执行和DOM的渲染</strong>。</p>\n<h2 id=\"实验三：-JS加载是否影响DOM解析和渲染\"><a href=\"#实验三：-JS加载是否影响DOM解析和渲染\" class=\"headerlink\" title=\"实验三： JS加载是否影响DOM解析和渲染\"></a>实验三： JS加载是否影响DOM解析和渲染</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">null</span></span><br><span class=\"line\"><span class=\"comment\">js3.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 2943.9951171875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们仅引入一个js3.js文件，设置它的返回时间为3秒，从控制台的输出可以看到 app 元素没有被正确输出（输出null），3秒左右再输出 test 的时间，可见<strong>JS加载会阻碍DOM解析，既然解析都被影响自然必定影响渲染了</strong>。</p>\n<h2 id=\"实验四：-DOM的DOMContentLoaded和onLoad事件\"><a href=\"#实验四：-DOM的DOMContentLoaded和onLoad事件\" class=\"headerlink\" title=\"实验四： DOM的DOMContentLoaded和onLoad事件\"></a>实验四： DOM的DOMContentLoaded和onLoad事件</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testonload'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css1.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"/css2.css\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img1.png\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">style</span>=<span class=\"string\">\"width: 100px\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/img2.png\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'test'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- console 输出</span></span><br><span class=\"line\"><span class=\"comment\">js1.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">js2.js loaded</span></span><br><span class=\"line\"><span class=\"comment\">test: 1955.489990234375ms</span></span><br><span class=\"line\"><span class=\"comment\">testDOMContentLoaded: 1956.044189453125ms</span></span><br><span class=\"line\"><span class=\"comment\">testonload: 2964.078857421875ms</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们通过控制台会发现 testDOMContentLoaded 会在2秒左右打印出来，testonload会在3秒左右打印出来，由此可知<strong>DOMContentLoaded是js和css文件的加载后触发，onload是整个页面所有资源加载完后触发（比如图片等）</strong>。</p>\n<h2 id=\"实验五：-script-async-属性\"><a href=\"#实验五：-script-async-属性\" class=\"headerlink\" title=\"实验五： script async 属性\"></a>实验五： script async 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>app元素对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js1.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>testDOMContentLoaded 1秒左右时间</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>之后我们将js3.js上的”async”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>async会打乱js的执行顺序，有async的js文件哪个先加载完哪个先执行，DOMContentLoaded的触发时间不在和async有关系，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验六：-script-defer-属性\"><a href=\"#实验六：-script-defer-属性\" class=\"headerlink\" title=\"实验六： script defer 属性\"></a>实验六： script defer 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">const</span> el = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(el)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”defer”,会发现输出顺序是</p>\n<ul>\n<li>app元素对象</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js1.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>el 为 null</li>\n<li>js1.js loaded</li>\n<li>js2.js loaded</li>\n<li>js3.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>这和没有加defer和async时一样</p>\n<p>之后我们将js3.js上的”defer”移除，会发现输出顺序是</p>\n<ul>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n<li>js2.js loaded</li>\n<li>testDOMContentLoaded 3秒左右时间</li>\n</ul>\n<p>可见<strong>defer会打乱js的执行顺序，有defer的js文件会晚于没有的，但是它们（含有defer）依旧保持从上而下依次执行，DOMContentLoaded的触发时间晚于defer，不会影响页面的渲染和解析</strong></p>\n<h2 id=\"实验七：-script-defer-amp-async-都加上-属性\"><a href=\"#实验七：-script-defer-amp-async-都加上-属性\" class=\"headerlink\" title=\"实验七： script defer &amp; async 都加上 属性\"></a>实验七： script defer &amp; async 都加上 属性</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js1.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js2.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">defer</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3个js文件都加上”async”,会发现输出顺序是</p>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>async优先级比defer高</p>\n<h2 id=\"实验八：-动态创建script\"><a href=\"#实验八：-动态创建script\" class=\"headerlink\" title=\"实验八： 动态创建script\"></a>实验八： 动态创建script</h2><p>index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>testDOMContentLoaded 会立即打印出来</li>\n<li>appEl 对象</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n<li>js3.js loaded</li>\n</ul>\n<p>如果我们动态创建js1.js和js2.js，将js3.js依旧按照常规写法写在页面中的话</p>\n<p>index.html<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.time(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'DOMContentLoaded'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.timeEnd(<span class=\"string\">'testDOMContentLoaded'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">    &#125;, <span class=\"literal\">false</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"keyword\">var</span> appEl = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'app'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">       <span class=\"built_in\">console</span>.log(appEl)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 0)</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"js3.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> head = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">'head'</span>)[<span class=\"number\">0</span>]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      script.type = <span class=\"string\">'text/javascript'</span></span></span><br><span class=\"line\"><span class=\"javascript\">      script.src = <span class=\"string\">'js'</span> + (i + <span class=\"number\">1</span>) + <span class=\"string\">'.js'</span></span></span><br><span class=\"line\"><span class=\"undefined\">      head.appendChild(script)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span>hello world<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>appEl 为 null 立即打印出来</li>\n<li>js3.js loaded </li>\n<li>testDOMContentLoaded 3秒左右会立即打印出来</li>\n<li>js2.js loaded</li>\n<li>js1.js loaded</li>\n</ul>\n<p>可见<strong>动态创建script基本是同时加载，哪个先加载完哪个先执行，但是他们都晚于DOMContentLoaded事件</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>CSS加载会阻塞DOM渲染和JS执行，但是不影响页DOM解析；JS加载会阻塞DOM解析和渲染，给script标签加上defer &amp; async属性将不再影响DOM解析和渲染，async 是哪个先返回先执行按个，defer会晚于常规标签同时按照含有defer属性的script加载的顺序执行</p>"},{"title":"Vue Component 继承与复用","date":"2018-11-17T06:45:00.000Z","_content":"在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？\n\n答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以[Vue](https://vuejs.org/)为例，看看怎么去做继承这件事情。\n\n<!-- more -->\n\n### 需求描述\n\n简单实现2个列表页面，一个是管理员列表、一个用户列表\n\n![图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、\"修改\"操作按钮](/images/vue-component-extends/1.jpg)\n\n![图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、\"删除\"操作按钮](/images/vue-component-extends/2.jpg)\n\n从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。\n![图三 简单的继承图](/images/vue-component-extends/3.jpg)\n\n### 环境\n\n- Vue 版本 2.5\n\n- [Element-UI](http://element.eleme.io/) （仅仅使得Demo看上去不那么丑）\n\n- [测试代码](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### 步骤\n\n通过vue cli工具创建项目\n```js\nvue create vue-component-extedns\n```\n\n此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改\n\n\n__引入Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\n在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue\n\n*下面代码很多可以先跳过，看后续的介绍*\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"名字\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"手机\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"时间\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"状态\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"请选择\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\">提交</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '用户名' },\n          { key: 'phone', label: '手机号码' },\n          { key: 'status', label: '状态' }\n        ],\n        action: {\n          headerLabel: '操作',\n          label: '修改',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: '管理员列表'\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？\n\n- Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）\n- ButtonClick.vue 展示操作按钮和执行操作事件\n- ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节\n- AdminListPage.vue 管理员列表的具体组件\n\nAdminListPage通过[extends](https://cn.vuejs.org/v2/api/#extends)继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到[Slot](https://cn.vuejs.org/v2/api/#slot)，接下来我们注释掉ListPageAbstract.vue里关于__filter-slot__的注释，并为AdminListPage.vue添加相关slot代码。\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\n刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见\n\n![图四 除了“other input filter”其它都没了](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\n虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature [#6811](https://github.com/vuejs/vue/issues/6811)\n\n既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue\n\n*又是很多代码，没兴趣可跳过*\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"提示\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span>确认删除数据吗？</span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\">取 消</el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\">确 定</el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = '用户列表'\n  },\n  methods: {\n    createConfig () {\n      // 用户名、创建时间、手机号、状态\n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '时间' })\n      table.action = {\n        headerLabel: '操作',\n        label: '删除',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\n然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage\n\n刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是\n\n```js\n  components: { Button }\n```\n\n它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。\n\n__阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。__\n\n另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。\n\n在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。\n","source":"_posts/vue-component-extends.md","raw":"---\ntitle: Vue Component 继承与复用\ncategory: javascript\ndate: 2018-11-17 14:45:00\n---\n在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？\n\n答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以[Vue](https://vuejs.org/)为例，看看怎么去做继承这件事情。\n\n<!-- more -->\n\n### 需求描述\n\n简单实现2个列表页面，一个是管理员列表、一个用户列表\n\n![图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、\"修改\"操作按钮](/images/vue-component-extends/1.jpg)\n\n![图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、\"删除\"操作按钮](/images/vue-component-extends/2.jpg)\n\n从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。\n![图三 简单的继承图](/images/vue-component-extends/3.jpg)\n\n### 环境\n\n- Vue 版本 2.5\n\n- [Element-UI](http://element.eleme.io/) （仅仅使得Demo看上去不那么丑）\n\n- [测试代码](https://github.com/miser/vue-compoent-extends-experiment)\n\n\n### 步骤\n\n通过vue cli工具创建项目\n```js\nvue create vue-component-extedns\n```\n\n此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改\n\n\n__引入Element-UI__\n\n```js\n// main.js \nimport Vue from 'vue'\nimport ElementUI from 'element-ui'\nimport 'element-ui/lib/theme-chalk/index.css'\nimport App from './App.vue'\n\nVue.config.productionTip = false\nVue.use(ElementUI)\n\nnew Vue({\n  render: h => h(App)\n}).$mount('#app')\n\n```\n\n在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue\n\n*下面代码很多可以先跳过，看后续的介绍*\n\n```html\n// ButtonClick.vue\n<template>\n<div>\n  <el-button size=\"small\" plain type=\"primary\" @click.stop=\"click\">\n    {{ label }}\n  </el-button>\n</div>\n</template>\n<script type=\"text/javascript\">\n  export default {\n    props: ['click', 'label', 'opt'],\n    mounted () {\n      console.log('ButtonClick mounted')\n    }\n  }\n</script>\n\n// Title.vue\n<template>\n  <div class=\"title\">{{ title }}</div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['title']\n}\n</script>\n\n// ListPageAbstract.vue\n<template>\n  <div>\n    <Title :title=\"title\" />\n    <div>\n      <el-form v-if=\"config && config.filter\" ref='form' :inline=\"true\" :model=\"filterForm\">\n        <el-form-item v-if=\"config.filter.conditions.indexOf('name') >= 0\" label=\"名字\" prop=\"name\">\n          <el-input v-model=\"filterForm.name\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('phone') >= 0\" label=\"手机\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('date') >= 0\" label=\"时间\" prop=\"date\">\n          <el-input v-model=\"filterForm.date\"></el-input>\n        </el-form-item>\n        <el-form-item v-if=\"config.filter.conditions.indexOf('status') >= 0\" label=\"状态\" prop=\"status\">\n          <el-select v-model=\"filterForm.status\" placeholder=\"请选择\">\n            <el-option v-for=\"option in statusOptions\" :label=\"option.text\" :value=\"option.value\" :key=\"option.value\"></el-option>\n          </el-select>\n        </el-form-item>\n        <!-- <div>\n        <slot name=\"filter-slot\"></slot>\n        </div> -->\n        <el-form-item>\n          <el-button type=\"primary\" @click.stop=\"config.filter.action\">提交</el-button>\n        </el-form-item>\n      </el-form>\n    </div>\n    <el-table v-if=\"config\" :data=\"list\" >\n      <el-table-column v-for=\"(item, index) in config.table.column\" :key=\"index\"\n      :prop=\"item.key\" :label=\"item.label\">\n      </el-table-column>\n      <el-table-column v-if=\"config.table.action\" :label=\"config.table.action.headerLabel\">\n      <template slot-scope=\"scope\">\n      <Button :click=\"config.table.action.click.bind(null, scope.row)\" :label=\"config.table.action.label\" :opt=\"config.table.action\" />\n      </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n<script type=\"text/javascript\">\nimport Button from './ButtonClick.vue'\nimport Title from './Title.vue'\n\nexport default {\n  components: { Button, Title },\n  data: function () {\n    return {\n      filterForm: { },\n      statusOptions: [],\n      list: [],\n      title: null,\n      config: null\n    }\n  },\n  mounted: function () {\n    this.config = this.createConfig()\n    this.fetchOptions()\n    this.fetchData()\n  },\n  methods: {\n    createConfig () {\n      let config = {}\n      config.filter = {\n        conditions: [ 'name', 'status' ],\n        action: () => {\n          this.fetchData(this.filterForm)\n        }\n      }\n      config.table = {\n        column: [\n          { key: 'name', label: '用户名' },\n          { key: 'phone', label: '手机号码' },\n          { key: 'status', label: '状态' }\n        ],\n        action: {\n          headerLabel: '操作',\n          label: '修改',\n          click: this.editRow\n        }\n      }\n      return config\n    },\n    fetchOptions () {\n      this.statusOptions = [\n        { value: 1, text: 'status1' },\n        { value: 2, text: 'status2' }\n      ]\n    },\n    async fetchData () { },\n    editRow (item) {\n      console.log(`update data => ${item.name}`)\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  color: red;\n  margin-bottom: 20px;\n}\n</style>\n\n// AdminListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'Admin Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'Admin Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'Admin Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'Admin Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  data () {\n    return {\n      title: '管理员列表'\n    }\n  },\n  methods: {\n    fetchOptions () {\n      ListPageAbstract.methods.fetchOptions.call(this)\n      console.log('to do other thing')\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    }\n  }\n}\n</script>\n```\n\n刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？\n\n- Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）\n- ButtonClick.vue 展示操作按钮和执行操作事件\n- ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节\n- AdminListPage.vue 管理员列表的具体组件\n\nAdminListPage通过[extends](https://cn.vuejs.org/v2/api/#extends)继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到[Slot](https://cn.vuejs.org/v2/api/#slot)，接下来我们注释掉ListPageAbstract.vue里关于__filter-slot__的注释，并为AdminListPage.vue添加相关slot代码。\n\n```html\n// AdminListPage.vue add template \n<template slot=\"filter-slot\">\n  <div slot=\"filter-slot\">\n    other input filter\n  </div>\n</template>\n<script type=\"text/javascript\">\n```\n\n刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见\n\n![图四 除了“other input filter”其它都没了](/images/vue-component-extends/4.jpg)\n\n```html\n// AdminListPage.vue \n<template slot=\"filter-slot\">\n  <Page>\n    <div slot=\"filter-slot\">\n      other input filter\n    </div>\n  </Page>\n</template>\nexport default {\n  extends: ListPageAbstract,\n  components: {\n    Page: ListPageAbstract,\n  }\n  // ...\n}\n```\n\n虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature [#6811](https://github.com/vuejs/vue/issues/6811)\n\n既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue\n\n*又是很多代码，没兴趣可跳过*\n\n```html\n// ButtonPop.vue\n<template>\n  <div>\n    <el-button size=\"small\" plain type=\"primary\"\n      @click.stop=\"dialogVisible = true\">{{ label }}</el-button>\n    <el-dialog\n      title=\"提示\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <span>确认删除数据吗？</span>\n      <span slot=\"footer\" class=\"dialog-footer\">\n      <el-button @click=\"dialogVisible = false\">取 消</el-button>\n      <el-button type=\"primary\" @click=\"deleteInfo\">确 定</el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script type=\"text/javascript\">\nexport default {\n  props: ['click', 'label', 'opt'],\n  data () {\n    return {\n      dialogVisible: false\n    }\n  },\n  mounted () {\n    console.log('ButtonPop mounted')\n  },\n  methods: {\n    async deleteInfo () {\n      await this.click()\n      this.dialogVisible = false\n    }\n  }\n}\n</script>\n\n// UserListPage.vue\n<script type=\"text/javascript\">\nimport ListPageAbstract from './ListPageAbstract.vue'\nimport Button from './ButtonPop.vue'\n// 模拟ajax请求\n// 仅做了名字的模糊查询，其他参数忽略\nfunction search (opt) {\n  return new Promise((resolve) => {\n    let list = [\n      { name: 'User Peter', phone: '313141414', status: 'status1', date: '2018-10-10' },\n      { name: 'User Marry', phone: '123931873', status: 'status2', date: '2018-11-11' },\n      { name: 'User Sue', phone: '342391873', status: 'status1', date: '2018-01-01' },\n      { name: 'User Join', phone: '143391873', status: 'status1', date: '2018-12-12' }\n    ]\n    if (opt.name) {\n      list = list.filter(item => item.name.match(opt.name))\n    }\n    setTimeout(() => {\n      resolve(list)\n    }, 1000)\n  })\n}\nexport default {\n  extends: ListPageAbstract,\n  components: { Button },\n  data: function () { return {} },\n  mounted: function () {\n    this.title = '用户列表'\n  },\n  methods: {\n    createConfig () {\n      // 用户名、创建时间、手机号、状态\n      let config = ListPageAbstract.methods.createConfig.call(this)\n      config.filter.conditions.splice(1, 0, 'phone')\n\n      let table = config.table\n      table.column.push({ key: 'date', label: '时间' })\n      table.action = {\n        headerLabel: '操作',\n        label: '删除',\n        click: this.deleteRow\n      }\n      return config\n    },\n    async fetchData () {\n      let list = await search(this.filterForm)\n      this.list = list\n    },\n    deleteRow (item) {\n      return new Promise((resolve, reject) => {\n        console.log(`delete date: ${item.name}`)\n        setTimeout(() => {\n          this.list.splice(this.list.indexOf(item), 1)\n          resolve()\n        }, 1000)\n      })\n    }\n  }\n}\n</script>\n<style type=\"text/css\">\n.title {\n  margin-bottom: 50px;\n  color: blue;\n}\n</style>\n```\n\n然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage\n\n刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是\n\n```js\n  components: { Button }\n```\n\n它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。\n\n__阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。__\n\n另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。\n\n在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。\n","slug":"vue-component-extends","published":1,"updated":"2018-11-20T09:24:26.765Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs67bv000del8q1gxsq7l5","content":"<p>在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？</p>\n<p>答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a>为例，看看怎么去做继承这件事情。</p>\n<a id=\"more\"></a>\n<h3 id=\"需求描述\"><a href=\"#需求描述\" class=\"headerlink\" title=\"需求描述\"></a>需求描述</h3><p>简单实现2个列表页面，一个是管理员列表、一个用户列表</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\"图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、&quot;修改&quot;操作按钮\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\"图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、&quot;删除&quot;操作按钮\"></p>\n<p>从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\"图三 简单的继承图\"></p>\n<h3 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h3><ul>\n<li><p>Vue 版本 2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> （仅仅使得Demo看上去不那么丑）</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\">测试代码</a></p>\n</li>\n</ul>\n<h3 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h3><p>通过vue cli工具创建项目<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改</p>\n<p><strong>引入Element-UI</strong></p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// main.js </span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Vue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'vue'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> ElementUI <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> App <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"hljs-function\"><span class=\"hljs-params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"hljs-string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue</p>\n<p><em>下面代码很多可以先跳过，看后续的介绍</em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Title</span> <span class=\"hljs-attr\">:title</span>=<span class=\"hljs-string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config &amp;&amp; config.filter\"</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">'form'</span> <span class=\"hljs-attr\">:inline</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">:model</span>=<span class=\"hljs-string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"名字\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.name\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"手机\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"时间\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-input</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.date\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">\"状态\"</span> <span class=\"hljs-attr\">prop</span>=<span class=\"hljs-string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-select</span> <span class=\"hljs-attr\">v-model</span>=<span class=\"hljs-string\">\"filterForm.status\"</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">\"请选择\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-option</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"option in statusOptions\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"option.text\"</span> <span class=\"hljs-attr\">:value</span>=<span class=\"hljs-string\">\"option.value\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"option.value\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"config.filter.action\"</span>&gt;</span>提交<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config\"</span> <span class=\"hljs-attr\">:data</span>=<span class=\"hljs-string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">\"(item, index) in config.table.column\"</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:prop</span>=<span class=\"hljs-string\">\"item.key\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-table-column</span> <span class=\"hljs-attr\">v-if</span>=<span class=\"hljs-string\">\"config.table.action\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot-scope</span>=<span class=\"hljs-string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span> <span class=\"hljs-attr\">:click</span>=<span class=\"hljs-string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"hljs-attr\">:label</span>=<span class=\"hljs-string\">\"config.table.action.label\"</span> <span class=\"hljs-attr\">:opt</span>=<span class=\"hljs-string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Title <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config: <span class=\"hljs-literal\">null</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.config = <span class=\"hljs-keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        conditions: [ <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        action: <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.fetchData(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'name'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'用户名'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'phone'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'手机号码'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          &#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'status'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'状态'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        ],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          headerLabel: <span class=\"hljs-string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          label: <span class=\"hljs-string\">'修改'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          click: <span class=\"hljs-keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">text</span>: <span class=\"hljs-string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      ]</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`update data =&gt; <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'Admin Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      title: <span class=\"hljs-string\">'管理员列表'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？</p>\n<ul>\n<li>Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）</li>\n<li>ButtonClick.vue 展示操作按钮和执行操作事件</li>\n<li>ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节</li>\n<li>AdminListPage.vue 管理员列表的具体组件</li>\n</ul>\n<p>AdminListPage通过<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>，接下来我们注释掉ListPageAbstract.vue里关于<strong>filter-slot</strong>的注释，并为AdminListPage.vue添加相关slot代码。</p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\"图四 除了“other input filter”其它都没了\"></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue</p>\n<p><em>又是很多代码，没兴趣可跳过</em></p>\n<figure class=\"highlight html hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">\"small\"</span> <span class=\"hljs-attr\">plain</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      @<span class=\"hljs-attr\">click.stop</span>=<span class=\"hljs-string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">\"提示\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">:visible.sync</span>=<span class=\"hljs-string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"hljs-tag\">      <span class=\"hljs-attr\">width</span>=<span class=\"hljs-string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span>&gt;</span>确认删除数据吗？<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">span</span> <span class=\"hljs-attr\">slot</span>=<span class=\"hljs-string\">\"footer\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"dialogVisible = false\"</span>&gt;</span>取 消<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">el-button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"primary\"</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">\"deleteInfo\"</span>&gt;</span>确 定<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  props: [<span class=\"hljs-string\">'click'</span>, <span class=\"hljs-string\">'label'</span>, <span class=\"hljs-string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      dialogVisible: <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.dialogVisible = <span class=\"hljs-literal\">false</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> ListPageAbstract <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">import</span> Button <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">search</span> (<span class=\"hljs-params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Peter'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'313141414'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Marry'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'123931873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status2'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Sue'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'342391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      &#123; <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">'User Join'</span>, <span class=\"hljs-attr\">phone</span>: <span class=\"hljs-string\">'143391873'</span>, <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">'status1'</span>, <span class=\"hljs-attr\">date</span>: <span class=\"hljs-string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    ]</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      list = list.filter(<span class=\"hljs-function\"><span class=\"hljs-params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  data: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123; <span class=\"hljs-keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">  mounted: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">this</span>.title = <span class=\"hljs-string\">'用户列表'</span></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-comment\">// 用户名、创建时间、手机号、状态</span></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"hljs-keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      config.filter.conditions.splice(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      table.column.push(&#123; <span class=\"hljs-attr\">key</span>: <span class=\"hljs-string\">'date'</span>, <span class=\"hljs-attr\">label</span>: <span class=\"hljs-string\">'时间'</span> &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        headerLabel: <span class=\"hljs-string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        label: <span class=\"hljs-string\">'删除'</span>,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        click: <span class=\"hljs-keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">    <span class=\"hljs-keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> search(<span class=\"hljs-keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`delete date: <span class=\"hljs-subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">        setTimeout(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"hljs-javascript\">          <span class=\"hljs-keyword\">this</span>.list.splice(<span class=\"hljs-keyword\">this</span>.list.indexOf(item), <span class=\"hljs-number\">1</span>)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">style</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span>&gt;</span><span class=\"hljs-undefined\"></span></span><br><span class=\"line\"><span class=\"hljs-undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-undefined\"></span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage</p>\n<p>刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。</p>\n<p><strong>阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。</strong></p>\n<p>另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。</p>\n<p>在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。</p>\n","site":{"data":{}},"_categories":[{"name":"javascript","path":"categories/javascript/"}],"_tags":[],"excerpt":"<p>在做Web前端开发的时候会有大量的页面复用的地方，从UI布局到JS的逻辑。早年做后端开发的时候，我们通常可以通过面向对象的编程法式，使用抽象类、接口等等，那么现在前端是否也可以如此呢？</p>\n<p>答案自然是肯定的，所以我们找工作面试的时候常被问及关于JS继承的问题，随之ES6出现了期盼已久的Class，一切都在往更为成熟的方向发展。接下我们以<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"noopener\">Vue</a>为例，看看怎么去做继承这件事情。</p>","more":"<h3 id=\"需求描述\"><a href=\"#需求描述\" class=\"headerlink\" title=\"需求描述\"></a>需求描述</h3><p>简单实现2个列表页面，一个是管理员列表、一个用户列表</p>\n<p><img src=\"/images/vue-component-extends/1.jpg\" alt=\"图一 管理员列表页面，筛选有用户名、状态，列表有用户名、手机号码、状态、&quot;修改&quot;操作按钮\"></p>\n<p><img src=\"/images/vue-component-extends/2.jpg\" alt=\"图二 用户页列表面有，筛选有用户名、手机号、状态，列表有用户名、手机号码、创建时间、状态、&quot;删除&quot;操作按钮\"></p>\n<p>从上可以看出2个页面整体页面结构相同，在具体细节上会有些少于不同，第一反应就是使用前文提到的继承之类的东西去实现它。<br><img src=\"/images/vue-component-extends/3.jpg\" alt=\"图三 简单的继承图\"></p>\n<h3 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h3><ul>\n<li><p>Vue 版本 2.5</p>\n</li>\n<li><p><a href=\"http://element.eleme.io/\" target=\"_blank\" rel=\"noopener\">Element-UI</a> （仅仅使得Demo看上去不那么丑）</p>\n</li>\n<li><p><a href=\"https://github.com/miser/vue-compoent-extends-experiment\" target=\"_blank\" rel=\"noopener\">测试代码</a></p>\n</li>\n</ul>\n<h3 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h3><p>通过vue cli工具创建项目<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vue create vue-component-extedns</span><br></pre></td></tr></table></figure></p>\n<p>此刻我们可以拥有一个Vue的默认开发目录结构和代码，我开始对其进行修改</p>\n<p><strong>引入Element-UI</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.js </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Vue <span class=\"keyword\">from</span> <span class=\"string\">'vue'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> ElementUI <span class=\"keyword\">from</span> <span class=\"string\">'element-ui'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> App <span class=\"keyword\">from</span> <span class=\"string\">'./App.vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.productionTip = <span class=\"literal\">false</span></span><br><span class=\"line\">Vue.use(ElementUI)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">  render: <span class=\"function\"><span class=\"params\">h</span> =&gt;</span> h(App)</span><br><span class=\"line\">&#125;).$mount(<span class=\"string\">'#app'</span>)</span><br></pre></td></tr></table></figure>\n<p>在components目录下分别创建ListPageAbstract.vue、AdminPageAbstract.vue、ButtonClick.vue和Title.vue</p>\n<p><em>下面代码很多可以先跳过，看后续的介绍</em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonClick.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"click\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123; label &#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">    mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonClick mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Title.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"title\"</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'title'</span>]</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// ListPageAbstract.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Title</span> <span class=\"attr\">:title</span>=<span class=\"string\">\"title\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-form</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config &amp;&amp; config.filter\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">'form'</span> <span class=\"attr\">:inline</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">:model</span>=<span class=\"string\">\"filterForm\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('name') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"名字\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"name\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.name\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('phone') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"手机\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('date') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"时间\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"date\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-input</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.date\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.filter.conditions.indexOf('status') &gt;= 0\"</span> <span class=\"attr\">label</span>=<span class=\"string\">\"状态\"</span> <span class=\"attr\">prop</span>=<span class=\"string\">\"status\"</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-select</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"filterForm.status\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"请选择\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">el-option</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"option in statusOptions\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"option.text\"</span> <span class=\"attr\">:value</span>=<span class=\"string\">\"option.value\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"option.value\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">el-option</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">el-select</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;slot name=\"filter-slot\"&gt;&lt;/slot&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/div&gt; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"config.filter.action\"</span>&gt;</span>提交<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">el-form-item</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-table</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config\"</span> <span class=\"attr\">:data</span>=<span class=\"string\">\"list\"</span> &gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"(item, index) in config.table.column\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"index\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:prop</span>=<span class=\"string\">\"item.key\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"item.label\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-table-column</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"config.table.action\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.headerLabel\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot-scope</span>=<span class=\"string\">\"scope\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Button</span> <span class=\"attr\">:click</span>=<span class=\"string\">\"config.table.action.click.bind(null, scope.row)\"</span> <span class=\"attr\">:label</span>=<span class=\"string\">\"config.table.action.label\"</span> <span class=\"attr\">:opt</span>=<span class=\"string\">\"config.table.action\"</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-table-column</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonClick.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Title <span class=\"keyword\">from</span> <span class=\"string\">'./Title.vue'</span></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button, Title &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      filterForm: &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">      statusOptions: [],</span></span><br><span class=\"line\"><span class=\"undefined\">      list: [],</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">      config: <span class=\"literal\">null</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.config = <span class=\"keyword\">this</span>.createConfig()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchOptions()</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.fetchData()</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = &#123;&#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.filter = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        conditions: [ <span class=\"string\">'name'</span>, <span class=\"string\">'status'</span> ],</span></span><br><span class=\"line\"><span class=\"javascript\">        action: <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.fetchData(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      config.table = &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        column: [</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'name'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'用户名'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'phone'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'手机号码'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">          &#123; <span class=\"attr\">key</span>: <span class=\"string\">'status'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'状态'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">        ],</span></span><br><span class=\"line\"><span class=\"undefined\">        action: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          headerLabel: <span class=\"string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          label: <span class=\"string\">'修改'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">          click: <span class=\"keyword\">this</span>.editRow</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.statusOptions = [</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">1</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status1'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">        &#123; <span class=\"attr\">value</span>: <span class=\"number\">2</span>, <span class=\"attr\">text</span>: <span class=\"string\">'status2'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">      ]</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123; &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    editRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">`update data =&gt; <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: red;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// AdminListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'Admin Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      title: <span class=\"string\">'管理员列表'</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    fetchOptions () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      ListPageAbstract.methods.fetchOptions.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">'to do other thing'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>刷新页面就能呈现上述图一展示的样子和功能了。那么洋洋洒洒这么多代码做了些什么呢？</p>\n<ul>\n<li>Title.vue 用于显示页面的标题（之后我们用它测试下继承于ListPageAbstract.vue的组件如何重写css的问题）</li>\n<li>ButtonClick.vue 展示操作按钮和执行操作事件</li>\n<li>ListPageAbstract.vue 抽象的列表组件，这里是作为例子，具体方法定义的粗细程度根据具体情况调节</li>\n<li>AdminListPage.vue 管理员列表的具体组件</li>\n</ul>\n<p>AdminListPage通过<a href=\"https://cn.vuejs.org/v2/api/#extends\" target=\"_blank\" rel=\"noopener\">extends</a>继承了ListPageAbstract的模板、样式和其JS代码，通过部分的重写或完善，很容易的实现了一个页面，看上去很美好。那么新的问题来了，我们也发现ListPageAbstract定义筛选的内容是有限的，目前仅仅有name、phone、date和status，如果想扩展该怎么办呢？用过Vue的朋友或许此刻会想到<a href=\"https://cn.vuejs.org/v2/api/#slot\" target=\"_blank\" rel=\"noopener\">Slot</a>，接下来我们注释掉ListPageAbstract.vue里关于<strong>filter-slot</strong>的注释，并为AdminListPage.vue添加相关slot代码。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue add template </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">    other input filter</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br></pre></td></tr></table></figure>\n<p>刷新页面，页面仅仅留下了“other input filter”一串字符串，并没有实现我们的需求；也有人提出其它修改意见</p>\n<p><img src=\"/images/vue-component-extends/4.jpg\" alt=\"图四 除了“other input filter”其它都没了\"></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// AdminListPage.vue </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"filter-slot\"</span>&gt;</span></span><br><span class=\"line\">      other input filter</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  extends: ListPageAbstract,</span><br><span class=\"line\">  components: &#123;</span><br><span class=\"line\">    Page: ListPageAbstract,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>虽然页面UI层是预期显示了，但是如果对ListPageAbstract的mounted方法打断点会发现，它被执行了2次，因为被实例化了2次，并且页面上的元素事件使用的是ListPageAbstract里的，而不是我们在Admin里面重写的，显然方法并不可行。关于Vue模板级别的继承扩展问题在github上有很多的吐槽，但并没有列为未来的新feature <a href=\"https://github.com/vuejs/vue/issues/6811\" target=\"_blank\" rel=\"noopener\">#6811</a></p>\n<p>既然我们讨论这个问题，自然也是可以解决的，在这我们不以filter查询条件的多少为例子，我们以更为简单的按钮为例，在列表里每一行的最后有一个“修改”按钮，而然我们在UserListPage里面，我们希望它变成一个“删除”按钮，并弹出确实删除的提示。新增ButtonPop.vue和UserListPage.vue</p>\n<p><em>又是很多代码，没兴趣可跳过</em></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ButtonPop.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">size</span>=<span class=\"string\">\"small\"</span> <span class=\"attr\">plain</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      @<span class=\"attr\">click.stop</span>=<span class=\"string\">\"dialogVisible = true\"</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-dialog</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">title</span>=<span class=\"string\">\"提示\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">:visible.sync</span>=<span class=\"string\">\"dialogVisible\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">width</span>=<span class=\"string\">\"30%\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span>确认删除数据吗？<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"footer\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dialog-footer\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"dialogVisible = false\"</span>&gt;</span>取 消<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"primary\"</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"deleteInfo\"</span>&gt;</span>确 定<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-dialog</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  props: [<span class=\"string\">'click'</span>, <span class=\"string\">'label'</span>, <span class=\"string\">'opt'</span>],</span></span><br><span class=\"line\"><span class=\"undefined\">  data () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      dialogVisible: <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  mounted () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'ButtonPop mounted'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> deleteInfo () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.click()</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.dialogVisible = <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// UserListPage.vue</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> ListPageAbstract <span class=\"keyword\">from</span> <span class=\"string\">'./ListPageAbstract.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">import</span> Button <span class=\"keyword\">from</span> <span class=\"string\">'./ButtonPop.vue'</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 模拟ajax请求</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">// 仅做了名字的模糊查询，其他参数忽略</span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span> (<span class=\"params\">opt</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">let</span> list = [</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Peter'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'313141414'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-10-10'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Marry'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'123931873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status2'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-11-11'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Sue'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'342391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-01-01'</span> &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">      &#123; <span class=\"attr\">name</span>: <span class=\"string\">'User Join'</span>, <span class=\"attr\">phone</span>: <span class=\"string\">'143391873'</span>, <span class=\"attr\">status</span>: <span class=\"string\">'status1'</span>, <span class=\"attr\">date</span>: <span class=\"string\">'2018-12-12'</span> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    ]</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span> (opt.name) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      list = list.filter(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> item.name.match(opt.name))</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      resolve(list)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  extends: ListPageAbstract,</span></span><br><span class=\"line\"><span class=\"undefined\">  components: &#123; Button &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  data: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; <span class=\"keyword\">return</span> &#123;&#125; &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">  mounted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.title = <span class=\"string\">'用户列表'</span></span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">  methods: &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    createConfig () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 用户名、创建时间、手机号、状态</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> config = ListPageAbstract.methods.createConfig.call(<span class=\"keyword\">this</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">      config.filter.conditions.splice(<span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"string\">'phone'</span>)</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> table = config.table</span></span><br><span class=\"line\"><span class=\"javascript\">      table.column.push(&#123; <span class=\"attr\">key</span>: <span class=\"string\">'date'</span>, <span class=\"attr\">label</span>: <span class=\"string\">'时间'</span> &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">      table.action = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        headerLabel: <span class=\"string\">'操作'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        label: <span class=\"string\">'删除'</span>,</span></span><br><span class=\"line\"><span class=\"javascript\">        click: <span class=\"keyword\">this</span>.deleteRow</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> config</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">async</span> fetchData () &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> list = <span class=\"keyword\">await</span> search(<span class=\"keyword\">this</span>.filterForm)</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.list = list</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;,</span></span><br><span class=\"line\"><span class=\"undefined\">    deleteRow (item) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">`delete date: <span class=\"subst\">$&#123;item.name&#125;</span>`</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">this</span>.list.splice(<span class=\"keyword\">this</span>.list.indexOf(item), <span class=\"number\">1</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">          resolve()</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;, 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;)</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">.title &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">  margin-bottom: 50px;</span></span><br><span class=\"line\"><span class=\"undefined\">  color: blue;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后在修改下App.vue里面的Page引用，从AdminListPage改为UserListPage</p>\n<p>刷新页面，就和图二的样子一样了。整个代码并不复杂，核心就是</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">components: &#123; Button &#125;</span><br></pre></td></tr></table></figure>\n<p>它将父类的Button（ButtonClick）替换成了User页面需要的ButtonPop，实现了扩展。其实Filter查询条件也可以，只要我们做好组件的抽取等就行。</p>\n<p><strong>阅读Vue的源码时候，在Vue组件实例化的过程中，会有很多对options的深层次merge，使得我们可以通过上诉方法实现对父组件的扩展。</strong></p>\n<p>另外，细心的朋友观察代码或页面也发现“用户列表”4个字的颜色从红色变成了蓝色，与下面列表的间距也增大了不少，在User页面的style标签里就能很容易修改父组件的css样式。</p>\n<p>在Vue中，mixin、slot都是非常好用的工具，或许我们有时候也能改变思路，通过组件的替换构建出一个更为容易扩展的框架。</p>"},{"title":"前端错误捕获提交错误日志","_content":"\n#### 为什么需要捕获？\n\n前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。\n\n#### 客户端怎么捕获？\n\n1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响\n\n2.Promise 通过__catch__方法\n\n3.async/await 通过 __try - catch__\n\n4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror\n\n<!-- more -->\n\n#### 不同的捕获错误用法（测试环境 chrome & https://jsbin.com）\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。\n    source：发生错误的脚本URL（字符串）\n    lineno：发生错误的行号（数字）\n    colno：发生错误的列号（数字）\n    error：Error对象（对象）\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n虽然__onerror__无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q：如果没有catch方法，是否能捕获Promise里的错误？\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise里的错误无论在__try - catch__还是__onerror__里都无法被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的__catch__捕获。\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 通过 __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise构造函数里的错误并没有被__onerror__捕获\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console 输出\nget res\n*/\n```\n\n虽然Promise正常执行，但是当后续的代码出错__onerror__依旧没有被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__捕获了\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 __try - catch__将不再对它捕获\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子\n  // 只在 2.2.0+ 可用\n}\n```\n\n> 指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。\n\n我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。\n\n测试代码库：https://github.com/miser/vue-capture-error\n\n在main.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/* 刷新页面 console 输出\n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …\n1: VueComponent {_uid: 1, _isVue: true, $options: {…}, _renderProxy: Proxy, _self: VueComponent, …}\n2: \"created hook\n*/\n```\n\n从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。\n\njs中的异步很大一部分来自网络请求，那么在这我们用 [axios](https://github.com/axios/axios) （它做了一层ajax与Promise之间的封装）。\n\nmain.js里添加\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\n上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803\n\n那么该怎么办，不可能每个地方都加Promise.catch方法吧！\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。\n\nmain.js里添加@Doeke的思路\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\n通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。\n\n那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 [babeljs](https://babeljs.io) 官网的 “Try it out\" 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。\n\n#### 在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\n\n__网络层__：可以在axios.create创建的实例中\n\n__逻辑层__：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（__*这个方法的是否有副作用还需要研究!*__）\n\n#### 捕获的错误存放在哪？\n\n__# 自己简易服务 ？__\n\n感觉成本很大（人力和工时）\n\n__# 官方推荐的 [Sentry](https://sentry.io/)  __\n\n注册后安装官方的JS SDK\n\n```\nnpm install raven-js --save\n```\n\n修改main.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\n修改App.vue （我们从最普通的js测试起）\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n打开sentry页面查看\n![错误报告列表](/images/js-capture-error/1.png)\n![错误报告详情（模糊了IP部分）](/images/js-capture-error/2.jpg)\n我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。\n\n测试fetch1的ajax请求错误\n![成功截获api1.github.com这个错误域名](/images/js-capture-error/3.jpg)\n\n除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：\n\n![Promise.then里的错误](/images/js-capture-error/4.jpg)\n![async/await里的错误](/images/js-capture-error/5.jpg)\n\n除了默认的数据的收集外，还能收集一些其他数据，比如用户信息\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![用户信息顺收集](/images/js-capture-error/6.jpg)\n\n__我们测试了代码未被压缩的情况，如果代码压缩了呢？__\n\n![通过npm run build 压缩代码打开首页，一脸懵逼](/images/js-capture-error/7.jpg)\n\n显然我们不能直观的获得错误定位，不过sentry提供[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)存储服务，它能方便的debug被压缩的代码。\n\n我们可以通过[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', // 组织名称 类似公司名吧（一个用户下可以有多个组织）\n        project: 'popcorn-vue', // 项目名称 （一个组织下可以有多个项目）\n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // 发布后的代码和这个对应，可以找到这个sourcemaps\n      })\n    ]\n  }\n}\n\n```\n修改main.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // 新增\n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\n查看sentry里popcorn-vue项目中的__版本__\n\n![1.2.4-beta是目前的，1.2.3-beta是以前版本](/images/js-capture-error/8.jpg)\n![点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件](/images/js-capture-error/9.jpg)\n\n\n我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。\n\n这个issue https://github.com/getsentry/sentry-electron/issues/54 是一个很经典的例子，它犯了2个错误\n\n-- 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上\n-- js和js.map目录路径不匹配\n\n这2个原因都会导致无法正常解析被压缩的文件。\n\n那么不直接通过浏览器打开index.html（file:///******/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。\n```\nbrew install nginx\nnginx\n```\n\n将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器http://localhost:8080\n\n回到sentry中查看新的错误记录\n\n![已经很详细的记录了出错的方法](/images/js-capture-error/10.jpg)\n\n","source":"_posts/js-capture-error.md","raw":"---\ntitle: 前端错误捕获提交错误日志\ncategory: javascript\n---\n\n#### 为什么需要捕获？\n\n前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。\n\n#### 客户端怎么捕获？\n\n1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响\n\n2.Promise 通过__catch__方法\n\n3.async/await 通过 __try - catch__\n\n4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror\n\n<!-- more -->\n\n#### 不同的捕获错误用法（测试环境 chrome & https://jsbin.com）\n\n##### [window.onerror](https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror)\n\n```js\nwindow.onerror = function(message, source, lineno, colno, error) {\n    /*\n    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。\n    source：发生错误的脚本URL（字符串）\n    lineno：发生错误的行号（数字）\n    colno：发生错误的列号（数字）\n    error：Error对象（对象）\n    */\n}\n```\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nlet data\nlet info = data.info\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 6,\n  3: 17,\n  4: [object Error] { ... }\n}\n*/\n```\n\n虽然__onerror__无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction timer () {\n  setTimeout(function () {\n     let data\n     let info = data.info\n  }, 100)\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n     timer()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n  })\n}\n\np().then(function() {\n  console.log('running then')\n})\n.catch(function(error){\n  console.log(error)\n  console.log('outer error')\n})\n\n/* console 输出\n[object Arguments] {\n  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",\n  1: \"yiveral.js\",\n  2: 8,\n  3: 22,\n  4: [object Error] { ... }\n}\n*/\n```\n\n\n\n##### [Promise catch](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch)\n\n##### Q：如果没有catch方法，是否能捕获Promise里的错误？\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n  console.log('onerror')\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log('running then')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise里的错误无论在__try - catch__还是__onerror__里都无法被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\ntry {\n  p().then(function(res) {\n    console.log(res)\n    console.log('running then')\n  }).catch(function(error){\n    console.log(error)\n    console.log('outer error')\n  })\n} catch (e) {\n  console.log(e)\n  console.log('try - catch')\n}\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n\"running then\"\n*/\n```\n\n通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的__catch__捕获。\n\n##### [async/await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 通过 __try - catch__\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  let res = await p()\n  console.log(res)\n})()\n\n/* console 没有任何输出\n*/\n```\n\n我们通过上面的代码发现，Promise构造函数里的错误并没有被__onerror__捕获\n\n```js\nwindow.onerror = function () {\n  console.log(arguments)\n}\n\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    resolve('resolve')\n  })\n}\n(async function () {\n  let res = await p()\n  console.log('get res')\n  errorFn()\n})()\n\n/* console 输出\nget res\n*/\n```\n\n虽然Promise正常执行，但是当后续的代码出错__onerror__依旧没有被捕获\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"try - catch\"\n*/\n```\n\n__try - catch__捕获了\n\n```js\nfunction errorFn () {\n  let data\n  let info = data.info\n}\n\nfunction p() {\n  return new Promise(function (resolve, reject) {\n    errorFn()\n  }).catch(function (error) {\n    console.log(error)\n    console.log('inner error')\n    return 'return inner error'\n  })\n}\n(async function () {\n  try {\n    let res = await p()\n    console.log(res)\n  } catch (e) {\n    console.log(e)\n    console.log('try - catch')\n  }\n})()\n\n/* console 输出\n[object Error] { ... }\n\"inner error\"\n\"return inner error\"\n*/\n```\n\n从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 __try - catch__将不再对它捕获\n\n##### [Vue.config.errorHandler](https://cn.vuejs.org/v2/api/index.html#errorHandler)\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  // handle error\n  // `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子\n  // 只在 2.2.0+ 可用\n}\n```\n\n> 指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。\n\n我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。\n\n测试代码库：https://github.com/miser/vue-capture-error\n\n在main.js\n\n```js\nVue.config.errorHandler = function (err, vm, info) {\n  console.log(arguments)\n  console.log('vue errorHandler')\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.normal()\n  },\n  methods: {\n    normal () {\n      let data\n      let info = data.info\n    }\n  }\n  // ...  \n}\n\n/* 刷新页面 console 输出\n0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …\n1: VueComponent {_uid: 1, _isVue: true, $options: {…}, _renderProxy: Proxy, _self: VueComponent, …}\n2: \"created hook\n*/\n```\n\n从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。\n\njs中的异步很大一部分来自网络请求，那么在这我们用 [axios](https://github.com/axios/axios) （它做了一层ajax与Promise之间的封装）。\n\nmain.js里添加\n\n```js\nconst request = axios.create()\nrequest.interceptors.response.use(response => {\n  return response\n})\n\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      reject(err)\n    })\n  })\n}\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch1()\n  },\n  methods: {\n    fetch1 () {\n        Vue.request('https://api1.github.com/')\n\t      .then(response => {\n            console.log(response)\n          })\n    }\n  }\n  // ...  \n}\n```\n\napi.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n      .then(response => {\n        let data = response.data\n        let info = data.api.info\n      })\n    }\n  }\n  // ...  \n}\n```\n\n上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:\n\n> https://github.com/vuejs/vue/issues/6551\n>\n> Vue cannot capture errors that are thrown asynchronously, similar to how try... catch won't catch async errors. It's your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803\n\n那么该怎么办，不可能每个地方都加Promise.catch方法吧！\n\n> https://github.com/vuejs/vue/issues/7653\n>\n> @Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。\n\nmain.js里添加@Doeke的思路\n\n```js\nVue.mixin({\n  beforeCreate: function () {\n    const methods = this.$options.methods || {}\n    Object.entries(methods).forEach(([key, method]) => {\n      if (method._asyncWrapped) return\n      const wrappedMethod = function (...args) {\n        const result = method.apply(this, args)\n        const resultIsPromise = result && typeof result.then === 'function'\n        if (!resultIsPromise) return result\n\n        return new Promise(async (resolve, reject) => {\n          try {\n            resolve(await result)\n          } catch (error) {\n            if (!error._handled) {\n              const errorHandler = Vue.config.errorHandler\n              errorHandler(error)\n              error._handled = true\n            }\n            reject(error)\n          }\n        })\n      }\n      wrappedMethod._asyncWrapped = true\n      methods[key] = wrappedMethod\n    })\n  }\n})\n```\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch2()\n    this.fetch3()\n  },\n  methods: {\n    fetch2 () {\n      Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch2\n        })\n    },\n    fetch3 () {\n      return Vue.request('https://api.github.com/')\n        .then(response => {\n          let data = response.data\n          let info = data.api.fetch3\n        })\n    }\n  }\n  // ...  \n}\n```\n\n通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。\n\n那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？\n\n在App.vue\n\n```js\n{\n  // ...\n  created () {\n    this.fetch4()\n    this.fetch5()\n  },\n  methods: {\n    async fetch4 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch4\n    },\n    async fetch5 () {\n      let response = await Vue.request('https://api.github.com/')\n      let data = response.data\n      let info = data.api.fetch5\n      return response\n    }\n  }\n  // ...  \n}\n```\n\nfetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 [babeljs](https://babeljs.io) 官网的 “Try it out\" 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。\n\n#### 在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\n\n__网络层__：可以在axios.create创建的实例中\n\n__逻辑层__：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（__*这个方法的是否有副作用还需要研究!*__）\n\n#### 捕获的错误存放在哪？\n\n__# 自己简易服务 ？__\n\n感觉成本很大（人力和工时）\n\n__# 官方推荐的 [Sentry](https://sentry.io/)  __\n\n注册后安装官方的JS SDK\n\n```\nnpm install raven-js --save\n```\n\n修改main.js\n\n```js\n// ...\nimport Raven from 'raven-js'\nimport RavenVue from 'raven-js/plugins/vue'\n\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044') // sentry token\n  .addPlugin(RavenVue, Vue)\n  .install()\n\nVue.config.errorHandler = function (err, vm, info) {\n  Raven.captureException(err)\n}\nVue.request = (args) => {\n  return new Promise((resolve, reject) => {\n    request(args).then(res => {\n      resolve(res)\n    }).catch(err => {\n      Raven.captureException(err)\n      reject(err)\n    })\n  })\n}\n// ...\n```\n\n修改App.vue （我们从最普通的js测试起）\n```js\n// ...\ncreated () {\n    this.normal()\n    // this.fetch1()\n    // this.fetch2()\n    // this.fetch3()\n    // this.fetch4()\n    // this.fetch5()\n}\n// ...\n```\n\n打开sentry页面查看\n![错误报告列表](/images/js-capture-error/1.png)\n![错误报告详情（模糊了IP部分）](/images/js-capture-error/2.jpg)\n我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。\n\n测试fetch1的ajax请求错误\n![成功截获api1.github.com这个错误域名](/images/js-capture-error/3.jpg)\n\n除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：\n\n![Promise.then里的错误](/images/js-capture-error/4.jpg)\n![async/await里的错误](/images/js-capture-error/5.jpg)\n\n除了默认的数据的收集外，还能收集一些其他数据，比如用户信息\n\n```js\nRaven.setUser({\n    name: 'miser name',\n    id: 'miser id'\n  })\n```\n![用户信息顺收集](/images/js-capture-error/6.jpg)\n\n__我们测试了代码未被压缩的情况，如果代码压缩了呢？__\n\n![通过npm run build 压缩代码打开首页，一脸懵逼](/images/js-capture-error/7.jpg)\n\n显然我们不能直观的获得错误定位，不过sentry提供[SourceMaps](https://github.com/google/closure-compiler/wiki/Source-Maps)存储服务，它能方便的debug被压缩的代码。\n\n我们可以通过[webpack-sentry-plugin](https://www.npmjs.com/package/webpack-sentry-plugin)工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件\n\n```js\nconst SentryPlugin = require('webpack-sentry-plugin')\n\nmodule.exports = {\n  configureWebpack: {\n    plugins: [\n      new SentryPlugin({\n        organization: 'fe-org', // 组织名称 类似公司名吧（一个用户下可以有多个组织）\n        project: 'popcorn-vue', // 项目名称 （一个组织下可以有多个项目）\n        apiKey: '17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150',\n        release: '1.2.4-beta' // 发布后的代码和这个对应，可以找到这个sourcemaps\n      })\n    ]\n  }\n}\n\n```\n修改main.js\n```js\nRaven\n  .config('https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044', {\n    release: '1.2.4-beta' // 新增\n  })\n  .addPlugin(RavenVue, Vue)\n  .install()\n```\n\n```\nnpm run build\n```\n\n查看sentry里popcorn-vue项目中的__版本__\n\n![1.2.4-beta是目前的，1.2.3-beta是以前版本](/images/js-capture-error/8.jpg)\n![点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件](/images/js-capture-error/9.jpg)\n\n\n我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。\n\n这个issue https://github.com/getsentry/sentry-electron/issues/54 是一个很经典的例子，它犯了2个错误\n\n-- 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上\n-- js和js.map目录路径不匹配\n\n这2个原因都会导致无法正常解析被压缩的文件。\n\n那么不直接通过浏览器打开index.html（file:///******/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。\n```\nbrew install nginx\nnginx\n```\n\n将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器http://localhost:8080\n\n回到sentry中查看新的错误记录\n\n![已经很详细的记录了出错的方法](/images/js-capture-error/10.jpg)\n\n","slug":"js-capture-error","published":1,"date":"2018-10-23T10:29:29.089Z","updated":"2019-01-18T13:49:31.622Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjvgs67ey000gel8qgdmf8azx","content":"<h4 id=\"为什么需要捕获？\"><a href=\"#为什么需要捕获？\" class=\"headerlink\" title=\"为什么需要捕获？\"></a>为什么需要捕获？</h4><p>前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。</p>\n<h4 id=\"客户端怎么捕获？\"><a href=\"#客户端怎么捕获？\" class=\"headerlink\" title=\"客户端怎么捕获？\"></a>客户端怎么捕获？</h4><p>1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响</p>\n<p>2.Promise 通过<strong>catch</strong>方法</p>\n<p>3.async/await 通过 <strong>try - catch</strong></p>\n<p>4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror</p>\n<a id=\"more\"></a>\n<h4 id=\"不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\"><a href=\"#不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\" class=\"headerlink\" title=\"不同的捕获错误用法（测试环境 chrome &amp; https://jsbin.com）\"></a>不同的捕获错误用法（测试环境 chrome &amp; <a href=\"https://jsbin.com）\" target=\"_blank\" rel=\"noopener\">https://jsbin.com）</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">/*</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    source：发生错误的脚本URL（字符串）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    lineno：发生错误的行号（数字）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    colno：发生错误的列号（数字）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    error：Error对象（对象）</span></span><br><span class=\"line\"><span class=\"hljs-comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\"><span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然<strong>onerror</strong>无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">timer</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"hljs-number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"hljs-comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"><a href=\"#Q：如果没有catch方法，是否能捕获Promise里的错误？\" class=\"headerlink\" title=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"></a>Q：如果没有catch方法，是否能捕获Promise里的错误？</h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise里的错误无论在<strong>try - catch</strong>还是<strong>onerror</strong>里都无法被捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的<strong>catch</strong>捕获。</p>\n<h5 id=\"async-await-通过-try-catch\"><a href=\"#async-await-通过-try-catch\" class=\"headerlink\" title=\"async/await 通过 try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a> 通过 <strong>try - catch</strong></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise构造函数里的错误并没有被<strong>onerror</strong>捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-built_in\">window</span>.onerror = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"hljs-string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">get res</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然Promise正常执行，但是当后续的代码出错<strong>onerror</strong>依旧没有被捕获</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong>捕获了</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">errorFn</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">p</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">let</span> res = <span class=\"hljs-keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 <strong>try - catch</strong>将不再对它捕获</p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// 只在 2.2.0+ 可用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。</p>\n</blockquote>\n<p>我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。</p>\n<p>测试代码库：<a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>在main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">/* 刷新页面 console 输出</span></span><br><span class=\"line\"><span class=\"hljs-comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …</span></span><br><span class=\"line\"><span class=\"hljs-comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: VueComponent, …&#125;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"hljs-comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。</p>\n<p>js中的异步很大一部分来自网络请求，那么在这我们用 <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> （它做了一层ajax与Promise之间的封装）。</p>\n<p>main.js里添加</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"hljs-string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"hljs-built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。</p>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"hljs-keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try… catch won’t catch async errors. It’s your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803</p>\n</blockquote>\n<p>那么该怎么办，不可能每个地方都加Promise.catch方法吧！</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。</p>\n</blockquote>\n<p>main.js里添加@Doeke的思路</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> methods = <span class=\"hljs-keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">Object</span>.entries(methods).forEach(<span class=\"hljs-function\">(<span class=\"hljs-params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (method._asyncWrapped) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> wrappedMethod = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> result = method.apply(<span class=\"hljs-keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"hljs-keyword\">typeof</span> result.then === <span class=\"hljs-string\">'function'</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!resultIsPromise) <span class=\"hljs-keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"hljs-keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"hljs-keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"hljs-keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"hljs-keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。</p>\n<p>那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？</p>\n<p>在App.vue</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"hljs-keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> response = <span class=\"hljs-keyword\">await</span> Vue.request(<span class=\"hljs-string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"hljs-keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"hljs-comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a> 官网的 “Try it out” 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。</p>\n<h4 id=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"><a href=\"#在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\" class=\"headerlink\" title=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"></a>在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）</h4><p><strong>网络层</strong>：可以在axios.create创建的实例中</p>\n<p><strong>逻辑层</strong>：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（<strong><em>这个方法的是否有副作用还需要研究!</em></strong>）</p>\n<h4 id=\"捕获的错误存放在哪？\"><a href=\"#捕获的错误存放在哪？\" class=\"headerlink\" title=\"捕获的错误存放在哪？\"></a>捕获的错误存放在哪？</h4><p><strong># 自己简易服务 ？</strong></p>\n<p>感觉成本很大（人力和工时）</p>\n<p><strong># 官方推荐的 <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>注册后安装官方的JS SDK</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>修改main.js</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> Raven <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">import</span> RavenVue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"hljs-comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"hljs-function\">(<span class=\"hljs-params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"hljs-function\"><span class=\"hljs-params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>修改App.vue （我们从最普通的js测试起）<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"hljs-comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>打开sentry页面查看<br><img src=\"/images/js-capture-error/1.png\" alt=\"错误报告列表\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"错误报告详情（模糊了IP部分）\"><br>我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。</p>\n<p>测试fetch1的ajax请求错误<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"成功截获api1.github.com这个错误域名\"></p>\n<p>除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then里的错误\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await里的错误\"></p>\n<p>除了默认的数据的收集外，还能收集一些其他数据，比如用户信息</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"hljs-string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"hljs-string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"用户信息顺收集\"></p>\n<p><strong>我们测试了代码未被压缩的情况，如果代码压缩了呢？</strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"通过npm run build 压缩代码打开首页，一脸懵逼\"></p>\n<p>显然我们不能直观的获得错误定位，不过sentry提供<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>存储服务，它能方便的debug被压缩的代码。</p>\n<p>我们可以通过<a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件</p>\n<figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> SentryPlugin = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"hljs-keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"hljs-string\">'fe-org'</span>, <span class=\"hljs-comment\">// 组织名称 类似公司名吧（一个用户下可以有多个组织）</span></span><br><span class=\"line\">        project: <span class=\"hljs-string\">'popcorn-vue'</span>, <span class=\"hljs-comment\">// 项目名称 （一个组织下可以有多个项目）</span></span><br><span class=\"line\">        apiKey: <span class=\"hljs-string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// 发布后的代码和这个对应，可以找到这个sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改main.js<br><figure class=\"highlight js hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"hljs-string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"hljs-string\">'1.2.4-beta'</span> <span class=\"hljs-comment\">// 新增</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>查看sentry里popcorn-vue项目中的<strong>版本</strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta是目前的，1.2.3-beta是以前版本\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\"点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件\"></p>\n<p>我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。</p>\n<p>这个issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 是一个很经典的例子，它犯了2个错误</p>\n<p>– 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上<br>– js和js.map目录路径不匹配</p>\n<p>这2个原因都会导致无法正常解析被压缩的文件。</p>\n<p>那么不直接通过浏览器打开index.html（file:///<strong>**</strong>/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。<br><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>回到sentry中查看新的错误记录</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"已经很详细的记录了出错的方法\"></p>\n","site":{"data":{}},"_categories":[{"name":"javascript","path":"categories/javascript/"}],"_tags":[],"excerpt":"<h4 id=\"为什么需要捕获？\"><a href=\"#为什么需要捕获？\" class=\"headerlink\" title=\"为什么需要捕获？\"></a>为什么需要捕获？</h4><p>前端代码运行在客户端的浏览器里，当客户端（浏览器）出现任何问题，在没有错误日志的情况下，我们都是不知道问题发生在哪，我们只能依靠猜测或者自己不断尝试才知道，或者永远不知道问题。</p>\n<h4 id=\"客户端怎么捕获？\"><a href=\"#客户端怎么捕获？\" class=\"headerlink\" title=\"客户端怎么捕获？\"></a>客户端怎么捕获？</h4><p>1.通过window.onerror，可惜只能获得基础的js错误，Promise、async/await 里的错误无法捕获，它收到同源决策的影响</p>\n<p>2.Promise 通过<strong>catch</strong>方法</p>\n<p>3.async/await 通过 <strong>try - catch</strong></p>\n<p>4.Vue可以通过全局Vue.config.errorHandler去获得非Promise、async/await里的错误，可以理解为Vue里的window.onerror</p>","more":"<h4 id=\"不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\"><a href=\"#不同的捕获错误用法（测试环境-chrome-amp-https-jsbin-com）\" class=\"headerlink\" title=\"不同的捕获错误用法（测试环境 chrome &amp; https://jsbin.com）\"></a>不同的捕获错误用法（测试环境 chrome &amp; <a href=\"https://jsbin.com）\" target=\"_blank\" rel=\"noopener\">https://jsbin.com）</a></h4><h5 id=\"window-onerror\"><a href=\"#window-onerror\" class=\"headerlink\" title=\"window.onerror\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror\" target=\"_blank\" rel=\"noopener\">window.onerror</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">message, source, lineno, colno, error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    message：错误信息（字符串）。可用于HTML onerror=\"\"处理程序中的event。</span></span><br><span class=\"line\"><span class=\"comment\">    source：发生错误的脚本URL（字符串）</span></span><br><span class=\"line\"><span class=\"comment\">    lineno：发生错误的行号（数字）</span></span><br><span class=\"line\"><span class=\"comment\">    colno：发生错误的列号（数字）</span></span><br><span class=\"line\"><span class=\"comment\">    error：Error对象（对象）</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> data</span><br><span class=\"line\"><span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 6,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 17,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然<strong>onerror</strong>无法捕获Promise里的错误，但是如果Promise里面是被setTimeout包裹的js还是能捕获的</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">timer</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">     <span class=\"keyword\">let</span> data</span><br><span class=\"line\">     <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">  &#125;, <span class=\"number\">100</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">     timer()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">.catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Arguments] &#123;</span></span><br><span class=\"line\"><span class=\"comment\">  0: \"Uncaught TypeError: Cannot read property 'info' of undefined\",</span></span><br><span class=\"line\"><span class=\"comment\">  1: \"yiveral.js\",</span></span><br><span class=\"line\"><span class=\"comment\">  2: 8,</span></span><br><span class=\"line\"><span class=\"comment\">  3: 22,</span></span><br><span class=\"line\"><span class=\"comment\">  4: [object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"Promise-catch\"><a href=\"#Promise-catch\" class=\"headerlink\" title=\"Promise catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch\" target=\"_blank\" rel=\"noopener\">Promise catch</a></h5><h5 id=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"><a href=\"#Q：如果没有catch方法，是否能捕获Promise里的错误？\" class=\"headerlink\" title=\"Q：如果没有catch方法，是否能捕获Promise里的错误？\"></a>Q：如果没有catch方法，是否能捕获Promise里的错误？</h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'onerror'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise里的错误无论在<strong>try - catch</strong>还是<strong>onerror</strong>里都无法被捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  p().then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'running then'</span>)</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">error</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'outer error'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"running then\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>通过上面代码发现，已经被捕获的错误代码，在外层不会再被捕获而是继续执行then里的方法，可见在一条Promise链上的错误，会被之后最近的<strong>catch</strong>捕获。</p>\n<h5 id=\"async-await-通过-try-catch\"><a href=\"#async-await-通过-try-catch\" class=\"headerlink\" title=\"async/await 通过 try - catch\"></a><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await</a> 通过 <strong>try - catch</strong></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 没有任何输出</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>我们通过上面的代码发现，Promise构造函数里的错误并没有被<strong>onerror</strong>捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onerror = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    resolve(<span class=\"string\">'resolve'</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'get res'</span>)</span><br><span class=\"line\">  errorFn()</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">get res</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>虽然Promise正常执行，但是当后续的代码出错<strong>onerror</strong>依旧没有被捕获</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"try - catch\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p><strong>try - catch</strong>捕获了</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">errorFn</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data</span><br><span class=\"line\">  <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">resolve, reject</span>) </span>&#123;</span><br><span class=\"line\">    errorFn()</span><br><span class=\"line\">  &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(error)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'inner error'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return inner error'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">(<span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> p()</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'try - catch'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* console 输出</span></span><br><span class=\"line\"><span class=\"comment\">[object Error] &#123; ... &#125;</span></span><br><span class=\"line\"><span class=\"comment\">\"inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">\"return inner error\"</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码我们知道，如果Promise构造函数里的错误被它自己catch的话，那么 async/await 后续的 <strong>try - catch</strong>将不再对它捕获</p>\n<h5 id=\"Vue-config-errorHandler\"><a href=\"#Vue-config-errorHandler\" class=\"headerlink\" title=\"Vue.config.errorHandler\"></a><a href=\"https://cn.vuejs.org/v2/api/index.html#errorHandler\" target=\"_blank\" rel=\"noopener\">Vue.config.errorHandler</a></h5><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// handle error</span></span><br><span class=\"line\">  <span class=\"comment\">// `info` 是 Vue 特定的错误信息，比如错误所在的生命周期钩子</span></span><br><span class=\"line\">  <span class=\"comment\">// 只在 2.2.0+ 可用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 Vue 实例。</p>\n</blockquote>\n<p>我们该如何去理解官方对errorHandler的解释呢？通过 vue-cli构建工具，创建一个非常基础的vue项目，做一些实验。</p>\n<p>测试代码库：<a href=\"https://github.com/miser/vue-capture-error\" target=\"_blank\" rel=\"noopener\">https://github.com/miser/vue-capture-error</a></p>\n<p>在main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'vue errorHandler'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    normal () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.info</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* 刷新页面 console 输出</span></span><br><span class=\"line\"><span class=\"comment\">0: TypeError: Cannot read property 'info' of undefined at VueComponent.normal …</span></span><br><span class=\"line\"><span class=\"comment\">1: VueComponent &#123;_uid: 1, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: VueComponent, …&#125;</span></span><br><span class=\"line\"><span class=\"comment\">2: \"created hook</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>从上面代码可以看出，errorHandler确实可以满足我们的需求，在一个统一的地方捕获代码的错误，但是真的如此吗？上文也提到errorHandler和window.onerror类似，那么当我们使用Promse或者async/await时会不会得愿以偿。</p>\n<p>js中的异步很大一部分来自网络请求，那么在这我们用 <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> （它做了一层ajax与Promise之间的封装）。</p>\n<p>main.js里添加</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> request = axios.create()</span><br><span class=\"line\">request.interceptors.response.use(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> response</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch1()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch1 () &#123;</span><br><span class=\"line\">        Vue.request(<span class=\"string\">'https://api1.github.com/'</span>)</span><br><span class=\"line\">\t      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(response)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>api.github.com 会返回 github的api列表，当我们拼错域名，比如上面代码中的api1.github.com时，那肯定是无法获得我们想要的，可是errorHandler并没有获得该错误，不过幸好，我们可以在全局统一的Vue.request里的catch方法去统一捕获网络层面的错误。那如果是非网络层面的呢？比如数据请求回来了，但是绑定数据的时候，后端因为业务的修改等原因并没有返回我们需要的字段，造成Promise.then方法的业务处理错误。</p>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">        <span class=\"keyword\">let</span> info = data.api.info</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上诉代码运行后，errorHandler同样未能捕获错误，从vue的issue里面去查询关于捕获Promise或者async/await时，会得到作者的答复:</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/6551\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/6551</a></p>\n<p>Vue cannot capture errors that are thrown asynchronously, similar to how try… catch won’t catch async errors. It’s your responsibility to handle async errors properly, e.g. using Promise.catch  — @yyx990803</p>\n</blockquote>\n<p>那么该怎么办，不可能每个地方都加Promise.catch方法吧！</p>\n<blockquote>\n<p><a href=\"https://github.com/vuejs/vue/issues/7653\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/7653</a></p>\n<p>@Doeke 在这个地方给出一个解决方案，通过全局mixin，给那些Promise方法外面包一层Promise，在这个外层Promise链上catch里面的错误，不过这样需要做代码的约定，就是原来的方法需要返回一个Promise对象。</p>\n</blockquote>\n<p>main.js里添加@Doeke的思路</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.mixin(&#123;</span><br><span class=\"line\">  beforeCreate: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> methods = <span class=\"keyword\">this</span>.$options.methods || &#123;&#125;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.entries(methods).forEach(<span class=\"function\">(<span class=\"params\">[key, method]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (method._asyncWrapped) <span class=\"keyword\">return</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> wrappedMethod = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = method.apply(<span class=\"keyword\">this</span>, args)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> resultIsPromise = result &amp;&amp; <span class=\"keyword\">typeof</span> result.then === <span class=\"string\">'function'</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!resultIsPromise) <span class=\"keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"keyword\">async</span> (resolve, reject) =&gt; &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            resolve(<span class=\"keyword\">await</span> result)</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!error._handled) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> errorHandler = Vue.config.errorHandler</span><br><span class=\"line\">              errorHandler(error)</span><br><span class=\"line\">              error._handled = <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            reject(error)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      wrappedMethod._asyncWrapped = <span class=\"literal\">true</span></span><br><span class=\"line\">      methods[key] = wrappedMethod</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch2()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch3()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    fetch2 () &#123;</span><br><span class=\"line\">      Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch2</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fetch3 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">response</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">          <span class=\"keyword\">let</span> info = data.api.fetch3</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过运行并观察console打印可以看出，fetch3的错误被errorHandler捕获，而fetch2的错误并没有。</p>\n<p>那么Promise里的错误统一捕获的问题差不多应该解决了，那么async/await的呢？</p>\n<p>在App.vue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">  created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch4()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.fetch5()</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch4 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch4</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">async</span> fetch5 () &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> response = <span class=\"keyword\">await</span> Vue.request(<span class=\"string\">'https://api.github.com/'</span>)</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = response.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> info = data.api.fetch5</span><br><span class=\"line\">      <span class=\"keyword\">return</span> response</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// ...  </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fetch4并没有返回Promise，fetch5返回的也不是Promise对象，但是当运行的时候我们会发现fetch4和fetch5的错误信息都被捕获了，这是为什么呢？因为async/await本身就是Promise的语法糖，在 <a href=\"https://babeljs.io\" target=\"_blank\" rel=\"noopener\">babeljs</a> 官网的 “Try it out” 尝试用 async/await，你会发现最后编译后的代码就是在外包了一层Promise。</p>\n<h4 id=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"><a href=\"#在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\" class=\"headerlink\" title=\"在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）\"></a>在哪里捕获更为优雅？（尽量以更少的代码覆盖大部分或者全部代码）</h4><p><strong>网络层</strong>：可以在axios.create创建的实例中</p>\n<p><strong>逻辑层</strong>：非Promise本身就会被errorHandler捕获；Promise相关的可以通过全局mixin给返回Promise对象的方法做一个外层包装，统一catch并调用errorHandler处理（<strong><em>这个方法的是否有副作用还需要研究!</em></strong>）</p>\n<h4 id=\"捕获的错误存放在哪？\"><a href=\"#捕获的错误存放在哪？\" class=\"headerlink\" title=\"捕获的错误存放在哪？\"></a>捕获的错误存放在哪？</h4><p><strong># 自己简易服务 ？</strong></p>\n<p>感觉成本很大（人力和工时）</p>\n<p><strong># 官方推荐的 <a href=\"https://sentry.io/\" target=\"_blank\" rel=\"noopener\">Sentry</a>  </strong></p>\n<p>注册后安装官方的JS SDK</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install raven-js --save</span><br></pre></td></tr></table></figure>\n<p>修改main.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> Raven <span class=\"keyword\">from</span> <span class=\"string\">'raven-js'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> RavenVue <span class=\"keyword\">from</span> <span class=\"string\">'raven-js/plugins/vue'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>) <span class=\"comment\">// sentry token</span></span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br><span class=\"line\"></span><br><span class=\"line\">Vue.config.errorHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, vm, info</span>) </span>&#123;</span><br><span class=\"line\">  Raven.captureException(err)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Vue.request = <span class=\"function\">(<span class=\"params\">args</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    request(args).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      resolve(res)</span><br><span class=\"line\">    &#125;).catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">      Raven.captureException(err)</span><br><span class=\"line\">      reject(err)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure>\n<p>修改App.vue （我们从最普通的js测试起）<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\">created () &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.normal()</span><br><span class=\"line\">    <span class=\"comment\">// this.fetch1()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch2()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch3()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch4()</span></span><br><span class=\"line\">    <span class=\"comment\">// this.fetch5()</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure></p>\n<p>打开sentry页面查看<br><img src=\"/images/js-capture-error/1.png\" alt=\"错误报告列表\"><br><img src=\"/images/js-capture-error/2.jpg\" alt=\"错误报告详情（模糊了IP部分）\"><br>我们通过上面2张图片可以看出，sentry自带一个简单的issue管理功能，此外详情页面的错误栈已经方便我们知道问题出在哪里了。</p>\n<p>测试fetch1的ajax请求错误<br><img src=\"/images/js-capture-error/3.jpg\" alt=\"成功截获api1.github.com这个错误域名\"></p>\n<p>除了fetch2无法被捕获外（之前提过，它没有返回Promise对象），其它的都能被捕获。不过Promise和async/await的错误栈比较少。尤其是Promise.then里的错误，如下2张图的对比：</p>\n<p><img src=\"/images/js-capture-error/4.jpg\" alt=\"Promise.then里的错误\"><br><img src=\"/images/js-capture-error/5.jpg\" alt=\"async/await里的错误\"></p>\n<p>除了默认的数据的收集外，还能收集一些其他数据，比如用户信息</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven.setUser(&#123;</span><br><span class=\"line\">    name: <span class=\"string\">'miser name'</span>,</span><br><span class=\"line\">    id: <span class=\"string\">'miser id'</span></span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/js-capture-error/6.jpg\" alt=\"用户信息顺收集\"></p>\n<p><strong>我们测试了代码未被压缩的情况，如果代码压缩了呢？</strong></p>\n<p><img src=\"/images/js-capture-error/7.jpg\" alt=\"通过npm run build 压缩代码打开首页，一脸懵逼\"></p>\n<p>显然我们不能直观的获得错误定位，不过sentry提供<a href=\"https://github.com/google/closure-compiler/wiki/Source-Maps\" target=\"_blank\" rel=\"noopener\">SourceMaps</a>存储服务，它能方便的debug被压缩的代码。</p>\n<p>我们可以通过<a href=\"https://www.npmjs.com/package/webpack-sentry-plugin\" target=\"_blank\" rel=\"noopener\">webpack-sentry-plugin</a>工具将整个上传过程写进webpack里，因为我们的实验环境是vue3，所以我们创建一个vue.config.js文件</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> SentryPlugin = <span class=\"built_in\">require</span>(<span class=\"string\">'webpack-sentry-plugin'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  configureWebpack: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      <span class=\"keyword\">new</span> SentryPlugin(&#123;</span><br><span class=\"line\">        organization: <span class=\"string\">'fe-org'</span>, <span class=\"comment\">// 组织名称 类似公司名吧（一个用户下可以有多个组织）</span></span><br><span class=\"line\">        project: <span class=\"string\">'popcorn-vue'</span>, <span class=\"comment\">// 项目名称 （一个组织下可以有多个项目）</span></span><br><span class=\"line\">        apiKey: <span class=\"string\">'17c7d61a800f495c803196e2c02cadeb1b41454247db4f06a5c54193510da150'</span>,</span><br><span class=\"line\">        release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// 发布后的代码和这个对应，可以找到这个sourcemaps</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改main.js<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Raven</span><br><span class=\"line\">  .config(<span class=\"string\">'https://1dfc5e63808b41058675b4b3aed4cfb6@sentry.io/1298044'</span>, &#123;</span><br><span class=\"line\">    release: <span class=\"string\">'1.2.4-beta'</span> <span class=\"comment\">// 新增</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .addPlugin(RavenVue, Vue)</span><br><span class=\"line\">  .install()</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run build</span><br></pre></td></tr></table></figure>\n<p>查看sentry里popcorn-vue项目中的<strong>版本</strong></p>\n<p><img src=\"/images/js-capture-error/8.jpg\" alt=\"1.2.4-beta是目前的，1.2.3-beta是以前版本\"><br><img src=\"/images/js-capture-error/9.jpg\" alt=\"点击 1.2.4-beta 进去，很容易找到刚刚上传的js和js.map文件\"></p>\n<p>我们打开build完的index.html，虽然错误成功捕获但依旧和上图的一样，无法被SourceMaps解析，大概的原因是js和js.map的目录结构问题。</p>\n<p>这个issue <a href=\"https://github.com/getsentry/sentry-electron/issues/54\" target=\"_blank\" rel=\"noopener\">https://github.com/getsentry/sentry-electron/issues/54</a> 是一个很经典的例子，它犯了2个错误</p>\n<p>– 仅仅传了js.map而没有传被压缩的js文件，它们应该一一对应的上传到服务器上<br>– js和js.map目录路径不匹配</p>\n<p>这2个原因都会导致无法正常解析被压缩的文件。</p>\n<p>那么不直接通过浏览器打开index.html（file:///<strong>**</strong>/vue-capture-error/dist/index.html），通过nginx去模拟正式环境。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br><span class=\"line\">nginx</span><br></pre></td></tr></table></figure></p>\n<p>将build出的代码dist拷贝到nginx默认目录下 /usr/local/var/www/，打开浏览器<a href=\"http://localhost:8080\" target=\"_blank\" rel=\"noopener\">http://localhost:8080</a></p>\n<p>回到sentry中查看新的错误记录</p>\n<p><img src=\"/images/js-capture-error/10.jpg\" alt=\"已经很详细的记录了出错的方法\"></p>"},{"title":"Egg Boot","_content":"\n### **#Preface**\n\nThis article will introduce a web framework called Eggjs for Node.js.\n\nIt bases on Koa and customizes your requirement through a large of plugins and middleware, even an own framework. It is very important that you can create a cluster, an agent process, and some workers process when it is run. The cluster makes it stronger. Next, we can understand it by reading the origin code.\n\nEggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n— lib\n  — / loader (dir)\n  — mixin (dir)\n  — utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n— / app\n— / config\n— / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\n~~We have more discussion about the above code later. I think the cluster field is complex and maybe need to have a new post about it, but other points must know them.~~\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html)】. It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent （*app > plugin*）\n\n  - loadService: load and merge all of the extending of helper object （*app > plugin*）\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) （*app > plugin > core*）\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes request’s path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","source":"_posts/egg-boot.md","raw":"---\ntitle: Egg Boot\ncategory: javascript\n---\n\n### **#Preface**\n\nThis article will introduce a web framework called Eggjs for Node.js.\n\nIt bases on Koa and customizes your requirement through a large of plugins and middleware, even an own framework. It is very important that you can create a cluster, an agent process, and some workers process when it is run. The cluster makes it stronger. Next, we can understand it by reading the origin code.\n\nEggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.\n\n**egg-core**: it extends Koa and is as a parent object of every agent and worker.\n\n**egg**: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.\n\n**egg-cluster**: it creates a cluster and manages them.\n\n**egg-scripts and Egg-bin**: their job is run the whole app in a different environment.\n\n<br/>\n\n_**Tips: We will discuss Eggjs with basing 2.x.x version.**_\n\n<br/>\n\n<!-- more -->\n\n## **#Scan Libs Code**\n\n_* The directory and the code segment are not whole content after this post, these major are only for a better explanation._\n\n### **egg-core**\n\n```\n— lib\n  — / loader (dir)\n  — mixin (dir)\n  — utils (dir)\n  egg.js\n  lifecycle.js\n```\n\nThe above is the directory structure of egg-core.The _**egg.js**_ and folder of the _**loader**_ are important to point for this lib.\n\nSee egg.js\n\n```javascript\nconst KoaApplication = require('koa')\nconst Lifecycle = require('./lifecycle')\n\nclass EggCore extends KoaApplication {\n  constructor(options = {}) {\n    // ...\n    this.lifecycle = new Lifecycle({\n      baseDir: options.baseDir,\n      app: this,\n      logger: this.console\n    })\n\n    const Loader = this[EGG_LOADER]\n    assert(Loader, \"Symbol.for('egg#loader') is required\")\n    this.loader = new Loader({\n      baseDir: options.baseDir,\n      app: this,\n      plugins: options.plugins,\n      logger: this.console,\n      serverScope: options.serverScope,\n      env: options.env\n    })\n    // ...\n  }\n  beforeStart(scope) {\n    this.lifecycle.registerBeforeStart(scope)\n  }\n  ready(flagOrFunction) {\n    return this.lifecycle.ready(flagOrFunction)\n  }\n  get [EGG_LOADER]() {\n    return require('./loader/egg_loader')\n  }\n}\n```\n\nFirst, we can know why it is called that bases on Koa because EggCore extends KoaApplication.\n\nSecond, it defines a few new fields in the construction function, such as _lifecycle_ and _loader_. The _loader_ field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.\n\nAnother side, both _beforeStart_ and _ready_ often are called when we need to write some plugins.\n\n### **egg**\n\n```\n— / app\n— / config\n— / lib\n  - / core\n    - / messenger\n  - / jsdoc\n  - / loader\n  - agent.js\n  - application.js\n  - egg.js\n  - start.js\n- index.js\n```\n\nThere is an egg.js file that is the same name in the egg-core, but it bases on _EggCore Class_ and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.\n\nSee egg.js\n\n```javascript\nconst EggCore = require('egg-core').EggCore\nconst cluster = require('cluster-client')\nconst Messenger = require('./core/messenger')\n\nclass EggApplication extends EggCore {\n  constructor(options = {}) {\n    this.loader.loadConfig()\n    this.messenger = Messenger.create(this)\n\n    // trigger serverDidReady hook when all app workers\n    // and agent worker is ready\n    this.messenger.once('egg-ready', () => {\n      this.lifecycle.triggerServerDidReady()\n    })\n\n    this.ready(() =>\n      process.nextTick(() => {\n        const dumpStartTime = Date.now()\n        this.dumpConfig()\n        this.dumpTiming()\n        this.coreLogger.info(\n          '[egg:core] dump config after ready, %s',\n          ms(Date.now() - dumpStartTime)\n        )\n      })\n    )\n\n    this.cluster = (clientClass, options) => {\n      options = Object.assign({}, this.config.clusterClient, options, {\n        singleMode: this.options.mode === 'single',\n        // cluster need a port that can't conflict on the environment\n        port: this.options.clusterPort,\n        // agent worker is leader, app workers are follower\n        isLeader: this.type === 'agent',\n        logger: this.coreLogger\n      })\n      const client = cluster(clientClass, options)\n      this._patchClusterClient(client)\n      return client\n    }\n  }\n}\n```\n\n~~We have more discussion about the above code later. I think the cluster field is complex and maybe need to have a new post about it, but other points must know them.~~\n\nSee agent.js and application.js\n\n```javascript\n// agent.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AgentWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Agent extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'agent'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AgentWorkerLoader\n  }\n}\n\n// application.js\nconst EggApplication = require('./egg')\nconst AgentWorkerLoader = require('./loader').AppWorkerLoader\nconst EGG_LOADER = Symbol.for('egg#loader')\n\nclass Application extends EggApplication {\n  constructor(options = {}) {\n    options.type = 'application'\n    super(options)\n    this.loader.load()\n  }\n  get [EGG_LOADER]() {\n    return AppWorkerLoader\n  }\n}\n```\n\nWe can see that they override the _EGG_LOADER_ property, which uses to create a new _loader_ field in the construction of EggCore that is their parent class. Finally, they call the _load_ function.\n\nWe have the base application code. rNext, look a few of libs for starting web app.\n\n### **egg-scripts and egg-bin**\n\nBoth these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don't know them at most of time.\n\n```javascript\n// package.json\n{\n  \"scripts\": {\n    \"start\": \"env egg-scripts start\",\n    \"dev\": \"env egg-bin dev\",\n    \"stop\": \"egg-scripts stop\",\n    \"debug\": \"egg-bin debug\",\n    \"test\": \"npm run lint -- --fix && npm run test-local\",\n    \"test-local\": \"env egg-bin test\",\n    \"cov\": \"egg-bin cov\"\n}\n```\n\nThe _scripts_ command of this eggjs app conforms to the above description.\n\n### **egg-cluster**\n\nThe cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.\n\n```\n- / lib\n  - / utils\n  - agent_worker.js\n  - app_worker.js\n  - master.js\n- index.js\n```\n\nI had written an [article](/2019/01/18/egg-cluster) about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.\n\n## **#From start to getting the first request**\n\n**What happens when we input `npm run dev` or `npm start` in the terminal?**\n\n- **egg-scripts(prod):** it can require _framework_ by `child_process.spawn` and calls _startCluster_ function.\n- **egg-bin(dev):** it can require _framework_ by `child_process.fork` and calls _startCluster_ function.\n- `[parent process]`: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the `framework` is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as `--framework { your path }`\n\n**Pseudo Code**\n\n```javascript\n// egg-scripts\n// parent process\nconst spawn = require('child_process').spawn // create new process\nspawn('node', 'require({{ framework path }}).startCluster(...)', options))\n\n// egg-bin\n// parent process\nconst cp = require('child_process')\ncp.fork('require({{ framework path }}).startCluster(...)', args, options) // create new process\n```\n\nEgg-scripts uses `spawn` function to require framework while egg-scripts calls `fork` function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.\n\nWe have two processes. In general, this newly created process is called the master process.\n\n**Why is the master process called birdge?**\n\n```javascript\n// egg index.js\nexports.startCluster = require('egg-cluster').startCluster\n```\n\nActually, we exec `egg-cluster`'s startCluster function when we require the framework. We open `index.js` file in the egg-cluster lib. \n\n__First, it is real enter point for whole web app.__\n\n```javascript\n// index.js\nconst Master = require('./lib/master')\nexports.startCluster = function(options, callback) {\n  new Master(options).ready(callback)\n}\n\n// ./lib/master.js\nconst ready = require('get-ready')\nconst detectPort = require('detect-port')\nconst Manager = require('./utils/manager')\nconst Messenger = require('./utils/messenger')\n\nclass Master extends EventEmitter {\n  constructor(options) {\n    super()\n    this.options = parseOptions(options)\n    this.workerManager = new Manager()\n    this.messenger = new Messenger(this)\n\n    ready.mixin(this)\n\n    this.ready(() => {\n      this.isStarted = true\n      const action = 'egg-ready'\n      this.messenger.send({\n        action,\n        to: 'parent',\n        data: { port: this[REALPORT], address: this[APP_ADDRESS] }\n      })\n      this.messenger.send({ action, to: 'app', data: this.options })\n      this.messenger.send({ action, to: 'agent', data: this.options })\n\n      // start check agent and worker status\n      if (this.isProduction) {\n        this.workerManager.startCheck()\n      }\n    })\n\n    // fork app workers after agent started\n    this.once('agent-start', this.forkAppWorkers.bind(this))\n\n    detectPort((err, port) => {\n      /* istanbul ignore if */\n      if (err) {\n        err.name = 'ClusterPortConflictError'\n        err.message = '[master] try get free port error, ' + err.message\n        this.logger.error(err)\n        process.exit(1)\n      }\n      this.options.clusterPort = port\n      this.forkAgentWorker()\n    })\n  }\n  forkAppWorkers() {\n    // ...\n    cluster.on('fork', worker => {\n      // ...\n      worker.on('message', msg => {\n        if (typeof msg === 'string') msg = { action: msg, data: msg };\n        msg.from = 'app';\n        this.messenger.send(msg);\n      });\n      // ...\n    })\n  }\n  forkAgentWorker() {\n    // ...\n    agentWorker.on('message', msg => {\n      if (typeof msg === 'string') msg = { action: msg, data: msg };\n      msg.from = 'agent';\n      this.messenger.send(msg);\n    });\n    // ...\n  }\n}\n\n\n// the callback of ready function will be trigger after all major boots had been loaded\n\n// forkAgentWorker\nconst agent = new Agent(options)\nagent.ready(err => {\n  if (err) return\n  process.send({ action: 'agent-start', to: 'master' })\n})\n\n// fork a single worker\nconst app = new Application(options);\nfunction startServer(err) {  \n  let server;\n  if (options.https) {\n    const httpsOptions = Object.assign({}, options.https, {\n      key: fs.readFileSync(options.https.key),\n      cert: fs.readFileSync(options.https.cert),\n    });\n    server = require('https').createServer(httpsOptions, app.callback());\n  } else {\n    server = require('http').createServer(app.callback());\n  }\n\n  // emit `server` event in app\n  app.emit('server', server);\n  \n  server.listen(...args);\n}\napp.ready(startServer);\n```\n\nOn the other hand, this web will be constructed during creating a `Master` object.\n\n- workerManager: it will hold on all worker porcesses.\n- messenger: we make `master` a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an [article(Chinese)]([http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC)) about it.\n\n> - The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)\n> - EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）\n> - Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master\n\n- ready.mixin & this.ready: 'get-ready' often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.\n\n- detectPort: apply for an available port, default is 7001.If Successly, it will `fork` an agent process and register a callback message for new created an agent object.\n\n- `[agent process]`: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.\n\n  - loadPlugin: find all plugin, record their dir paths => this.dirs\n\n  - loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.\n  - loadAgentExtend: load and merge all of the extending of agent object  (*app > plugin > core*)\n  - loadContextExtend: load and merge all of the extending of context object  (*app > plugin > core*)\n  - loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【[Application Startup Configuration(official)](https://eggjs.org/en/basics/app-start.html)】. It help you for better writing a few plugins.\n  - Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending `'agent-start'` to the master process.\n\n![egg boot process](/images/egg-boot/egg-boot.jpg)\n\n- `[master process]`: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get `'agent-start'` message from the agent process. It will open a new relatable load, we take a single worker process example.\n\n- `[a single worker process]`: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.\n\n  - loadPlugin: same as the agent\n\n  - loadConfig: same as the agent\n\n  - loadApplicationExtend: same as the agent  (*app > plugin > core*)\n\n  - loadRequestExtend: load and merge all of the extending of request object (*app > plugin > core*)\n\n  - loadResponseExtend: load and merge all of the extending of response object (*app > plugin > core*)\n\n  - loadContextExtend: same as the agent\n\n  - loadHelperExtend: load and merge all of the extending of helper object (*app > plugin > core*)\n\n  - loadCustomApp: same as the agent （*app > plugin*）\n\n  - loadService: load and merge all of the extending of helper object （*app > plugin*）\n\n  - loadMiddleware: load middlewares and iterate them => mw, if it conforms the middleware standard, it will be used with app.use(mw) （*app > plugin > core*）\n\n  - loadController: iterate all controllers' functions => key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only *app*). This middleware will be triggered when getting a new request, the Controller is defined in the `app/controller ` directory and the key is it's function.\n\n    ```javascript\n    function methodToMiddleware(Controller, key) {\n      return function classControllerMiddleware(...args) {\n        const controller = new Controller(this);\n        if (!this.app.config.controller || !this.app.config.controller.supportParams) {\n          args = [ this ];\n        }\n        return utils.callFn(controller[key], args, controller);\n      };\n    }\n    ```\n\n    \n\n  - loadRouter: it makes request’s path associated with the controllers' function that has been become to middleware (only *app*)\n\n  - loadCustomLoader: load ourselves function to create some built-in objects for app object or other.[Customloader](https://eggjs.org/en/advanced/loader.html#customloader)\n\n- `[master process]`: it listens to all worker processes and triggers the master's ready once they have finished booting.\n- send `egg-ready` to the parent process, the agent process, the app worker processes\n- Last, traverse BOOTS and run serverDidReady function of each item.\n\nIt is the whole boot for Eggjs framework but doesn't include, such as restarting a worker process when it exits or disconnects,  shuting down...\n\n__Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.__\n\n\n\n**What happens when web app get an Http request?**\n\n*We only discuss Eggjs code in the applaction layer. :)*\n\nThe `agent` can't deal with any request because it doesn't listen port. All request always hand over to `workers`. We look at creating worker code, it will run a app.callback function and listen port when it has booted.\n\nThis callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller's function.\n\n```javascript\n// koa/lib/application\nclass Application extends Emitter {\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }\n  handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }\n}\n\n// egg/lib/application\nclass Application extends EggApplication {\n\thandleRequest(ctx, fnMiddleware) {\n    this.emit('request', ctx)\n    super.handleRequest(ctx, fnMiddleware)\n    onFinished(ctx.res, () => this.emit('response', ctx))\n  }\n}\n```\n\n\n\n__In summary, we have know how to boot web app and deal with request in Eggjs.__ When we know it, we can easily write some plugins and middlewares to finish the business requirements.\n\n","slug":"egg-boot","published":1,"date":"2019-05-09T15:01:08.568Z","updated":"2019-06-01T14:36:04.985Z","_id":"cjw5sp0iy0000sf8qepavc82p","comments":1,"layout":"post","photos":[],"link":"","content":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce a web framework called Eggjs for Node.js.</p>\n<p>It bases on Koa and customizes your requirement through a large of plugins and middleware, even an own framework. It is very important that you can create a cluster, an agent process, and some workers process when it is run. The cluster makes it stronger. Next, we can understand it by reading the origin code.</p>\n<p>Eggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>\n<a id=\"more\"></a>\n<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— lib</span><br><span class=\"line\">  — / loader (dir)</span><br><span class=\"line\">  — mixin (dir)</span><br><span class=\"line\">  — utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> KoaApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Lifecycle = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggCore</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle = <span class=\"hljs-keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> Loader = <span class=\"hljs-keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"hljs-string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader = <span class=\"hljs-keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"hljs-keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"hljs-keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— / app</span><br><span class=\"line\">— / config</span><br><span class=\"line\">— / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggCore = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EggApplication</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = Messenger.create(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger.once(<span class=\"hljs-string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> dumpStartTime = <span class=\"hljs-built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"hljs-string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"hljs-built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.cluster = <span class=\"hljs-function\">(<span class=\"hljs-params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, <span class=\"hljs-keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"hljs-keyword\">this</span>.options.mode === <span class=\"hljs-string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"hljs-keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"hljs-comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"hljs-keyword\">this</span>.type === <span class=\"hljs-string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"hljs-keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><del>We have more discussion about the above code later. I think the cluster field is complex and maybe need to have a new post about it, but other points must know them.</del></p>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Agent</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'agent'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// application.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EggApplication = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> AgentWorkerLoader = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> EGG_LOADER = <span class=\"hljs-built_in\">Symbol</span>.for(<span class=\"hljs-string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"hljs-string\">'application'</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don’t know them at most of time.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"hljs-string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"hljs-string\">\"start\"</span>: <span class=\"hljs-string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"dev\"</span>: <span class=\"hljs-string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"stop\"</span>: <span class=\"hljs-string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"debug\"</span>: <span class=\"hljs-string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test\"</span>: <span class=\"hljs-string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"test-local\"</span>: <span class=\"hljs-string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"hljs-string\">\"cov\"</span>: <span class=\"hljs-string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> spawn = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>).spawn <span class=\"hljs-comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"hljs-string\">'node'</span>, <span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"hljs-comment\">// parent process</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> cp = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"hljs-string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"hljs-comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>‘s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// index.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Master = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> ready = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> detectPort = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Manager = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> Messenger = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Master</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.workerManager = <span class=\"hljs-keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.messenger = <span class=\"hljs-keyword\">new</span> Messenger(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"hljs-keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.isStarted = <span class=\"hljs-literal\">true</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> action = <span class=\"hljs-string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"hljs-string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"hljs-attr\">port</span>: <span class=\"hljs-keyword\">this</span>[REALPORT], <span class=\"hljs-attr\">address</span>: <span class=\"hljs-keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'app'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(&#123; action, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'agent'</span>, <span class=\"hljs-attr\">data</span>: <span class=\"hljs-keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.once(<span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-keyword\">this</span>.forkAppWorkers.bind(<span class=\"hljs-keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"hljs-function\">(<span class=\"hljs-params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"hljs-string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"hljs-string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"hljs-string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"hljs-string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"hljs-string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> msg === <span class=\"hljs-string\">'string'</span>) msg = &#123; <span class=\"hljs-attr\">action</span>: msg, <span class=\"hljs-attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"hljs-string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"hljs-comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> agent = <span class=\"hljs-keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">'agent-start'</span>, <span class=\"hljs-attr\">to</span>: <span class=\"hljs-string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">startServer</span>(<span class=\"hljs-params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"hljs-keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> httpsOptions = <span class=\"hljs-built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"hljs-keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"hljs-string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: ‘get-ready’ often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>】. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) （<em>app &gt; plugin &gt; core</em>）</p>\n</li>\n<li><p>loadController: iterate all controllers’ functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is it’s function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">methodToMiddleware</span>(<span class=\"hljs-params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">classControllerMiddleware</span>(<span class=\"hljs-params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> controller = <span class=\"hljs-keyword\">new</span> Controller(<span class=\"hljs-keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.app.config.controller || !<span class=\"hljs-keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"hljs-keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes request’s path associated with the controllers’ function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the master’s ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesn’t include, such as restarting a worker process when it exits or disconnects,  shuting down…</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> can’t deal with any request because it doesn’t listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller’s function.</p>\n<figure class=\"highlight javascript hljs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> fn = compose(<span class=\"hljs-keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">this</span>.listenerCount(<span class=\"hljs-string\">'error'</span>)) <span class=\"hljs-keyword\">this</span>.on(<span class=\"hljs-string\">'error'</span>, <span class=\"hljs-keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleRequest = <span class=\"hljs-function\">(<span class=\"hljs-params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">const</span> ctx = <span class=\"hljs-keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"hljs-number\">404</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> onerror = <span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">const</span> handleResponse = <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"hljs-keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"hljs-keyword\">this</span>.emit(<span class=\"hljs-string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>\n","site":{"data":{}},"_categories":[{"name":"javascript","path":"categories/javascript/"}],"_tags":[],"excerpt":"<h3 id=\"Preface\"><a href=\"#Preface\" class=\"headerlink\" title=\"#Preface\"></a><strong>#Preface</strong></h3><p>This article will introduce a web framework called Eggjs for Node.js.</p>\n<p>It bases on Koa and customizes your requirement through a large of plugins and middleware, even an own framework. It is very important that you can create a cluster, an agent process, and some workers process when it is run. The cluster makes it stronger. Next, we can understand it by reading the origin code.</p>\n<p>Eggjs has a few major libs, egg-core、egg、egg-cluster、egg-bin、egg-scripts and so on.</p>\n<p><strong>egg-core</strong>: it extends Koa and is as a parent object of every agent and worker.</p>\n<p><strong>egg</strong>: it defines some actions for agent and worker,  you can almost use these actions to create an app of a single process.</p>\n<p><strong>egg-cluster</strong>: it creates a cluster and manages them.</p>\n<p><strong>egg-scripts and Egg-bin</strong>: their job is run the whole app in a different environment.</p>\n<p><br></p>\n<p><em><strong>Tips: We will discuss Eggjs with basing 2.x.x version.</strong></em></p>\n<p><br></p>","more":"<h2 id=\"Scan-Libs-Code\"><a href=\"#Scan-Libs-Code\" class=\"headerlink\" title=\"#Scan Libs Code\"></a><strong>#Scan Libs Code</strong></h2><p><em>* The directory and the code segment are not whole content after this post, these major are only for a better explanation.</em></p>\n<h3 id=\"egg-core\"><a href=\"#egg-core\" class=\"headerlink\" title=\"egg-core\"></a><strong>egg-core</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— lib</span><br><span class=\"line\">  — / loader (dir)</span><br><span class=\"line\">  — mixin (dir)</span><br><span class=\"line\">  — utils (dir)</span><br><span class=\"line\">  egg.js</span><br><span class=\"line\">  lifecycle.js</span><br></pre></td></tr></table></figure>\n<p>The above is the directory structure of egg-core.The <em><strong>egg.js</strong></em> and folder of the <em><strong>loader</strong></em> are important to point for this lib.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> KoaApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Lifecycle = <span class=\"built_in\">require</span>(<span class=\"string\">'./lifecycle'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggCore</span> <span class=\"keyword\">extends</span> <span class=\"title\">KoaApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle = <span class=\"keyword\">new</span> Lifecycle(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> Loader = <span class=\"keyword\">this</span>[EGG_LOADER]</span><br><span class=\"line\">    assert(Loader, <span class=\"string\">\"Symbol.for('egg#loader') is required\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader = <span class=\"keyword\">new</span> Loader(&#123;</span><br><span class=\"line\">      baseDir: options.baseDir,</span><br><span class=\"line\">      app: <span class=\"keyword\">this</span>,</span><br><span class=\"line\">      plugins: options.plugins,</span><br><span class=\"line\">      logger: <span class=\"keyword\">this</span>.console,</span><br><span class=\"line\">      serverScope: options.serverScope,</span><br><span class=\"line\">      env: options.env</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  beforeStart(scope) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.lifecycle.registerBeforeStart(scope)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ready(flagOrFunction) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.lifecycle.ready(flagOrFunction)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">require</span>(<span class=\"string\">'./loader/egg_loader'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>First, we can know why it is called that bases on Koa because EggCore extends KoaApplication.</p>\n<p>Second, it defines a few new fields in the construction function, such as <em>lifecycle</em> and <em>loader</em>. The <em>loader</em> field helps app for creating important feature include config、plugin、controller、extend、router、middleware、service and so on, it will load some js file in the special directory when the app is starting.</p>\n<p>Another side, both <em>beforeStart</em> and <em>ready</em> often are called when we need to write some plugins.</p>\n<h3 id=\"egg\"><a href=\"#egg\" class=\"headerlink\" title=\"egg\"></a><strong>egg</strong></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">— / app</span><br><span class=\"line\">— / config</span><br><span class=\"line\">— / lib</span><br><span class=\"line\">  - / core</span><br><span class=\"line\">    - / messenger</span><br><span class=\"line\">  - / jsdoc</span><br><span class=\"line\">  - / loader</span><br><span class=\"line\">  - agent.js</span><br><span class=\"line\">  - application.js</span><br><span class=\"line\">  - egg.js</span><br><span class=\"line\">  - start.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>There is an egg.js file that is the same name in the egg-core, but it bases on <em>EggCore Class</em> and extends the lifecycle field, creates new messenger field and cluster field and dumps app config info.</p>\n<p>See egg.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> EggCore = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-core'</span>).EggCore</span><br><span class=\"line\"><span class=\"keyword\">const</span> cluster = <span class=\"built_in\">require</span>(<span class=\"string\">'cluster-client'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./core/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EggApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggCore</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.loadConfig()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = Messenger.create(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// trigger serverDidReady hook when all app workers</span></span><br><span class=\"line\">    <span class=\"comment\">// and agent worker is ready</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger.once(<span class=\"string\">'egg-ready'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.lifecycle.triggerServerDidReady()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span></span><br><span class=\"line\">      process.nextTick(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> dumpStartTime = <span class=\"built_in\">Date</span>.now()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpConfig()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.dumpTiming()</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.coreLogger.info(</span><br><span class=\"line\">          <span class=\"string\">'[egg:core] dump config after ready, %s'</span>,</span><br><span class=\"line\">          ms(<span class=\"built_in\">Date</span>.now() - dumpStartTime)</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.cluster = <span class=\"function\">(<span class=\"params\">clientClass, options</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      options = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, <span class=\"keyword\">this</span>.config.clusterClient, options, &#123;</span><br><span class=\"line\">        singleMode: <span class=\"keyword\">this</span>.options.mode === <span class=\"string\">'single'</span>,</span><br><span class=\"line\">        <span class=\"comment\">// cluster need a port that can't conflict on the environment</span></span><br><span class=\"line\">        port: <span class=\"keyword\">this</span>.options.clusterPort,</span><br><span class=\"line\">        <span class=\"comment\">// agent worker is leader, app workers are follower</span></span><br><span class=\"line\">        isLeader: <span class=\"keyword\">this</span>.type === <span class=\"string\">'agent'</span>,</span><br><span class=\"line\">        logger: <span class=\"keyword\">this</span>.coreLogger</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> client = cluster(clientClass, options)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>._patchClusterClient(client)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> client</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><del>We have more discussion about the above code later. I think the cluster field is complex and maybe need to have a new post about it, but other points must know them.</del></p>\n<p>See agent.js and application.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// agent.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AgentWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Agent</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'agent'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AgentWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// application.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> EggApplication = <span class=\"built_in\">require</span>(<span class=\"string\">'./egg'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> AgentWorkerLoader = <span class=\"built_in\">require</span>(<span class=\"string\">'./loader'</span>).AppWorkerLoader</span><br><span class=\"line\"><span class=\"keyword\">const</span> EGG_LOADER = <span class=\"built_in\">Symbol</span>.for(<span class=\"string\">'egg#loader'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class=\"line\">    options.type = <span class=\"string\">'application'</span></span><br><span class=\"line\">    <span class=\"keyword\">super</span>(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.loader.load()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  get [EGG_LOADER]() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> AppWorkerLoader</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We can see that they override the _EGG_LOADER_ property, which uses to create a new <em>loader</em> field in the construction of EggCore that is their parent class. Finally, they call the <em>load</em> function.</p>\n<p>We have the base application code. rNext, look a few of libs for starting web app.</p>\n<h3 id=\"egg-scripts-and-egg-bin\"><a href=\"#egg-scripts-and-egg-bin\" class=\"headerlink\" title=\"egg-scripts and egg-bin\"></a><strong>egg-scripts and egg-bin</strong></h3><p>Both these libs start the web app in a different environment. Egg-scripts is easier and more clear, uses the production environment. Egg-bin has much code for helping debug, dev, test and so on, we usually use it in the dev, debug or test environment. We almost don’t know them at most of time.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// package.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"start\"</span>: <span class=\"string\">\"env egg-scripts start\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"dev\"</span>: <span class=\"string\">\"env egg-bin dev\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"stop\"</span>: <span class=\"string\">\"egg-scripts stop\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"debug\"</span>: <span class=\"string\">\"egg-bin debug\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test\"</span>: <span class=\"string\">\"npm run lint -- --fix &amp;&amp; npm run test-local\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"test-local\"</span>: <span class=\"string\">\"env egg-bin test\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"cov\"</span>: <span class=\"string\">\"egg-bin cov\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The <em>scripts</em> command of this eggjs app conforms to the above description.</p>\n<h3 id=\"egg-cluster\"><a href=\"#egg-cluster\" class=\"headerlink\" title=\"egg-cluster\"></a><strong>egg-cluster</strong></h3><p>The cluster is an important feature for Eggjs. This lib is a bridge for connecting one single agent process and many workers processes. It like a manager.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- / lib</span><br><span class=\"line\">  - / utils</span><br><span class=\"line\">  - agent_worker.js</span><br><span class=\"line\">  - app_worker.js</span><br><span class=\"line\">  - master.js</span><br><span class=\"line\">- index.js</span><br></pre></td></tr></table></figure>\n<p>I had written an <a href=\"/2019/01/18/egg-cluster\">article</a> about egg-cluster in Chinese. I always think this is the core of Eggjs, so I will explain the whole Eggjs framework around it.</p>\n<h2 id=\"From-start-to-getting-the-first-request\"><a href=\"#From-start-to-getting-the-first-request\" class=\"headerlink\" title=\"#From start to getting the first request\"></a><strong>#From start to getting the first request</strong></h2><p><strong>What happens when we input <code>npm run dev</code> or <code>npm start</code> in the terminal?</strong></p>\n<ul>\n<li><strong>egg-scripts(prod):</strong> it can require <em>framework</em> by <code>child_process.spawn</code> and calls <em>startCluster</em> function.</li>\n<li><strong>egg-bin(dev):</strong> it can require <em>framework</em> by <code>child_process.fork</code> and calls <em>startCluster</em> function.</li>\n<li><code>[parent process]</code>: The command of running is in one process called the parent process. The system will create a new process called the master process when the parent process requires a framework.As usual, the <code>framework</code> is the file path of Eggjs.If you want to use a custom framework, you can add a param in the command, such as <code>--framework { your path }</code></li>\n</ul>\n<p><strong>Pseudo Code</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg-scripts</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> spawn = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>).spawn <span class=\"comment\">// create new process</span></span><br><span class=\"line\">spawn(<span class=\"string\">'node'</span>, <span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, options))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg-bin</span></span><br><span class=\"line\"><span class=\"comment\">// parent process</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cp = <span class=\"built_in\">require</span>(<span class=\"string\">'child_process'</span>)</span><br><span class=\"line\">cp.fork(<span class=\"string\">'require(&#123;&#123; framework path &#125;&#125;).startCluster(...)'</span>, args, options) <span class=\"comment\">// create new process</span></span><br></pre></td></tr></table></figure>\n<p>Egg-scripts uses <code>spawn</code> function to require framework while egg-scripts calls <code>fork</code> function.The latter is a special case of the former. Egg-bin has more code than egg-scripts, these features help us for developing or debug the app.</p>\n<p>We have two processes. In general, this newly created process is called the master process.</p>\n<p><strong>Why is the master process called birdge?</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// egg index.js</span></span><br><span class=\"line\">exports.startCluster = <span class=\"built_in\">require</span>(<span class=\"string\">'egg-cluster'</span>).startCluster</span><br></pre></td></tr></table></figure>\n<p>Actually, we exec <code>egg-cluster</code>‘s startCluster function when we require the framework. We open <code>index.js</code> file in the egg-cluster lib. </p>\n<p><strong>First, it is real enter point for whole web app.</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> Master = <span class=\"built_in\">require</span>(<span class=\"string\">'./lib/master'</span>)</span><br><span class=\"line\">exports.startCluster = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">new</span> Master(options).ready(callback)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ./lib/master.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> ready = <span class=\"built_in\">require</span>(<span class=\"string\">'get-ready'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> detectPort = <span class=\"built_in\">require</span>(<span class=\"string\">'detect-port'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Manager = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/manager'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Messenger = <span class=\"built_in\">require</span>(<span class=\"string\">'./utils/messenger'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Master</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventEmitter</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>(options) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.options = parseOptions(options)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.workerManager = <span class=\"keyword\">new</span> Manager()</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.messenger = <span class=\"keyword\">new</span> Messenger(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    ready.mixin(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.ready(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.isStarted = <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = <span class=\"string\">'egg-ready'</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123;</span><br><span class=\"line\">        action,</span><br><span class=\"line\">        to: <span class=\"string\">'parent'</span>,</span><br><span class=\"line\">        data: &#123; <span class=\"attr\">port</span>: <span class=\"keyword\">this</span>[REALPORT], <span class=\"attr\">address</span>: <span class=\"keyword\">this</span>[APP_ADDRESS] &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'app'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(&#123; action, <span class=\"attr\">to</span>: <span class=\"string\">'agent'</span>, <span class=\"attr\">data</span>: <span class=\"keyword\">this</span>.options &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// start check agent and worker status</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.isProduction) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.workerManager.startCheck()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// fork app workers after agent started</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.once(<span class=\"string\">'agent-start'</span>, <span class=\"keyword\">this</span>.forkAppWorkers.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    detectPort(<span class=\"function\">(<span class=\"params\">err, port</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* istanbul ignore if */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">        err.name = <span class=\"string\">'ClusterPortConflictError'</span></span><br><span class=\"line\">        err.message = <span class=\"string\">'[master] try get free port error, '</span> + err.message</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.logger.error(err)</span><br><span class=\"line\">        process.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.options.clusterPort = port</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.forkAgentWorker()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAppWorkers() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    cluster.on(<span class=\"string\">'fork'</span>, worker =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">      worker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">        msg.from = <span class=\"string\">'app'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  forkAgentWorker() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">    agentWorker.on(<span class=\"string\">'message'</span>, msg =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> msg === <span class=\"string\">'string'</span>) msg = &#123; <span class=\"attr\">action</span>: msg, <span class=\"attr\">data</span>: msg &#125;;</span><br><span class=\"line\">      msg.from = <span class=\"string\">'agent'</span>;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.messenger.send(msg);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// the callback of ready function will be trigger after all major boots had been loaded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// forkAgentWorker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> agent = <span class=\"keyword\">new</span> Agent(options)</span><br><span class=\"line\">agent.ready(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span></span><br><span class=\"line\">  process.send(&#123; <span class=\"attr\">action</span>: <span class=\"string\">'agent-start'</span>, <span class=\"attr\">to</span>: <span class=\"string\">'master'</span> &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// fork a single worker</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Application(options);</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">startServer</span>(<span class=\"params\">err</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> server;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.https) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> httpsOptions = <span class=\"built_in\">Object</span>.assign(&#123;&#125;, options.https, &#123;</span><br><span class=\"line\">      key: fs.readFileSync(options.https.key),</span><br><span class=\"line\">      cert: fs.readFileSync(options.https.cert),</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'https'</span>).createServer(httpsOptions, app.callback());</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>).createServer(app.callback());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// emit `server` event in app</span></span><br><span class=\"line\">  app.emit(<span class=\"string\">'server'</span>, server);</span><br><span class=\"line\">  </span><br><span class=\"line\">  server.listen(...args);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">app.ready(startServer);</span><br></pre></td></tr></table></figure>\n<p>On the other hand, this web will be constructed during creating a <code>Master</code> object.</p>\n<ul>\n<li>workerManager: it will hold on all worker porcesses.</li>\n<li>messenger: we make <code>master</code> a transit station that helps process for communicating (IPC). If you read more code, you can get it. I have said above that it is a bridge. I have write an <a href=\"[http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E5%91%A2-IPC](http://localhost:4000/2019/01/18/egg-cluster/#Agent-Works怎么通信呢-IPC\">article(Chinese)</a>) about it.</li>\n</ul>\n<blockquote>\n<ul>\n<li>The Master maintains a Messenger instance (egg-cluster/lib/utils/messenger.js)</li>\n<li>EggApplication maintain the other Messenge instance （egg/lib/core/messenger.js）</li>\n<li>Both the agent and worker process base on EggApplication, them can send info to the master process creating them when calling Messenger. The master process is according to entering params to transmit to the agent or worker, you read forkAppWorkers and forkAgentWorker function in the master</li>\n</ul>\n</blockquote>\n<ul>\n<li><p>ready.mixin &amp; this.ready: ‘get-ready’ often is used by the official when an object need trigger a few callbacks after it whole initializes. Here it will broadcast an event to the parent, workers and then agent process, telling them that I am ok.</p>\n</li>\n<li><p>detectPort: apply for an available port, default is 7001.If Successly, it will <code>fork</code> an agent process and register a callback message for new created an agent object.</p>\n</li>\n<li><p><code>[agent process]</code>: create new Agent and run loadPlugin, loadConfig, loadAgentExtend, loadContextExtend, and loadCustomAgent.</p>\n<ul>\n<li><p>loadPlugin: find all plugin, record their dir paths =&gt; this.dirs</p>\n</li>\n<li><p>loadConfig: merge all config, the config content of the app level is more priority than the framework and the latter is more priority than the plugin.</p>\n</li>\n<li>loadAgentExtend: load and merge all of the extending of agent object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadContextExtend: load and merge all of the extending of context object  (<em>app &gt; plugin &gt; core</em>)</li>\n<li>loadCustomAgent: it is important that the lifecycle of app boot will be serially triggered. This lifecycle field is defined in EggCore constructor, we can look at the whole process in the yellow background under the image.【<a href=\"https://eggjs.org/en/basics/app-start.html\" target=\"_blank\" rel=\"noopener\">Application Startup Configuration(official)</a>】. It help you for better writing a few plugins.</li>\n<li>Last, all major boots had been loaded, the agent process will trigger function registered in the callback array, such as sending <code>&#39;agent-start&#39;</code> to the master process.</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"/images/egg-boot/egg-boot.jpg\" alt=\"egg boot process\"></p>\n<ul>\n<li><p><code>[master process]</code>: start to fork a few worker processes in accordance with specifying or using the default being CPU kernel count after the master process get <code>&#39;agent-start&#39;</code> message from the agent process. It will open a new relatable load, we take a single worker process example.</p>\n</li>\n<li><p><code>[a single worker process]</code>: create new Agent and run loadPlugin, loadConfig, loadApplicationExtend, loadRequestExtend, loadResponseExtend, loadContextExtend, loadHelperExtend, loadCustomApp, loadService, loadMiddleware, loadController, loadRouter, and loadCustomLoader.</p>\n<ul>\n<li><p>loadPlugin: same as the agent</p>\n</li>\n<li><p>loadConfig: same as the agent</p>\n</li>\n<li><p>loadApplicationExtend: same as the agent  (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadRequestExtend: load and merge all of the extending of request object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadResponseExtend: load and merge all of the extending of response object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadContextExtend: same as the agent</p>\n</li>\n<li><p>loadHelperExtend: load and merge all of the extending of helper object (<em>app &gt; plugin &gt; core</em>)</p>\n</li>\n<li><p>loadCustomApp: same as the agent （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadService: load and merge all of the extending of helper object （<em>app &gt; plugin</em>）</p>\n</li>\n<li><p>loadMiddleware: load middlewares and iterate them =&gt; mw, if it conforms the middleware standard, it will be used with app.use(mw) （<em>app &gt; plugin &gt; core</em>）</p>\n</li>\n<li><p>loadController: iterate all controllers’ functions =&gt; key, wrap a function, make it be a middleware function and is bound to controller.xxx.xxx (only <em>app</em>). This middleware will be triggered when getting a new request, the Controller is defined in the <code>app/controller</code> directory and the key is it’s function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">methodToMiddleware</span>(<span class=\"params\">Controller, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">classControllerMiddleware</span>(<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> controller = <span class=\"keyword\">new</span> Controller(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.app.config.controller || !<span class=\"keyword\">this</span>.app.config.controller.supportParams) &#123;</span><br><span class=\"line\">      args = [ <span class=\"keyword\">this</span> ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> utils.callFn(controller[key], args, controller);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>loadRouter: it makes request’s path associated with the controllers’ function that has been become to middleware (only <em>app</em>)</p>\n</li>\n<li><p>loadCustomLoader: load ourselves function to create some built-in objects for app object or other.<a href=\"https://eggjs.org/en/advanced/loader.html#customloader\" target=\"_blank\" rel=\"noopener\">Customloader</a></p>\n</li>\n</ul>\n<ul>\n<li><code>[master process]</code>: it listens to all worker processes and triggers the master’s ready once they have finished booting.</li>\n<li>send <code>egg-ready</code> to the parent process, the agent process, the app worker processes</li>\n<li>Last, traverse BOOTS and run serverDidReady function of each item.</li>\n</ul>\n<p>It is the whole boot for Eggjs framework but doesn’t include, such as restarting a worker process when it exits or disconnects,  shuting down…</p>\n<p><strong>Second, every process is alone if we have not the master. It like a bridge organizing all island, from creation to IPC.</strong></p>\n<p><strong>What happens when web app get an Http request?</strong></p>\n<p><em>We only discuss Eggjs code in the applaction layer. :)</em></p>\n<p>The <code>agent</code> can’t deal with any request because it doesn’t listen port. All request always hand over to <code>workers</code>. We look at creating worker code, it will run a app.callback function and listen port when it has booted.</p>\n<p>This callback is the members of Appliaction in Koa. If server get new request, it will create a new context and handle it. In Eggjs, this handleRequest function has been overwrited. Last, the framework will iterate over all middleware under the current route including the converted controller’s function.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// koa/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">Emitter</span> </span>&#123;</span><br><span class=\"line\">  callback() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> fn = compose(<span class=\"keyword\">this</span>.middleware);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.listenerCount(<span class=\"string\">'error'</span>)) <span class=\"keyword\">this</span>.on(<span class=\"string\">'error'</span>, <span class=\"keyword\">this</span>.onerror);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleRequest = <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> ctx = <span class=\"keyword\">this</span>.createContext(req, res);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.handleRequest(ctx, fn);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handleRequest;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  handleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = ctx.res;</span><br><span class=\"line\">    res.statusCode = <span class=\"number\">404</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> onerror = <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> handleResponse = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> respond(ctx);</span><br><span class=\"line\">    onFinished(res, onerror);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// egg/lib/application</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> <span class=\"keyword\">extends</span> <span class=\"title\">EggApplication</span> </span>&#123;</span><br><span class=\"line\">\thandleRequest(ctx, fnMiddleware) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.emit(<span class=\"string\">'request'</span>, ctx)</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.handleRequest(ctx, fnMiddleware)</span><br><span class=\"line\">    onFinished(ctx.res, () =&gt; <span class=\"keyword\">this</span>.emit(<span class=\"string\">'response'</span>, ctx))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>In summary, we have know how to boot web app and deal with request in Eggjs.</strong> When we know it, we can easily write some plugins and middlewares to finish the business requirements.</p>"}],"PostAsset":[],"PostCategory":[{"post_id":"cjvgs675h0000el8qk0vovj6x","category_id":"cjvgs676o0002el8qnwa6dl3l","_id":"cjvgs677p0007el8qvfvpw2gs"},{"post_id":"cjvgs676r0003el8qvt1rqw4y","category_id":"cjvgs677n0006el8q87pkahqp","_id":"cjvgs6783000ael8qfl71eiks"},{"post_id":"cjvgs67770004el8qkuogertn","category_id":"cjvgs677n0006el8q87pkahqp","_id":"cjvgs6784000bel8qudfdpexw"},{"post_id":"cjvgs67aq000cel8qw5yh1krc","category_id":"cjvgs676o0002el8qnwa6dl3l","_id":"cjvgs67cx000eel8qwg3ux39r"},{"post_id":"cjvgs67bv000del8q1gxsq7l5","category_id":"cjvgs676o0002el8qnwa6dl3l","_id":"cjvgs67cy000fel8q4qqdbfcj"},{"post_id":"cjvgs67ey000gel8qgdmf8azx","category_id":"cjvgs676o0002el8qnwa6dl3l","_id":"cjvgs67f3000hel8qpgkyrqr4"},{"post_id":"cjw5sp0iy0000sf8qepavc82p","category_id":"cjvgs676o0002el8qnwa6dl3l","_id":"cjw5sp0j80001sf8q7tk3nou1"}],"PostTag":[],"Tag":[]}}