<!DOCTYPE html>
<html class="has-navbar-fixed-top">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>Lighthouse 流程和架构分析 - Miser 胡言</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">
<meta name="baidu-site-verification" content="CXKjj3fklD">

<meta name="description" content="Lighthouse 是一个非常有用的前端性能评测工具，本文主要讲的基础概念，后续将介绍 puppeteer 的使用，如何利用 gather 和 audit 自定义性能监控指标。另外对内置的 gather 和 audit 研究也能极大争强自己对前端的认知，对 Driver 的学习能增加对 DevTools 和 Chrome 的新认知，非常值得深挖">
 
<meta name="keywords" content="Lighthouse,gather,audit,puppeteer,DevTools,评测工具">
   

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

      

    <style type="text/css">
      body {
        font-family: Consolas, Mononoki, "Roboto Sans", "Liberation Mono",
          monospace;
        color: #586e75;
        line-height: 1.6;
        background-color: #fdf6e3;
      }
      .gallery-item .caption {
        text-align: center;
      }
      ul.adv {
        margin-bottom: 60px;
      }
      ul .img {
        text-align: center;
      }
    </style>
  </head>
  <body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    胡言
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/archives">Archives</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
            <a class="navbar-item" title="Twitter" href="https://twitter.com/ud_miser">
                
                <i class="fab fa-twitter"></i>
                
            </a>
               
            <a class="navbar-item" title="GitHub" href="https://github.com/miser">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>
 <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Lighthouse 流程和架构分析
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-07-07T13:56:46.000Z" itemprop="datePublished">Jul 7 2020</time>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>随着公司业务的不断扩展 ，系统也变得越来越臃肿，需要被不断的拆分，引进诸如微前端这样的框架，开发人员也不断的扩充，甚至有不同办公地点的同事协作开发。除了基本的开发规范外，也需要有一套完善的监控来测试和记录每次代码提交是否比之前版本存在性能不足等问题，在 CI 阶段发现问题，提早解决避免上线后带来性能损失而流失用户。团队成员也能在工作中不断的成长、驱动、交付出优质的应用。</p>
<h3 id="前端经常要关注的几个指标："><a href="#前端经常要关注的几个指标：" class="headerlink" title="前端经常要关注的几个指标："></a>前端经常要关注的几个指标：</h3><p><strong>First Contentful Paint：</strong>浏览器首次绘制文本、图片（包含背景图）、非白色的 canvas 或 SVG 的时间节点。<em>反映了网络的可用性和页面资源是否庞大导致传输时间过长。</em></p>
<p><strong>First Meaningful Paint：</strong>页面的“主要内容”开始出现在屏幕上的时间点，测量用户加载体验的主要指标。<em>反映了是否太多非重要资源加载或执行的优先级高于主要的呈现资源。</em></p>
<p><strong>First CPU Idle：</strong>页面主线程首次可以触发 input 操作，通常叫做最小可交互时间。</p>
<p><strong>Time to Interactive：</strong>页面完全达到可交互状态的时间点。</p>
<p><br></p>
<h2 id="Lighthouse-介绍"><a href="#Lighthouse-介绍" class="headerlink" title="Lighthouse 介绍"></a>Lighthouse 介绍</h2><blockquote>
<p>是一个开源的自动化工具，用于改进网络应用的质量。 您可以将其作为一个 Chrome 扩展程序运行，或从命令行运行。 您为 Lighthouse 提供一个您要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。</p>
</blockquote>
<p><img src="/images/lighthouse/report.png" alt="Lighthouse 报告"></p>
<a id="more"></a>
<p><br></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p><img src="/images/lighthouse/architecture.png" alt="Lighthouse 架构图"></p>
<p><strong>Driver：</strong> 和 Chrome 交互的对象</p>
<p><strong>Gatherers：</strong> 收集网页的一些基础信息，用于后续的 Audit</p>
<p><strong>Artifacts：</strong> 一系列 Gatherers 的信息集合</p>
<p><strong>Audit：</strong> 测试单个功能/优化/指标。用 Artifacts 作为输入，计算出该项指标的得分，生成<em>Lighthouse 标准的数据对象</em></p>
<p><strong>Report：</strong> 根据 Lighthouse 标准的数据对象生成可视化页面</p>
<p><strong>Lighthouse 通过 Driver 模块用 DevTools Protocol 与 Chrome 通信，按照需求对其进行操作，在 Gatherers 模块收集一些信息（artifacts）,在 Audits 模块中进行计算，得到最终打分结果，生成 LHR 根式的报告，渲染成 HTML 文件。</strong></p>
<h3 id="Lighthouse-CI"><a href="#Lighthouse-CI" class="headerlink" title="Lighthouse CI"></a>Lighthouse CI</h3><p>官方示例</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span></span><br><span class="line"><span class="hljs-attr">on:</span> <span class="hljs-string">[push]</span></span><br><span class="line"><span class="hljs-attr">jobs:</span></span><br><span class="line"><span class="hljs-attr">  lighthouseci:</span></span><br><span class="line"><span class="hljs-attr">    runs-on:</span> <span class="hljs-string">ubuntu-latest</span></span><br><span class="line"><span class="hljs-attr">    steps:</span></span><br><span class="line"><span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/checkout@v2</span></span><br><span class="line"><span class="hljs-attr">      - uses:</span> <span class="hljs-string">actions/setup-node@v1</span></span><br><span class="line"><span class="hljs-attr">      - run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-bullet">-g</span> <span class="hljs-string">@lhci/cli@0.4.x</span></span><br><span class="line"><span class="hljs-attr">      - run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span></span><br><span class="line"><span class="hljs-attr">      - run:</span> <span class="hljs-string">lhci</span> <span class="hljs-string">autorun</span> <span class="hljs-bullet">--upload.target=temporary-public-storage</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>npm run build：</strong> 将静态资源打包，一般打包后的资源会存放在 dist 目录里</p>
</li>
<li><p><strong>lhci autorun：</strong> 常用命令，如其字面意思，自动完成整个测试流程，在它里面包含了<code>healthcheck</code>、<code>collect</code>、<code>assert</code>、<code>upload</code>命令</p>
</li>
</ul>
<h3 id="collect-命令源码分析"><a href="#collect-命令源码分析" class="headerlink" title="collect 命令源码分析"></a>collect 命令源码分析</h3><blockquote>
<p><em>@lhci/cli 版本 0.4.x</em></p>
</blockquote>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// autorun</span></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runCommand</span>(<span class="hljs-params">options</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 执行 healthcheck</span></span><br><span class="line">  <span class="hljs-keyword">const</span> healthcheckStatus = runChildCommand(<span class="hljs-string">"healthcheck"</span>, [</span><br><span class="line">    ...defaultFlags,</span><br><span class="line">    <span class="hljs-string">"--fatal"</span>,</span><br><span class="line">  ]).status;</span><br><span class="line">  <span class="hljs-comment">// 执行 collect，重点命令</span></span><br><span class="line">  <span class="hljs-keyword">const</span> collectStatus = runChildCommand(<span class="hljs-string">"collect"</span>, [</span><br><span class="line">    ...defaultFlags,</span><br><span class="line">    ...collectArgs,</span><br><span class="line">  ]).status;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 默认不执行 assert 命令， 需要 assert 参数 并且 没有 upload 参数</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (</span><br><span class="line">    ciConfiguration.assert ||</span><br><span class="line">    (!ciConfiguration.assert &amp;&amp; !ciConfiguration.upload)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> assertStatus = runChildCommand(<span class="hljs-string">"assert"</span>, [</span><br><span class="line">      ...defaultFlags,</span><br><span class="line">      ...assertArgs,</span><br><span class="line">    ]).status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 默认不执行 upload 命令， 例子中有 upload 参数 会执行它</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (ciConfiguration.upload) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> uploadStatus = runChildCommand(<span class="hljs-string">"upload"</span>, defaultFlags).status;</span><br><span class="line">    <span class="hljs-keyword">if</span> (options.failOnUploadFailure &amp;&amp; uploadStatus !== <span class="hljs-number">0</span>)</span><br><span class="line">      process.exit(uploadStatus);</span><br><span class="line">    <span class="hljs-keyword">if</span> (uploadStatus !== <span class="hljs-number">0</span>)</span><br><span class="line">      process.stderr.write(<span class="hljs-string">`WARNING: upload command failed.\n`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码中可以很直观看到 <code>autorun</code> 里面包含的命令</p>
<ul>
<li>healthcheck 一些检查，比如是否安装了 Chrome、客户端版本和服务端版本是否一致等等</li>
<li>collect 重要命令，它的整个流程基本涵盖了架构图，从信息的采集到生成报告</li>
<li>assert 性能分析是否通过，会有相关的提示</li>
<li>upload 上传报告到指定的服务器，上面例子的上传目标是 <code>temporary-public-storage</code>，一个 google 提供的临时公共服务器</li>
</ul>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runCommand</span>(<span class="hljs-params">options</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!options.additive) clearSavedReportsAndLHRs();</span><br><span class="line"></span><br><span class="line">  checkIgnoredChromeFlagsOption(options);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> puppeteer = <span class="hljs-keyword">new</span> PuppeteerManager(options);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 检查是否有 staticDistDir 参数（默认是dist、build或public，也可以通过--static-dist-dir指定）</span></span><br><span class="line">  <span class="hljs-comment">// staticDistDir是打包后的静态资源目录</span></span><br><span class="line">  <span class="hljs-comment">// 有 =&gt; 创建 express server， 将静态资源加载进服务中（一般都是有的，除非手动关闭）</span></span><br><span class="line">  <span class="hljs-comment">// 没 =&gt; 执行 startServerCommand，开发者自己创建一个服务</span></span><br><span class="line">  <span class="hljs-comment">// 没有服务支持，浏览器无法打开页面进行测试</span></span><br><span class="line">  <span class="hljs-keyword">const</span> &#123; urls, close &#125; = <span class="hljs-keyword">await</span> startServerAndDetermineUrls(options);</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> url <span class="hljs-keyword">of</span> urls) &#123;</span><br><span class="line">    <span class="hljs-comment">// 如果有 puppeteerScript 参数，那么会出触发该脚本</span></span><br><span class="line">    <span class="hljs-keyword">await</span> puppeteer.invokePuppeteerScriptForUrl(url);</span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-keyword">await</span> runOnUrl(url, options, &#123; puppeteer &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runOnUrl</span>(<span class="hljs-params">url, options, context</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> runner = getRunner(options); <span class="hljs-comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 默认执行3次</span></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; options.numberOfRuns; i++) &#123;</span><br><span class="line">    <span class="hljs-comment">// 每次新开一个Node.js进程 调用 lighthouse-cli</span></span><br><span class="line">    <span class="hljs-keyword">const</span> lhr = <span class="hljs-keyword">await</span> runner.runUntilSuccess(url, &#123;</span><br><span class="line">      ...options,</span><br><span class="line">      settings,</span><br><span class="line">    &#125;);</span><br><span class="line">    saveLHR(lhr); <span class="hljs-comment">// 保存 lighthouse result 数据</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/puppeteer/puppeteer" target="_blank" rel="noopener">puppeteer</a>：一个通过 DevTools Protocol 操控 Headless Chrome 的 Node.js 类库</li>
<li>numberOfRuns 默认是 3，会分别开启 3 个 Node.js 进程各走一次流程，最后在 .lighthouseci 目录下生成 3 对 lhr-xxx.json 和 lhr-xxx.html 文件（前者是分析结果，后者是渲染的网页），及一个 assertion-results.json 文件</li>
<li>runUntilSuccess 开始执行 lighthouse-cli 里的逻辑</li>
</ul>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lighthouse-cli 部分代码</span></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runLighthouse</span>(<span class="hljs-params">url, flags, config</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> launchedChrome;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 通过 chrome-launcher 启动一个 headless Chrome</span></span><br><span class="line">  launchedChrome = <span class="hljs-keyword">await</span> getDebuggableChrome(flags);</span><br><span class="line">  flags.port = launchedChrome.port; <span class="hljs-comment">// 需要知道该Chrome端口号，为了之后的 websocket 通信</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// lighthouse-core/index.js</span></span><br><span class="line">  <span class="hljs-keyword">const</span> runnerResult = <span class="hljs-keyword">await</span> lighthouse(url, flags, config);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (runnerResult) &#123;</span><br><span class="line">    <span class="hljs-keyword">await</span> saveResults(runnerResult, flags);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> runnerResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 lighthouse-cli 中主要就是启动一个 headless Chrome（无界面的 Chrome）,后续交由 lighthouse-core 核心模块完成。</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lighthouse-core/index.js</span></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lighthouse</span>(<span class="hljs-params">url, flags = &#123;&#125;, configJSON, connection</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 将自定义配置和默认配置做合并</span></span><br><span class="line">  <span class="hljs-comment">// 根据配置信息创建大量继承Gatherer的对象，有3个方法beforePass、pass、afterPass</span></span><br><span class="line">  <span class="hljs-keyword">const</span> config = generateConfig(configJSON, flags);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ChromeProtocol 封装了和 Chrome 通信的 websocket</span></span><br><span class="line">  <span class="hljs-keyword">const</span> connection =</span><br><span class="line">    connection || <span class="hljs-keyword">new</span> ChromeProtocol(flags.port, flags.hostname);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 收集 Gather 和计算 Audit 的核心方法</span></span><br><span class="line">  <span class="hljs-keyword">return</span> Runner.run(connection, &#123; url, config &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">connection, runOpts</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 从浏览器中获取所有的 artifacts</span></span><br><span class="line">  artifacts = <span class="hljs-keyword">await</span> Runner._gatherArtifactsFromBrowser(</span><br><span class="line">    requestedUrl,</span><br><span class="line">    runOpts,</span><br><span class="line">    connection</span><br><span class="line">  );</span><br><span class="line">  <span class="hljs-comment">// 根据获取的artifacts，计算需要的 audits，得出结果</span></span><br><span class="line">  <span class="hljs-keyword">const</span> auditResults = <span class="hljs-keyword">await</span> Runner._runAudits(</span><br><span class="line">    settings,</span><br><span class="line">    runOpts.config.audits,</span><br><span class="line">    artifacts,</span><br><span class="line">    lighthouseRunWarnings</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> lhr = &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 按照 lhr 格式生成报告</span></span><br><span class="line">  lhr.i18n.icuMessagePaths = i18n.replaceIcuMessageInstanceIds(</span><br><span class="line">    lhr,</span><br><span class="line">    settings.locale</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> report = generateReport(lhr, settings.output);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> &#123; lhr, artifacts, report &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_gatherArtifactsFromBrowser</span>(<span class="hljs-params"></span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  requestedUrl,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  runnerOpts,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  connection</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> driver = runnerOpts.driverMock || <span class="hljs-keyword">new</span> Driver(connection);</span><br><span class="line">  <span class="hljs-keyword">const</span> gatherOpts = &#123;</span><br><span class="line">    driver,</span><br><span class="line">    requestedUrl,</span><br><span class="line">    settings: runnerOpts.config.settings,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="hljs-comment">// 收集 Gather，生成结果集合 artifacts</span></span><br><span class="line">  <span class="hljs-keyword">const</span> artifacts = <span class="hljs-keyword">await</span> GatherRunner.run(</span><br><span class="line">    runnerOpts.config.passes,</span><br><span class="line">    gatherOpts</span><br><span class="line">  );</span><br><span class="line">  <span class="hljs-keyword">return</span> artifacts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的逻辑非常清晰，就是根据现有数据（artifacts），计算出结果数据（audits），生成报告。</p>
<h4 id="如何得到-artifacts-这些信息的呢？"><a href="#如何得到-artifacts-这些信息的呢？" class="headerlink" title="如何得到 artifacts 这些信息的呢？"></a>如何得到 artifacts 这些信息的呢？</h4><figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// gather-runner.js</span></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">passConfigs, options</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> artifacts = &#123;&#125;;</span><br><span class="line">  <span class="hljs-keyword">const</span> driver = options.driver;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 和 Chrome 进行连接</span></span><br><span class="line">  <span class="hljs-keyword">await</span> driver.connect();</span><br><span class="line">  <span class="hljs-comment">// 加载个 about:blank 空白页面</span></span><br><span class="line">  <span class="hljs-keyword">await</span> GatherRunner.loadBlank(driver);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 创建 artifacts</span></span><br><span class="line">  <span class="hljs-comment">// 一些基础信息，比如userAgent、移动还是桌面emulate</span></span><br><span class="line">  <span class="hljs-keyword">const</span> baseArtifacts = <span class="hljs-keyword">await</span> GatherRunner.initializeBaseArtifacts(options);</span><br><span class="line">  <span class="hljs-comment">// 通过一定数量的字符串拼接计算出待测试驱动的性能</span></span><br><span class="line">  baseArtifacts.BenchmarkIndex = <span class="hljs-keyword">await</span> options.driver.getBenchmarkIndex();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 将环境配置好</span></span><br><span class="line">  <span class="hljs-keyword">await</span> GatherRunner.setupDriver(driver, options);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// passConfigs 就是 需要收集的Gather集合</span></span><br><span class="line">  <span class="hljs-comment">// runPass是一个很长的周期，真正开始做数据分析的方法</span></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> passConfig <span class="hljs-keyword">of</span> passConfigs) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> passContext = &#123;</span><br><span class="line">      driver,</span><br><span class="line">      url: options.requestedUrl,</span><br><span class="line">      settings: options.settings,</span><br><span class="line">      passConfig,</span><br><span class="line">      baseArtifacts,</span><br><span class="line">      LighthouseRunWarnings: baseArtifacts.LighthouseRunWarnings,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="hljs-comment">// loadBlank =&gt; setupPassNetwork =&gt; cleanBrowserCaches</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; beforePass // gather 对象对外暴露的接口</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; beginRecording</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; loadPage</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; pass // gather 对象对外暴露的接口</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; endRecording</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; afterPass // gather 对象对外暴露的接口</span></span><br><span class="line">    <span class="hljs-comment">// =&gt; collectArtifacts</span></span><br><span class="line">    <span class="hljs-keyword">const</span> passResults = <span class="hljs-keyword">await</span> GatherRunner.runPass(passContext);</span><br><span class="line">    <span class="hljs-comment">// 将所有结果挂在 artifacts 对象上</span></span><br><span class="line">    <span class="hljs-built_in">Object</span>.assign(artifacts, passResults.artifacts);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> &#123; ...baseArtifacts, ...artifacts &#125;; <span class="hljs-comment">// Cast to drop Partial&lt;&gt;.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// Gatherer 基类</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gatherer</span> </span>&#123;</span><br><span class="line">  get name() &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.constructor.name;</span><br><span class="line">  &#125;</span><br><span class="line">  beforePass(passContext) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  pass(passContext) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  afterPass(passContext, loadData) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>runPass 是一个重要的生命周期，如果要给 Lighthouse 写自定义的扩展，必须要了解它。其实就是模拟人的行为，打开空网页（loadBlank），设置网络参数（setupPassNetwork），情况缓存（cleanBrowserCaches），beforePass（注入页面加载前注入脚本获取关键信息），beginRecording（页面加载前记录 devtoolsLog 和 trace），pass（页面加载中），endRecording（页面加载结束记录 devtoolsLog 和 trace），afterPass（页面加载结束注入脚本获取关键信息），collectArtifacts（收集相关信息）。其中，beforePass、pass 和 afterPass 在写自定义 gather 时可以注入脚本获取自己需要的信息的，非常有用。最后将收集的信息挂载到 artifacts 上。系统内置的信息收集类都在 lighthouse-core 下的 gather/gatherers 目录里。</p>
<p><img src="/images/lighthouse/gatherers.png" alt="gatherers"></p>
<p>以收集图片信息的 <code>ImageElements</code> 为例，它对外暴露了 afterPass 接口，是一个经典应用</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// image-elements.js</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageElements</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Gatherer</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">async</span> afterPass(passContext, loadData) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> driver = passContext.driver;</span><br><span class="line">    <span class="hljs-keyword">const</span> indexedNetworkRecords = loadData.networkRecords.reduce(</span><br><span class="line">      (map, record) =&gt; &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (</span><br><span class="line">          /^image/.test(record.mimeType) &amp;&amp;</span><br><span class="line">          record.finished &amp;&amp;</span><br><span class="line">          record.statusCode === <span class="hljs-number">200</span></span><br><span class="line">        ) &#123;</span><br><span class="line">          map[record.url] = record;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> map;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> expression = <span class="hljs-string">`(function() &#123;</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">$&#123;pageFunctions.getElementsInDocumentString&#125;</span>; // define function on page</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">$&#123;getClientRect.toString()&#125;</span>;</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">$&#123;getHTMLImages.toString()&#125;</span>;</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">$&#123;getCSSImages.toString()&#125;</span>;</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">$&#123;collectImageElementInfo.toString()&#125;</span>;</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">      return collectImageElementInfo();</span></span><br><span class="line"><span class="hljs-string">    &#125;)()`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> elements = <span class="hljs-keyword">await</span> driver.evaluateAsync(expression);</span><br><span class="line">    <span class="hljs-keyword">const</span> top50Images = <span class="hljs-built_in">Object</span>.values(indexedNetworkRecords)</span><br><span class="line">      .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.resourceSize - a.resourceSize)</span><br><span class="line">      .slice(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> imageUsage = [];</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> element <span class="hljs-keyword">of</span> elements) &#123;</span><br><span class="line">      <span class="hljs-comment">// ...</span></span><br><span class="line">      <span class="hljs-comment">// 在Chrome注入并执行 determineNaturalSize 方法，获取图片的原始宽和高</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> imageUsage;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">determineNaturalSize</span>(<span class="hljs-params">url</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> Image();</span><br><span class="line">    img.addEventListener(<span class="hljs-string">"error"</span>, (_) =&gt;</span><br><span class="line">      reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"determineNaturalSize failed img load"</span>))</span><br><span class="line">    );</span><br><span class="line">    img.addEventListener(<span class="hljs-string">"load"</span>, () =&gt; &#123;</span><br><span class="line">      resolve(&#123;</span><br><span class="line">        naturalWidth: img.naturalWidth,</span><br><span class="line">        naturalHeight: img.naturalHeight,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    img.src = url;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有 afterPass 方法是在页面加载完后执行的，所以会比 beforePass 多一个<code>loadData</code>参数，记录了网络加载的数据，比如，图片。</p>
<p>在 ImageElements 中</p>
<ul>
<li>先找出所有正常加载的图片</li>
<li>expression，定义一个闭包，将相关需要用到的方法通过字符串的形式拼接起来，再用 driver.evaluateAsync 将它们注入到 Chrome, 并执行</li>
<li>按照尺寸大小排序，获取最大的前 50 个图片信息</li>
<li>elements 和 top50Images，进行相关的逻辑处理获取图片的原始尺寸，最后返回结果集 imageUsage</li>
</ul>
<p><strong>从上述代码我们可以知道，将 JavaScript 方法通过 <code>driver.evaluateAsync</code> 注入到 Chrome 里并执行，收集页面的信息。</strong></p>
<h4 id="有了信息，该如何计算呢？"><a href="#有了信息，该如何计算呢？" class="headerlink" title="有了信息，该如何计算呢？"></a>有了信息，该如何计算呢？</h4><p>系统内置的计算类都在 lighthouse-core 下的 audits 目录里。整体的流程和 gather 很像，都是遍历配置里的集合，然后触发暴露的方法（此处是 audit）,然后合并输出，大概过程如下。</p>
<p><img src="/images/lighthouse/audits.png" alt="audits"></p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 接上面 lighthouse-core/index.js 里的</span></span><br><span class="line"><span class="hljs-keyword">const</span> auditResults = <span class="hljs-keyword">await</span> Runner._runAudits(</span><br><span class="line">  settings,</span><br><span class="line">  runOpts.config.audits,</span><br><span class="line">  artifacts, <span class="hljs-comment">// 之前收集的信息</span></span><br><span class="line">  lighthouseRunWarnings</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_runAudits</span>(<span class="hljs-params">settings, audits, artifacts, runWarnings</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 迭代配置里生成的audits对象集合</span></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> auditDefn <span class="hljs-keyword">of</span> audits) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> auditResult = <span class="hljs-keyword">await</span> Runner._runAudit(</span><br><span class="line">      auditDefn,</span><br><span class="line">      artifacts,</span><br><span class="line">      sharedAuditContext,</span><br><span class="line">      runWarnings</span><br><span class="line">    );</span><br><span class="line">    auditResults.push(auditResult);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> auditResults;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_runAudit</span>(<span class="hljs-params"></span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  auditDefn,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  artifacts,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  sharedAuditContext,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  runWarnings</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> audit = auditDefn.implementation;</span><br><span class="line">  <span class="hljs-keyword">let</span> auditResult;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> auditOptions = <span class="hljs-built_in">Object</span>.assign(</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">    audit.defaultOptions,</span><br><span class="line">    auditDefn.options</span><br><span class="line">  );</span><br><span class="line">  <span class="hljs-keyword">const</span> auditContext = &#123;</span><br><span class="line">    options: auditOptions,</span><br><span class="line">    ...sharedAuditContext,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="hljs-comment">// 调用 audit 方法</span></span><br><span class="line">  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> audit.audit(narrowedArtifacts, auditContext);</span><br><span class="line"></span><br><span class="line">  auditResult = Audit.generateAuditResult(audit, product);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> auditResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Audit</span> </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// Audit 基类内容比较多，主要对外暴露的是 audit 方法，子类必须重写</span></span><br><span class="line">  <span class="hljs-keyword">static</span> audit(artifacts, context) &#123;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"audit() method must be overriden"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们依旧以图片的为例。</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// /audits/image-size-responsive.js</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageSizeResponsive</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Audit</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">static</span> audit(artifacts) &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> DPR = artifacts.ViewportDimensions.devicePixelRatio;</span><br><span class="line">    <span class="hljs-keyword">const</span> results = <span class="hljs-built_in">Array</span>.from(artifacts.ImageElements) <span class="hljs-comment">// 从 gather ImageElements里收集的信息</span></span><br><span class="line">      .filter(isCandidate) <span class="hljs-comment">// 过滤掉没用的图片</span></span><br><span class="line">      .filter(<span class="hljs-function"><span class="hljs-params">image</span> =&gt;</span> !imageHasRightSize(image, DPR)) <span class="hljs-comment">// 算出图片尺寸是否过大</span></span><br><span class="line">      .filter(</span><br><span class="line">        image =&gt; isVisible(image.clientRect, artifacts.ViewportDimensions) <span class="hljs-comment">// 算出图片是否在可是区域</span></span><br><span class="line">      )</span><br><span class="line">      .map(<span class="hljs-function"><span class="hljs-params">image</span> =&gt;</span> getResult(image, DPR)); <span class="hljs-comment">// 获取图片的相关信息，组成集合</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> headings = [</span><br><span class="line">      <span class="hljs-comment">// ...</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> finalResults = <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// 如果集合中没有含有过大并且在可视区域的图片，那么为true</span></span><br><span class="line">      <span class="hljs-comment">// 之后，所有 audits 中的 score 为 true 将被累加其数量，并按照百分比算出相关得分</span></span><br><span class="line">      score: <span class="hljs-built_in">Number</span>(results.length === <span class="hljs-number">0</span>),</span><br><span class="line">      details: Audit.makeTableDetails(headings, finalResults)</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gather 和 audit 是核心的流程和概念，上文我们已经简单的分析了整个代码，从 2 者的目录结构图也不难发现 audit 数量远远大于 gather，这也是为什么 2 者分开的重要原因，audit 通过 artifacts 去获取自己想要的数据再进行逻辑计算，增加了 gather 数据的复用性，和各自的扩展性，各个模块的测试也变得容易。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Lighthouse 是一个非常有用的前端性能评测工具，本文主要讲的基础概念，后续将介绍 puppeteer 的使用，如何利用 gather 和 audit 自定义性能监控指标。另外对内置的 gather 和 audit 研究也能极大争强自己对前端的认知，对 Driver 的学习能增加对 DevTools 和 Chrome 的新认知，非常值得深挖。</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/JavaScript/">#JavaScript</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/性能监控/">#性能监控</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Web/">#Web</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/08/16/coder-painter/">码农与画家</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/06/29/node-gateway-ssr-multi-version/">Node.js服务支持多SSR版本（适合测试环境）</a>
            
        </span>
    </div>
    
</article>



<div class="comments">
    <ul class="adv">
  <li class="img"><img src="/images/give-a-reward.png" alt="reward"></li>
  <li>
    欢迎加入<a href="https://oriente.com/" target="_blank">Oriente</a>前端组，<a href="https://www.lagou.com/jobs/4927018.html?source=pl&i=pl-3" target="_blank">岗位信息</a>
  </li>
  <li>
    同时也欢迎光顾我的小店<a href="http://aimianwu.com" target="_blank">爱眠物</a>
  </li>
</ul>

    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://mlib.wang/2020/07/07/lighthouse/';
        this.page.identifier = '2020/07/07/lighthouse/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'mblof' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section> <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2020 Miser&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer> <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    


<script src="/js/script.js"></script> 
  </body>
</html>
